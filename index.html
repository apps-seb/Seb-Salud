<!DOCTYPE html>
<html lang="es" class="scroll-smooth" data-theme="bosque">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seb Salud - Plataforma de Gestión</title>

    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Seb Salud">
    
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ... Tu CSS original va aquí, no necesita cambios ... */
        :root {
            --color-primary-400: 165 180 252; --color-primary-500: 129 140 248; --color-primary-600: 79 70 229; --color-primary-700: 67 56 202;
            --auth-gradient-from: rgb(var(--color-primary-600));
            --auth-gradient-to: rgb(56 189 248);
            --sidebar-collapsed-width: 5rem;
            --sidebar-expanded-width: 16rem;
            --sidebar-gap-desktop: 1.5rem;
        }
        [data-theme="bosque"] { --color-primary-400: 163 230 53; --color-primary-500: 132 204 22; --color-primary-600: 6 182 212; --color-primary-700: 8 145 178; --auth-gradient-from: #a3e635; --auth-gradient-to: #06b6d4;}
        [data-theme="atardecer"] { --color-primary-400: 253 224 71; --color-primary-500: 251 146 60; --color-primary-600: 249 115 22; --color-primary-700: 239 68 68; --auth-gradient-from: #fde047; --auth-gradient-to: #ef4444;}
        [data-theme="elegant"] { --color-primary-400: 251 191 36; --color-primary-500: 245 158 11; --color-primary-600: 14 165 233; --color-primary-700: 2 132 199; --auth-gradient-from: #f59e0b; --auth-gradient-to: #0ea5e9;}
        [data-theme="espacial"] { --color-primary-400: 125 211 252; --color-primary-500: 56 189 248; --color-primary-600: 139 92 246; --color-primary-700: 124 58 237; --auth-gradient-from: #38bdf8; --auth-gradient-to: #8b5cf6;}
        [data-theme="verano-tropical"] { --color-primary-400: 190 242 100; --color-primary-500: 163 230 53; --color-primary-600: 219 39 119; --color-primary-700: 190 24 93; --auth-gradient-from: #a3e635; --auth-gradient-to: #ec4899;}
        [data-theme="apple"] { --color-primary-400: 229 231 235; --color-primary-500: 255 255 255; --color-primary-600: 243 244 246; --color-primary-700: 209 213 219; --auth-gradient-from: #374151; --auth-gradient-to: #000000;}
        [data-theme="neon-amarillo"] { --color-primary-400: 234 255 102; --color-primary-500: 227 255 0; --color-primary-600: 204 255 0; --color-primary-700: 170 204 0; --auth-gradient-from: #eaff66; --auth-gradient-to: #aacc00;}
        [data-theme="spotify"] { --color-primary-400: 30 215 96; --color-primary-500: 29 185 84; --color-primary-600: 29 185 84; --color-primary-700: 25 158 71; --auth-gradient-from: rgb(var(--color-primary-500)); --auth-gradient-to: #054120;}

        /* =================== LÍNEA AÑADIDA =================== */
[data-theme="liquid-glass"] { --color-primary-400: 129 203 255; --color-primary-500: 59 167 255; --color-primary-600: 0 131 255; --color-primary-700: 0 108 212; --auth-gradient-from: #0083ff; --auth-gradient-to: #00c8ff; }
/* ================= FIN DE LÍNEA AÑADIDA ============== */

/* =================== LÍNEA AÑADIDA =================== */
[data-theme="aurora"] { --color-primary-400: 103 239 229; --color-primary-500: 34 211 200; --color-primary-600: 20 184 175; --color-primary-700: 15 149 141; --auth-gradient-from: #22d3d0; --auth-gradient-to: #9d4edd; }
/* ================= FIN DE LÍNEA AÑADIDA ============== */

        body { font-family: 'Inter', sans-serif; }
        .bg-primary-600 { background-color: rgb(var(--color-primary-600)); }
        .bg-primary-700 { background-color: rgb(var(--color-primary-700)); }
        .hover\:bg-primary-700:hover { background-color: rgb(var(--color-primary-700)); }
        .text-primary-400 { color: rgb(var(--color-primary-400)); }
        .text-primary-500 { color: rgb(var(--color-primary-500)); }
        .text-primary-600 { color: rgb(var(--color-primary-600)); }
        .hover\:text-primary-600:hover { color: rgb(var(--color-primary-600)); }
        .border-primary-600 { border-color: rgb(var(--color-primary-600)); }
        .ring-primary-600:focus { --tw-ring-color: rgb(var(--color-primary-600)); }
        .sidebar { transition: transform 0.3s ease-in-out, background-color 0.3s, color 0.3s, width 0.3s ease, box-shadow 0.3s ease;
            width: var(--sidebar-expanded-width);
        }
        #sidebar .nav-link i,
        #sidebar .nav-link svg,
        #sidebar #logout-btn i,
        #sidebar #logout-btn svg {
            width: 1.75rem !important;
            height: 1.75rem !important;
            stroke-width: 1.75 !important;
        }
        #sidebar .nav-link i,
        #sidebar .nav-link svg {
            padding: 0.35rem;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.18);
            color: inherit;
        }
        #sidebar {
            background: rgba(15, 23, 42, 0.96);
            backdrop-filter: blur(16px);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .nav-link.active { background-color: rgb(var(--color-primary-600)); color: white; }
        .bottom-nav-link.active { color: rgb(var(--color-primary-400)); }
        .bottom-nav {
            bottom: 1.25rem;
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            width: calc(100% - 2.5rem);
            max-width: 420px;
            padding: 0.75rem 1.5rem;
            border-radius: 1.75rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 24px 45px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(16px);
            background-color: rgba(15, 23, 42, 0.92);
        }
        .bottom-nav-link {
            font-weight: 600;
            transition: color 0.2s ease;
        }
        .bottom-nav-link i,
        .bottom-nav-link svg {
            width: 1.5rem !important;
            height: 1.5rem !important;
            stroke-width: 1.75 !important;
        }
        .bottom-nav-link span {
            font-size: 0.7rem;
            letter-spacing: 0.02em;
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .details-section.hidden, #manual-override-container.hidden { display: none; }
        .details-toggle-icon, .stats-toggle-icon { transition: transform 0.3s; }
        .details-shown .details-toggle-icon, .stats-shown .stats-toggle-icon { transform: rotate(180deg); }
        .novedades-badge { position: absolute; top: 1px; right: 1px; background-color: #ef4444; color: white; font-size: 0.65rem; font-weight: bold; height: 16px; width: 16px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; line-height: 1; pointer-events: none; transition: transform 0.2s; }
        .novedades-badge.hidden { transform: scale(0); }
        .health-plan-card { border: 2px solid #e2e8f0; transition: border-color 0.2s, box-shadow 0.2s; }
        .health-plan-card:has(input:checked) { border-color: rgb(var(--color-primary-600)); box-shadow: 0 0 0 2px rgb(var(--color-primary-600) / 0.5); }
        
        /* --- ESTILOS DEL PANEL LATERAL --- */
        @media (min-width: 768px) {
            #sidebar {
                left: var(--sidebar-gap-desktop);
                width: var(--sidebar-collapsed-width);
                border-radius: 1.5rem;
                box-shadow: 0 30px 50px rgba(15, 23, 42, 0.25);
                margin-left: 0;
            }

            body[data-sidebar-theme="light"] #sidebar {
                background: rgba(255, 255, 255, 0.92);
                border-color: rgba(148, 163, 184, 0.2);
                box-shadow: 0 25px 60px rgba(15, 23, 42, 0.15);
            }

            body[data-sidebar-theme="dark"] #sidebar {
                background: rgba(15, 23, 42, 0.96);
                border-color: rgba(30, 41, 59, 0.55);
            }

            #sidebar:hover,
            #sidebar:focus-within {
                width: var(--sidebar-expanded-width);
            }

            #sidebar .logo-wrapper,
            #sidebar .nav-link {
                justify-content: center;
            }

            #sidebar:hover .logo-wrapper,
            #sidebar:focus-within .logo-wrapper,
            #sidebar:hover .nav-link,
            #sidebar:focus-within .nav-link {
                justify-content: flex-start;
            }

            #sidebar .nav-link i,
            #sidebar .nav-link svg,
            #sidebar #logout-btn i,
            #sidebar #logout-btn svg {
                margin-right: 0;
                transition: margin-right 0.3s ease;
            }

            #sidebar:hover .nav-link i,
            #sidebar:hover .nav-link svg,
            #sidebar:focus-within .nav-link i,
            #sidebar:focus-within .nav-link svg {
                margin-right: 0.75rem;
            }

            #sidebar:hover #logout-btn i,
            #sidebar:hover #logout-btn svg,
            #sidebar:focus-within #logout-btn i,
            #sidebar:focus-within #logout-btn svg {
                margin-right: 0.5rem;
            }

            #sidebar .sidebar-label,
            #sidebar .logo-text {
                opacity: 0;
                transform: translateX(-12px);
                pointer-events: none;
                transition: opacity 0.3s ease, transform 0.3s ease, max-width 0.3s ease;
                max-width: 0;
                overflow: hidden;
                white-space: nowrap;
                display: inline-block;
            }

            #sidebar:hover .sidebar-label,
            #sidebar:focus-within .sidebar-label,
            #sidebar:hover .logo-text,
            #sidebar:focus-within .logo-text {
                opacity: 1;
                transform: translateX(0);
                pointer-events: auto;
                max-width: 220px;
            }

            #sidebar .nav-link .sidebar-label,
            #sidebar #logout-btn .sidebar-label,
            #sidebar .logo-text {
                margin-left: 0;
                transition: margin 0.3s ease;
            }

            #sidebar:hover .nav-link .sidebar-label,
            #sidebar:focus-within .nav-link .sidebar-label,
            #sidebar:hover #logout-btn .sidebar-label,
            #sidebar:focus-within #logout-btn .sidebar-label,
            #sidebar:hover .logo-text,
            #sidebar:focus-within .logo-text {
                margin-left: 0.75rem;
            }

            #sidebar #sidebar-user-info {
                opacity: 0;
                transform: translateX(-12px);
                pointer-events: none;
                transition: opacity 0.3s ease, transform 0.3s ease, padding 0.3s ease, max-height 0.3s ease;
                padding-left: 0;
                padding-right: 0;
                max-height: 0;
                overflow: hidden;
            }

            #sidebar:hover #sidebar-user-info,
            #sidebar:focus-within #sidebar-user-info {
                opacity: 1;
                transform: translateX(0);
                pointer-events: auto;
                padding-left: 1rem;
                padding-right: 1rem;
                max-height: 400px;
            }

            #sidebar #logout-btn {
                justify-content: center;
            }

            #sidebar:hover #logout-btn,
            #sidebar:focus-within #logout-btn {
                justify-content: flex-start;
            }

            .main-content,
            .main-content header {
                transition: margin-left 0.3s ease, left 0.3s ease, width 0.3s ease;
            }

            .main-content {
                margin-left: calc(var(--sidebar-gap-desktop) + var(--sidebar-collapsed-width));
            }

            .main-content header {
                left: calc(var(--sidebar-gap-desktop) + var(--sidebar-collapsed-width));
                width: calc(100% - (var(--sidebar-gap-desktop) + var(--sidebar-collapsed-width)));
            }

            #sidebar:hover ~ .main-content,
            #sidebar:focus-within ~ .main-content {
                margin-left: calc(var(--sidebar-gap-desktop) + var(--sidebar-expanded-width));
            }

            #sidebar:hover ~ .main-content header,
            #sidebar:focus-within ~ .main-content header {
                left: calc(var(--sidebar-gap-desktop) + var(--sidebar-expanded-width));
                width: calc(100% - (var(--sidebar-gap-desktop) + var(--sidebar-expanded-width)));
            }
        }

        [data-sidebar-theme="dark"] #sidebar { background-color: rgba(17, 24, 39, 0.96); color: #e5e7eb; border-color: rgba(55, 65, 81, 0.4); }
        [data-sidebar-theme="dark"] #sidebar .border-b, [data-sidebar-theme="dark"] #sidebar .border-t { border-bottom-color: #374151; border-top-color: #374151; }
        [data-sidebar-theme="dark"] #sidebar .nav-link:hover { background-color: #1f2937; }
        [data-sidebar-theme="dark"] #sidebar #user-email-display { background-color: #374151; }
        [data-sidebar-theme="dark"] #sidebar .text-slate-400 { color: #9ca3af; }
        [data-sidebar-theme="dark"] #sidebar #logout-btn { color: #fca5a5; }
        [data-sidebar-theme="dark"] #sidebar #logout-btn:hover { color: #f87171; }

        [data-sidebar-theme="light"] #sidebar { background-color: rgba(255, 255, 255, 0.92); color: #334155; border: 1px solid rgba(148, 163, 184, 0.25); }
        [data-sidebar-theme="light"] #sidebar .border-b, [data-sidebar-theme="light"] #sidebar .border-t { border-color: rgba(226, 232, 240, 0.65); }
        [data-sidebar-theme="light"] #sidebar .nav-link:hover { background-color: #f1f5f9; }
        [data-sidebar-theme="light"] #sidebar .nav-link.active { background-color: rgb(var(--color-primary-600)); color: white; }
        [data-sidebar-theme="light"] #sidebar .text-slate-200 { color: #334155; }
        [data-sidebar-theme="light"] #sidebar .text-slate-400 { color: #64748b; }
        [data-sidebar-theme="light"] #sidebar #user-email-display { background-color: #e2e8f0; color: #475569; }
        [data-sidebar-theme="light"] #sidebar #logout-btn { color: #e11d48; }
        [data-sidebar-theme="light"] #sidebar #logout-btn:hover { color: #be123c; }

        /* --- ESTILOS DEL MENU INFERIOR --- */
        [data-bottom-nav-theme="dark"] .bottom-nav {
            background: linear-gradient(140deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
            color: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.35);
            box-shadow: 0 26px 55px rgba(15, 23, 42, 0.45);
        }
        [data-bottom-nav-theme="light"] .bottom-nav {
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.95));
            color: #1f2937;
            border-color: rgba(148, 163, 184, 0.45);
            box-shadow: 0 22px 45px rgba(148, 163, 184, 0.35);
        }
        [data-bottom-nav-theme="light"] .bottom-nav .bottom-nav-link { color: #475569; }
        [data-bottom-nav-theme="light"] .bottom-nav .bottom-nav-link.active { color: rgb(var(--color-primary-600)); }
        
        /* --- SOBREESCRITURAS DE TEMAS ESPECÍFICOS --- */
        [data-theme="apple"] body.bg-slate-50 { background-color: #000; color: #fff; }
        [data-theme="apple"] .bg-white, [data-theme="apple"] .bg-white\/80 { background-color: #1C1C1E !important; }
        [data-theme="apple"] .text-slate-900, [data-theme="apple"] .text-slate-800, [data-theme="apple"] .text-slate-700 { color: #f9fafb !important; }
        [data-theme="apple"] .text-slate-600, [data-theme="apple"] .text-slate-500, [data-theme="apple"] .text-slate-400 { color: #9ca3af !important; }
        [data-theme="apple"] .border, [data-theme="apple"] .border-b, [data-theme="apple"] .border-t, [data-theme="apple"] .divide-slate-200 > :not([hidden]) ~ :not([hidden]) { border-color: #374151 !important; }
        [data-theme="apple"] .shadow-lg, [data-theme="apple"] .shadow-md, [data-theme="apple"] .shadow-sm { box-shadow: none; border: 1px solid #374151; }
        [data-theme="apple"] #sidebar { background-color: #000; color: #fff; border-right-color: #374151; }
        [data-theme="apple"] #sidebar .nav-link:hover { background-color: #1f2937; }
        [data-theme="apple"] #sidebar .nav-link.active { background-color: transparent !important; color: white !important; border: 1px solid white; }
        [data-theme="apple"] .bottom-nav { background-color: rgba(0, 0, 0, 0.92) !important; color: #fff !important; border-color: rgba(148, 163, 184, 0.35) !important; box-shadow: 0 28px 55px rgba(0, 0, 0, 0.55) !important; }
        [data-theme="apple"] input, [data-theme="apple"] select, [data-theme="apple"] textarea { background-color: #2C2C2E; color: white; border-color: #4b5563; }
        [data-theme="apple"] .bg-slate-50, [data-theme="apple"] .hover\:bg-slate-50:hover { background-color: #1f2937 !important; }
        [data-theme="apple"] ::-webkit-scrollbar-track { background: #111; }
        [data-theme="apple"] ::-webkit-scrollbar-thumb { background: #444; }
        [data-theme="apple"] ::-webkit-scrollbar-thumb:hover { background: #666; }
        [data-theme="apple"] .shimmer-button::after { background-image: linear-gradient( to right, transparent, rgba(255, 255, 255, 0.6), transparent ); }
        [data-theme="apple"] .chat-bubble.bot-message { background-color: #2C2C2E; color: #FFF; }

        [data-theme="spotify"] body.bg-slate-50 { background-color: #121212; color: #FFFFFF; }
        [data-theme="spotify"] .bg-white, [data-theme="spotify"] .bg-white\/80 { background-color: #181818 !important; }
        [data-theme="spotify"] header { background-color: #181818/80 !important; border-bottom-color: #282828 !important; }
        [data-theme="spotify"] .text-slate-900, [data-theme="spotify"] .text-slate-800, [data-theme="spotify"] .text-slate-700 { color: #f9fafb !important; }
        [data-theme="spotify"] .text-slate-600, [data-theme="spotify"] .text-slate-500, [data-theme="spotify"] .text-slate-400 { color: #b3b3b3 !important; }
        [data-theme="spotify"] .border, [data-theme="spotify"] .border-b, [data-theme="spotify"] .border-t, [data-theme="spotify"] .divide-slate-200 > :not([hidden]) ~ :not([hidden]) { border-color: #282828 !important; }
        [data-theme="spotify"] .shadow-lg, [data-theme="spotify"] .shadow-md, [data-theme="spotify"] .shadow-sm { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4), 0 2px 4px -2px rgba(0,0,0,0.4); }
        [data-theme="spotify"] [data-sidebar-theme="dark"] #sidebar { background-color: #040404; border-right-color: #282828; }
        [data-theme="spotify"] [data-sidebar-theme="dark"] #sidebar .nav-link:hover { background-color: #181818; }
        [data-theme="spotify"] [data-bottom-nav-theme="dark"] .bottom-nav { background: linear-gradient(140deg, rgba(4, 4, 4, 0.96), rgba(18, 18, 18, 0.92)) !important; border-color: rgba(46, 46, 46, 0.65) !important; box-shadow: 0 28px 55px rgba(0, 0, 0, 0.55) !important; }
        [data-theme="spotify"] input, [data-theme="spotify"] select, [data-theme="spotify"] textarea { background-color: #282828; color: white; border-color: #404040; }
        [data-theme="spotify"] .bg-slate-50, [data-theme="spotify"] .hover\:bg-slate-50:hover, [data-theme="spotify"] .bg-gray-50\/50 { background-color: #181818 !important; }
        [data-theme="spotify"] .bg-slate-800 { background-color: #282828; }
        [data-theme="spotify"] .chat-bubble.bot-message { background-color: #282828; color: #FFF; }
        [data-theme="spotify"] .suggestion-chip { border-color: #404040; color: #b3b3b3; }
        [data-theme="spotify"] .suggestion-chip:hover { background-color: #282828; }
        [data-theme="spotify"] ::-webkit-scrollbar-track { background: #181818; }
        [data-theme="spotify"] ::-webkit-scrollbar-thumb { background: #535353; }
        [data-theme="spotify"] ::-webkit-scrollbar-thumb:hover { background: #b3b3b3; }
        [data-theme="spotify"] .bg-slate-100 {
    background-color: #282828;
    color: white;
}
[data-theme="spotify"] #header-search-results {
    background-color: #282828 !important;
    border-color: #404040 !important;
}
[data-theme="spotify"] .search-result-item:hover {
    background-color: #3a3a3a !important;
}
        [data-theme="spotify"] .health-plan-card { border-color: #404040; }

/* ========================================================= */
/* ===         ESTILOS PARA EL TEMA LIQUID GLASS         === */
/* ========================================================= */

/* 1. Keyframes para el fondo animado */
@keyframes animated-gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* 2. Estilo del cuerpo y fondo */
html[data-theme="liquid-glass"] body.bg-slate-50 {
    color: #ffffff;
    background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #0083ff, #00c8ff);
    background-size: 400% 400%;
    animation: animated-gradient 25s ease infinite;
    transition: background 0.5s ease-in-out;
}

/* 3. Estilo principal para los elementos "de cristal" - CON ESPECIFICIDAD AUMENTADA */
html[data-theme="liquid-glass"] .bg-white,
html[data-theme="liquid-glass"] .bg-white\/80,
html[data-theme="liquid-glass"] .modal-content,
html[data-theme="liquid-glass"] header,
html[data-theme="liquid-glass"] #sidebar,
html[data-theme="liquid-glass"] .bottom-nav,
html[data-theme="liquid-glass"] button,
html[data-theme="liquid-glass"] input,
html[data-theme="liquid-glass"] select,
html[data-theme="liquid-glass"] textarea,
html[data-theme="liquid-glass"] .bg-slate-50,
html[data-theme="liquid-glass"] .bg-slate-100,
html[data-theme="liquid-glass"] #header-search-results {
    background-color: rgba(30, 30, 45, 0.5) !important;
    backdrop-filter: blur(12px) !important;
    -webkit-backdrop-filter: blur(12px) !important; /* Para Safari */
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2) !important;
}

/* 4. Estilos para texto y colores */
html[data-theme="liquid-glass"] .text-slate-900,
html[data-theme="liquid-glass"] .text-slate-800,
html[data-theme="liquid-glass"] .text-slate-700 {
    color: #f8fafc !important;
}
html[data-theme="liquid-glass"] .text-slate-600,
html[data-theme="liquid-glass"] .text-slate-500,
html[data-theme="liquid-glass"] .text-slate-400 {
    color: #cbd5e1 !important;
}

/* 5. Ajustes específicos para componentes */

/* Botones y Elementos Interactivos */
html[data-theme="liquid-glass"] button:hover,
html[data-theme="liquid-glass"] .hover\:bg-slate-50:hover,
html[data-theme="liquid-glass"] .search-result-item:hover {
    background-color: rgba(50, 50, 70, 0.7) !important;
    transition: background-color 0.2s;
}
html[data-theme="liquid-glass"] .bg-primary-600 {
    background-color: rgb(var(--color-primary-600)) !important;
    backdrop-filter: none !important; /* Quitar filtro a botones primarios para que destaquen */
}

/* Inputs y Selects */
html[data-theme="liquid-glass"] input::placeholder,
html[data-theme="liquid-glass"] textarea::placeholder {
    color: #94a3b8 !important;
}

/* Enlaces de Navegación */
html[data-theme="liquid-glass"] #sidebar .nav-link.active,
html[data-theme="liquid-glass"] [data-sidebar-theme="light"] #sidebar .nav-link.active {
     background-color: rgba(0, 131, 255, 0.5) !important;
     color: white !important;
}
html[data-theme="liquid-glass"] .bottom-nav .bottom-nav-link.active,
html[data-theme="liquid-glass"] [data-bottom-nav-theme="light"] .bottom-nav .bottom-nav-link.active {
    color: rgb(var(--color-primary-400)) !important;
    background-color: transparent !important;
}

/* Bordes y Divisores */
html[data-theme="liquid-glass"] .border,
html[data-theme="liquid-glass"] .border-b,
html[data-theme="liquid-glass"] .border-t,
html[data-theme="liquid-glass"] .divide-slate-200 > :not([hidden]) ~ :not([hidden]) {
    border-color: rgba(255, 255, 255, 0.15) !important;
}

/* Scrollbar */
html[data-theme="liquid-glass"] ::-webkit-scrollbar-track { background: transparent; }
html[data-theme="liquid-glass"] ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); }
html[data-theme="liquid-glass"] ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }


/* --- FIN ESTILOS LIQUID GLASS --- */

/* ========================================================= */
/* ===      ESTILOS PARA EL TEMA AURORA BOREAL (AÑADIDO) === */
/* ========================================================= */

@keyframes aurora-glow {
    0% { transform: translate(-50%, -50%) rotate(0deg) scale(1.2); opacity: 0.4; }
    50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.5); opacity: 0.7; }
    100% { transform: translate(-50%, -50%) rotate(360deg) scale(1.2); opacity: 0.4; }
}

@keyframes aurora-move {
    0% { transform: translate(10%, -10%) rotate(0deg); }
    25% { transform: translate(-20%, 20%) rotate(90deg); }
    50% { transform: translate(15%, -25%) rotate(180deg); }
    75% { transform: translate(-10%, 15%) rotate(270deg); }
    100% { transform: translate(10%, -10%) rotate(360deg); }
}

html[data-theme="aurora"] body.bg-slate-50 {
    background-color: #03040B;
    color: #f0f0f5;
    overflow: hidden; /* Evita que las auroras generen scrollbars */
    position: relative;
}

/* Creamos las luces de la aurora con pseudo-elementos */
html[data-theme="aurora"] body.bg-slate-50::before,
html[data-theme="aurora"] body.bg-slate-50::after {
    content: '';
    position: fixed; /* Usamos fixed para que se queden detrás incluso con scroll */
    left: 50%;
    top: 50%;
    width: 150vw;
    height: 150vw;
    max-width: 1200px;
    max-height: 1200px;
    border-radius: 50%;
    filter: blur(100px);
    z-index: -1;
}

html[data-theme="aurora"] body.bg-slate-50::before {
    background-image: radial-gradient(circle, #5e2ab2, #3a228d, #1c1869, #0d1045, #03040b);
    animation: aurora-glow 18s linear infinite;
}

html[data-theme="aurora"] body.bg-slate-50::after {
    background-image: radial-gradient(circle, #00c6a7, #00a498, #008387, #006374, #0b455f);
    animation: aurora-move 24s linear infinite alternate;
}

/* Estilo para los paneles principales */
html[data-theme="aurora"] .bg-white,
html[data-theme="aurora"] .bg-white\/80,
html[data-theme="aurora"] .modal-content,
html[data-theme="aurora"] header,
html[data-theme="aurora"] #sidebar,
html[data-theme="aurora"] .bottom-nav,
html[data-theme="aurora"] input,
html[data-theme="aurora"] select,
html[data-theme="aurora"] textarea,
html[data-theme="aurora"] .bg-slate-50,
html[data-theme="aurora"] .bg-slate-100,
html[data-theme="aurora"] #header-search-results {
    background-color: rgba(10, 10, 20, 0.6) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(4px); /* Un desenfoque más sutil */
    box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
}

/* Textos */
html[data-theme="aurora"] .text-slate-900,
html[data-theme="aurora"] .text-slate-800,
html[data-theme="aurora"] .text-slate-700 { color: #f8fafc !important; }
html[data-theme="aurora"] .text-slate-600,
html[data-theme="aurora"] .text-slate-500,
html[data-theme="aurora"] .text-slate-400 { color: #a0a0b0 !important; }
html[data-theme="aurora"] input::placeholder,
html[data-theme="aurora"] textarea::placeholder { color: #888898 !important; }

/* Botones y el EFECTO DE BORDE ILUMINADO */
html[data-theme="aurora"] button {
    background-color: transparent !important;
    position: relative;
    overflow: hidden;
    transition: color 0.3s ease;
}

html[data-theme="aurora"] button::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: inherit;
    background: conic-gradient(from 180deg at 50% 50%, #00ffc3, #a94cf2, #0084ff, #00ffc3);
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: -1;
}

html[data-theme="aurora"] button:hover::before {
    opacity: 1;
}

html[data-theme="aurora"] button span,
html[data-theme="aurora"] button i {
    z-index: 1;
}

/* Botón Primario */
html[data-theme="aurora"] .bg-primary-600,
html[data-theme="aurora"] .bg-primary-600:hover {
    background: linear-gradient(90deg, #22d3d0, #5e2ab2) !important;
    border: none !important;
    color: white !important;
}
html[data-theme="aurora"] .bg-primary-600::before {
    display: none; /* Desactivamos el efecto de borde para el primario */
}

/* Bordes y Divisores */
html[data-theme="aurora"] .border,
html[data-theme="aurora"] .border-b,
html[data-theme="aurora"] .border-t,
html[data-theme="aurora"] .divide-slate-200 > :not([hidden]) ~ :not([hidden]) {
    border-color: rgba(255, 255, 255, 0.1) !important;
}

/* Enlaces de Navegación */
html[data-theme="aurora"] #sidebar .nav-link.active,
html[data-theme="aurora"] [data-sidebar-theme="light"] #sidebar .nav-link.active {
     background-color: rgba(34, 211, 200, 0.2) !important;
     color: #67e8de !important;
     border-color: rgba(34, 211, 200, 0.5) !important;
}

/* --- FIN ESTILOS AURORA BOREAL --- */

        /* ================================================================= */
/* ===   CORRECCIÓN DEFINITIVA PARA CENTRADO Y FONDO DEL PRELOADER === */
/* ================================================================= */
/*
   Esta única regla soluciona el problema de centrado para AMBOS temas.
   Fuerza al loader a ocupar el 100% del viewport (pantalla), dándole
   a Flexbox un contenedor estable para centrar el contenido,
   sin importar los estilos complejos que tenga el <body>.

   Al no modificar 'background-color' ni 'backdrop-filter' aquí,
   permitimos que el preloader herede y conserve correctamente el
   fondo de cristal o de aurora definido en cada tema.
*/
html[data-theme="liquid-glass"] #loader,
html[data-theme="aurora"] #loader {
    width: 100vw;
    height: 100vh;
}

/* --- FIN DE LA CORRECCIÓN DEL PRELOADER --- */
        
        /* --- NUEVAS ANIMACIONES Y ESTILOS --- */
    
/* ============================================================== */
/* === CÓDIGO CSS MODIFICADO PARA DESORDEN Y EXPANSIÓN DINÁMICA === */
/* ============================================================== */

.loader-container {
    height: 60px;
}

.loader-circle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    animation: chaotic-expand-and-rotate 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) 1 forwards;
    opacity: 0;
}

/* Keyframes para la animación de desorden, expansión y rotación */
@keyframes chaotic-expand-and-rotate {
    0% {
        opacity: 0;
        transform: translate(0px, 20px) scale(0.3) rotate(0deg);
    }
    20% { /* Momento de mayor desorden y tamaño */
        opacity: 0.8;
        /* Estos valores serán sobrescritos por cada círculo para el desorden */
        transform: translate(var(--chaos-x), var(--chaos-y)) scale(1.5) rotate(720deg);
    }
    80% { /* Volviendo a la línea original, pero ligeramente más grande */
        opacity: 1;
        transform: translate(0px, 0px) scale(1.1) rotate(720deg);
    }
    100% { /* Posición final */
        opacity: 1;
        transform: translate(0px, 0px) scale(1) rotate(720deg);
    }
}

/* --- Paleta de 5 colores fijos para cada círculo --- */
/* y ahora añadimos variables CSS para el desorden de cada círculo */
.loader-circle:nth-child(1) {
    background-color: #1DB954; /* Verde Spotify */
    animation-delay: 0.0s;
    --chaos-x: -15px; /* Movimiento horizontal para el desorden */
    --chaos-y: 10px;  /* Movimiento vertical para el desorden */
}
.loader-circle:nth-child(2) {
    background-color: #38BDF8; /* Azul Espacial */
    animation-delay: 0.1s;
    --chaos-x: 10px;
    --chaos-y: -10px;
}
.loader-circle:nth-child(3) {
    background-color: #FBBF24; /* Amarillo Elegant */
    animation-delay: 0.2s;
    --chaos-x: -5px;
    --chaos-y: 15px;
}
.loader-circle:nth-child(4) {
    background-color: #8B5CF6; /* Morado Espacial */
    animation-delay: 0.3s;
    --chaos-x: 15px;
    --chaos-y: -5px;
}
.loader-circle:nth-child(5) {
    background-color: #DB2777; /* Fucsia Verano Tropical */
    animation-delay: 0.4s;
    --chaos-x: -10px;
    --chaos-y: -15px;
}
        
        .auth-banner {
            animation: fadeInBanner 0.5s ease-out;
            background-image: linear-gradient(to bottom right, var(--auth-gradient-from), var(--auth-gradient-to));
        }
        @keyframes fadeInBanner { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .auth-form { animation: fadeInForm 0.6s ease-in-out 0.1s; animation-fill-mode: backwards; }
        @keyframes fadeInForm { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo para el efecto espejo/shimmer del botón */
        .shimmer-button { position: relative; overflow: hidden; }
        .shimmer-button::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background-image: linear-gradient( to right, transparent, rgba(255, 255, 255, 0.4), transparent ); transform: skewX(-25deg); animation: shimmer-effect 3.5s infinite linear; }
        @keyframes shimmer-effect { from { left: -150%; } to { left: 150%; } }
        /* --- CORRECCIÓN GLOBAL PARA BOTONES CON ÍCONOS --- */
/* Esta regla asegura que los clics en los íconos SVG se registren 
   en el botón contenedor, solucionando el problema del "un solo clic". */
button svg {
    pointer-events: none;
}

/* ========================================================= */
/* ===      ESTILO PARA ETIQUETA DE TEMA PREMIUM         === */
/* ========================================================= */
.premium-theme-tag {
    position: absolute;
    top: -1px;
    right: -1px;
    background-image: linear-gradient(to right, #f7971e, #ffd200);
    color: #4a2f00;
    font-size: 0.65rem; /* 10px */
    font-weight: 800; /* Extra-bold */
    padding: 0.15rem 0.5rem;
    border-bottom-left-radius: 0.75rem; /* 12px */
    border-top-right-radius: 0.5rem; /* 8px, para que coincida con el borde del padre */
    display: flex;
    align-items: center;
    gap: 0.25rem; /* 4px */
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased" data-sidebar-theme="dark" data-bottom-nav-theme="dark">

    <div id="loader" class="fixed inset-0 bg-white z-[101] flex items-center justify-center">
    <div class="flex flex-col items-center">
        <div class="loader-container flex items-center justify-center space-x-3">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
        <p class="mt-8 text-slate-500 text-lg font-medium tracking-wide">Preparando tu espacio...</p>
    </div>
</div>
    <div id="toast" class="fixed top-5 right-5 z-[100] bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-2 transition-all duration-300"><span id="toast-message"></span></div>

    <div id="auth-container" style="display: none;" class="min-h-screen bg-slate-100 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden grid md:grid-cols-2">
            <div class="auth-banner p-6 md:p-8 lg:p-12 text-white flex flex-col justify-center items-center text-center">
                <i data-lucide="shield-check" class="h-16 w-16 md:h-20 md:w-20 text-white/80 mb-6"></i>
                <h2 class="text-2xl md:text-3xl font-bold mb-4">Bienvenido a Seb Salud</h2>
                <p class="text-white/80 max-w-sm">Tu plataforma de gestión de salud todo en uno. Administra afiliados, asesores y finanzas de forma eficiente y segura.</p>
            </div>
            <div class="p-8 lg:p-12 flex flex-col justify-center">
                <div class="w-full max-w-md mx-auto">
                    <div id="login-view" class="auth-form"><h2 class="text-3xl font-bold text-slate-800 mb-2">Iniciar Sesi&#243;n</h2><p class="text-slate-500 mb-8">Ingresa a tu cuenta para continuar.</p><form id="login-form"><div class="space-y-5"><div class="relative"><i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i><input type="email" id="login-email" placeholder="Correo Electr&#243;nico" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent outline-none" required></div><div class="relative"><i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i><input type="password" id="login-password" placeholder="Contrase&#241;a" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent outline-none" required></div></div><div class="mt-8"><button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Ingresar</button></div></form><p class="text-center text-sm text-slate-600 mt-8">&#191;No tienes una cuenta? <button id="show-register" class="font-semibold text-primary-600 hover:underline">Reg&#237;strate aqu&#237;</button></p></div>
                    <div id="register-view" class="auth-form" style="display: none;"><h2 class="text-3xl font-bold text-slate-800 mb-2">Crear Cuenta</h2><p class="text-slate-500 mb-8">&#218;nete a nuestra plataforma.</p><form id="register-form"><div class="space-y-5"><div class="relative"><i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i><input type="email" id="register-email" placeholder="Correo Electr&#243;nico" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent outline-none" required></div><div class="relative"><i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i><input type="password" id="register-password" placeholder="Contrase&#241;a (m&#237;n. 6 caracteres)" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-600 focus:border-transparent outline-none" required></div></div><div class="mt-8"><button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Crear Cuenta</button></div></form><p class="text-center text-sm text-slate-600 mt-8">&#191;Ya tienes una cuenta? <button id="show-login" class="font-semibold text-primary-600 hover:underline">Inicia sesi&#243;n</button></p></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="license-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60]"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto transform scale-95 text-center"><div class="p-6"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100"><i data-lucide="key-round" class="h-6 w-6 text-primary-600"></i></div><h2 class="text-2xl font-bold mt-4">Activar Licencia</h2><p class="text-slate-500 mt-2">Para continuar, por favor ingresa tu c&#243;digo de licencia.</p></div><form id="license-form" class="p-6 pt-0"><div class="space-y-4"><input type="text" id="license-key-input" placeholder="XXXX-XXXX-XXXX-XXXX" class="w-full text-center tracking-widest font-mono px-4 py-2.5 border rounded-lg" required><p id="license-error-message" class="text-red-500 text-sm h-4"></p></div><div class="pt-6 mt-2"><button type="submit" id="activate-license-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg">Activar</button></div></form></div></div>

    <div id="app-container" style="display: none;">
        <div class="flex h-screen overflow-hidden">
            <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none md:hidden"></div>

          <aside id="sidebar" class="sidebar w-64 fixed top-0 bottom-0 left-0 transform -translate-x-full md:translate-x-0 md:top-4 md:bottom-4 z-40 flex flex-col md:rounded-3xl md:shadow-2xl md:overflow-hidden">
        <div class="logo-wrapper flex items-center justify-center gap-3 h-16 border-b flex-shrink-0 px-4">
            <div class="logo-icon-wrapper flex items-center justify-center h-10 w-10 rounded-2xl bg-primary-600/10">
                <img id="sidebar-logo-image" src="" alt="Logo de la empresa" class="logo-image h-full w-full object-cover rounded-2xl hidden">
                <i data-lucide="shield-check" class="h-8 w-8 text-primary-500 logo-icon"></i>
            </div>
            <span id="sidebar-logo-text" class="logo-text sidebar-label text-xl font-bold whitespace-nowrap">Seb Salud</span>
        </div>

        <div class="flex-1 flex flex-col overflow-y-auto pb-16 md:pb-0">
            <nav id="sidebar-nav" class="px-4 py-6 space-y-2">
                <a href="#" data-target="dashboard" class="nav-link active flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="sidebar-label">Dashboard</span></a>
                <a href="#" data-target="empresa" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="building-2" class="w-5 h-5"></i><span class="sidebar-label">Perfil Empresa</span></a>
                <a href="#" data-target="calendario" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="calendar-days" class="w-5 h-5"></i><span class="sidebar-label">Calendario</span></a>
                <a href="#" data-target="flujo-caja" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="wallet" class="w-5 h-5"></i><span class="sidebar-label">Flujo de Caja</span></a>
                <a href="#" data-target="afiliados" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="users" class="w-5 h-5"></i><span class="sidebar-label">Afiliados</span></a>
                <a href="#" data-target="asesores" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="user-circle" class="w-5 h-5"></i><span class="sidebar-label">Asesores</span></a>
                <a href="#" data-target="ranking-vendedores" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="award" class="w-5 h-5"></i><span class="sidebar-label">Ranking Vendedores</span></a>
                <a href="#" data-target="planes" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="shield-plus" class="w-5 h-5"></i><span class="sidebar-label">Planes de Salud</span></a>
                <a href="#" data-target="cotizador" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="calculator" class="w-5 h-5"></i><span class="sidebar-label">Cotizador</span></a>
                <a href="#" data-target="gestion-roles" data-role="admin" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="users-2" class="w-5 h-5"></i><span class="sidebar-label">Gesti&#243;n de Roles</span></a>
                <a href="#" data-target="perfil-afiliado" data-role="afiliado" class="nav-link flex items-center py-2.5 px-4 rounded-lg"><i data-lucide="user" class="w-5 h-5"></i><span class="sidebar-label">Mi Perfil</span></a>
            </nav>

            <div id="sidebar-user-info" class="px-4 py-4 border-t mt-auto flex-shrink-0">
                <p class="sidebar-label text-xs text-slate-400 uppercase tracking-wider">Usuario Conectado</p>
                <p id="user-email-display" class="sidebar-label font-mono rounded p-1 text-xs break-words mt-1"></p>
                <button id="logout-btn" class="w-full mt-3 text-left text-sm flex items-center"><i data-lucide="log-out" class="w-4 h-4"></i><span class="sidebar-label">Cerrar Sesi&#243;n</span></button>
            </div>
        </div>
    </aside>
            <div class="main-content flex-1 flex flex-col relative">
                <header class="app-header fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-md shadow-sm h-16 flex items-center justify-between px-4 z-20 border-b border-slate-200/75">
    
    <div id="header-main-content" class="flex items-center flex-1">
        <div class="flex items-center">
            <h1 id="header-title" class="text-xl font-semibold text-slate-700 hidden md:block">Dashboard</h1>
            <div class="flex items-center md:hidden">
                <i data-lucide="shield-check" class="h-6 w-6 text-primary-500 logo-icon"></i>
                <span class="ml-2 text-lg font-bold">Seb Salud</span>
            </div>
        </div>
    </div>

    <div id="header-search-container" class="relative flex-1 max-w-xl mx-auto hidden md:flex items-center">
        <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i data-lucide="search" class="h-5 w-5 text-slate-400"></i>
            </div>
            <input type="text" id="header-search-input" placeholder="Buscar afiliado..." 
                   class="block w-full bg-slate-100 border border-transparent rounded-lg py-2 pl-10 pr-4 
                          focus:outline-none focus:ring-2 focus:ring-primary-600 focus:bg-white"
                   autocomplete="off">
        </div>
        <button id="close-search-mobile" class="ml-2 p-2 text-slate-500 hover:text-slate-800 md:hidden">
            <i data-lucide="x" class="h-6 w-6"></i>
        </button>
        <div id="header-search-results" 
             class="absolute top-full mt-2 w-full bg-white rounded-lg shadow-2xl border border-slate-200/50 
                    overflow-y-auto max-h-80 z-50 hidden">
            </div>
    </div>

    <div id="header-actions" class="flex items-center gap-2 flex-shrink-0">
        <button id="search-toggle-mobile" class="text-slate-600 focus:outline-none p-2 rounded-full hover:bg-slate-200 md:hidden">
            <i data-lucide="search" class="h-6 w-6 pointer-events-none"></i>
        </button>
        
        <button id="novedades-toggle-btn" class="relative text-slate-600 focus:outline-none p-2 rounded-full hover:bg-slate-200">
            <i data-lucide="bell" class="h-6 w-6 pointer-events-none"></i>
            <span id="novedades-header-badge" class="novedades-badge hidden"></span>
        </button>
        <button id="profile-toggle-btn" class="relative text-slate-600 focus:outline-none p-2 rounded-full hover:bg-slate-200">
            <i data-lucide="user-circle-2" class="h-6 w-6 pointer-events-none"></i>
        </button>
        <button id="menu-toggle" class="text-slate-600 focus:outline-none md:hidden p-2 rounded-full hover:bg-slate-200">
            <i data-lucide="menu" class="h-6 w-6 pointer-events-none"></i>
        </button>
    </div>
</header>

                <div id="profile-modal" class="absolute top-[68px] right-4 z-30 w-64 bg-white rounded-xl shadow-2xl border border-slate-200/50 p-1.5 origin-top-right transition-transform duration-200 ease-out transform scale-95 opacity-0 pointer-events-none">
                    <div class="p-2">
                        <p id="profile-modal-name" class="font-semibold text-slate-800 text-sm truncate" title="email del usuario">email@usuario.com</p>
                        <p id="profile-modal-role" class="text-xs text-slate-500 mb-2">Administrador</p>
                        <span id="profile-modal-license" class="text-xs font-medium px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800">Licencia Activa</span>
                    </div>
                    <div class="border-t border-slate-200/80 my-1"></div>
                    <button id="profile-modal-logout-btn" class="w-full text-left flex items-center gap-2 p-2 text-sm text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i><span>Cerrar Sesi&#243;n</span>
                    </button>
                </div>

                <div id="novedades-modal" class="absolute top-[68px] right-4 z-30 w-96 bg-white rounded-xl shadow-2xl border border-slate-200/50 flex flex-col origin-top-right transition-transform duration-200 ease-out transform scale-95 opacity-0 pointer-events-none">
    <div class="p-4 border-b flex justify-between items-center">
        <h3 class="font-semibold text-slate-800">Notificaciones</h3>
        
        <div class="flex items-center gap-3">
            <button id="clear-all-novedades" class="text-xs font-medium text-slate-500 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed">Borrar todas</button>
            <button id="mark-novedades-read" class="text-xs font-medium text-primary-600 hover:text-primary-700 disabled:opacity-50 disabled:cursor-not-allowed">Marcar todo como leído</button>
        </div>
    </div>
    <div id="novedades-list" class="flex-1 overflow-y-auto max-h-96 p-2 space-y-1">
        </div>
</div>

                <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto pb-24 md:pb-8 mt-16">
                    <section id="dashboard" class="content-section active">
                        <div class="space-y-8">
                            <div class="grid gap-6 xl:grid-cols-[2fr,3fr]">
                                <article class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white shadow-2xl p-8">
                                    <div class="absolute -top-16 -right-10 h-48 w-48 rounded-full bg-primary-500/30 blur-3xl"></div>
                                    <div class="absolute bottom-0 left-0 right-0 h-1/3 bg-gradient-to-t from-black/20 to-transparent"></div>
                                    <div class="relative flex flex-col gap-6">
                                        <div>
                                            <p class="text-xs uppercase tracking-[0.35em] text-white/50">Panel Ejecutivo</p>
                                            <h1 class="text-3xl font-bold mt-3">Hola, <span id="dashboard-hero-name" class="text-primary-200">Equipo Seb Salud</span></h1>
                                            <p id="dashboard-hero-subtitle" class="text-sm text-white/70 mt-2 max-w-xl">Monitorea el pulso de la operación y actúa con anticipación.</p>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div class="rounded-2xl border border-white/20 bg-white/10 backdrop-blur px-5 py-4">
                                                <p class="text-xs font-medium uppercase tracking-wide text-white/60">Afiliados activos</p>
                                                <p id="dashboard-hero-active" class="text-3xl font-semibold mt-2">0</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/20 bg-white/10 backdrop-blur px-5 py-4">
                                                <p class="text-xs font-medium uppercase tracking-wide text-white/60">Ingresos recurrentes proyectados</p>
                                                <p id="dashboard-hero-projected" class="text-3xl font-semibold mt-2">$0</p>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                                <article class="bg-white/80 backdrop-blur rounded-3xl border border-white/60 shadow-xl p-6 flex flex-col justify-between">
                                    <div class="flex items-center justify-between mb-6">
                                        <div>
                                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Salud del negocio</p>
                                            <h2 class="text-2xl font-bold text-slate-800 mt-1">Indicadores en tiempo real</h2>
                                        </div>
                                        <div class="h-12 w-12 rounded-full bg-primary-600/10 text-primary-600 flex items-center justify-center">
                                            <i data-lucide="activity" class="h-6 w-6"></i>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p id="dashboard-net-label" class="text-xs font-medium text-slate-500 uppercase tracking-wide">Resultado neto mensual</p>
                                            <p id="dashboard-net-cashflow" class="text-2xl font-semibold text-slate-800 mt-2">$0</p>
                                            <p id="dashboard-net-description" class="text-xs text-slate-500 mt-3">Ingresos menos egresos para el periodo seleccionado.</p>
                                        </div>
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p id="dashboard-expense-label" class="text-xs font-medium text-slate-500 uppercase tracking-wide">Egresos totales del mes</p>
                                            <p id="dashboard-monthly-expenses" class="text-2xl font-semibold text-slate-800 mt-2">$0</p>
                                            <p id="dashboard-expense-description" class="text-xs text-slate-500 mt-3">Incluye comisiones a asesores y egresos manuales.</p>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex items-center justify-between text-sm">
                                        <span class="text-slate-500">Crecimiento vs. mes anterior</span>
                                        <span id="dashboard-growth-rate" class="font-semibold text-primary-600">0%</span>
                                    </div>
                                </article>
                            </div>

                            <div id="dashboard-kpi-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-6 gap-6">
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="monthly-income">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="monthly-income" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Ingresos del mes</span>
                                        <span class="rounded-full bg-emerald-100 text-emerald-600 p-2">
                                            <i data-lucide="trending-up" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-monthly-income" class="text-3xl font-bold text-slate-900">$0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Total de ingresos registrados en el periodo actual.</p>
                                </div>
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="admin-net-profit">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="admin-net-profit" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Ganancia administrativa neta</span>
                                        <span class="rounded-full bg-amber-100 text-amber-600 p-2">
                                            <i data-lucide="diamond" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-admin-net-profit" class="text-3xl font-bold text-slate-900">$0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Tarifa administrativa menos comisiones para asesores.</p>
                                </div>
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="net-profit">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="net-profit" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Resultado neto (mes)</span>
                                        <span class="rounded-full bg-indigo-100 text-indigo-600 p-2">
                                            <i data-lucide="briefcase" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-net-profit" class="text-3xl font-bold text-slate-900">$0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Saldo real después de comisiones y egresos.</p>
                                </div>
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="new-affiliates">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="new-affiliates" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Nuevos afiliados</span>
                                        <span class="rounded-full bg-sky-100 text-sky-600 p-2">
                                            <i data-lucide="user-plus" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-new-affiliates" class="text-3xl font-bold text-slate-900">0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Personas incorporadas durante el mes en curso.</p>
                                </div>
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="active-affiliates">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="active-affiliates" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Afiliados activos</span>
                                        <span class="rounded-full bg-slate-100 text-slate-600 p-2">
                                            <i data-lucide="shield-check" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-active-affiliates" class="text-3xl font-bold text-slate-900">0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Cartera vigente en seguimiento continuo.</p>
                                </div>
                                <div class="group relative overflow-hidden rounded-3xl bg-white border border-slate-200 shadow-xl p-6 flex flex-col gap-4 transition hover:-translate-y-0.5 hover:shadow-2xl" data-kpi="overdue-payments" data-role="admin-only">
                                    <div class="flex items-center justify-between">
                                        <span data-kpi-label="overdue-payments" class="text-[11px] font-semibold uppercase tracking-[0.28em] text-slate-500">Cartera vencida</span>
                                        <span class="rounded-full bg-rose-100 text-rose-600 p-2">
                                            <i data-lucide="clock" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <p id="kpi-overdue-payments" class="text-3xl font-bold text-rose-500">$0</p>
                                    <p class="text-xs text-slate-500 leading-snug">Monto pendiente por recuperación y seguimiento.</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                <article class="rounded-3xl bg-white border border-slate-200 shadow-xl p-6">
                                    <div class="flex items-center justify-between mb-6">
                                        <div>
                                            <h3 class="text-lg font-semibold text-slate-800">Indicadores operativos</h3>
                                            <p class="text-sm text-slate-500">Seguimiento de la salud de la cartera y la captación.</p>
                                        </div>
                                        <span class="rounded-full bg-primary-600/10 text-primary-600 p-2">
                                            <i data-lucide="pie-chart" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p class="text-sm font-semibold text-slate-500">Retención de afiliados</p>
                                            <p id="dashboard-retention-rate" class="text-2xl font-bold text-slate-800 mt-2">0%</p>
                                            <p class="text-xs text-slate-500 mt-2">Relación entre afiliados activos y cartera total.</p>
                                        </div>
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p class="text-sm font-semibold text-slate-500">Ticket promedio mensual</p>
                                            <p id="dashboard-average-ticket" class="text-2xl font-bold text-slate-800 mt-2">$0</p>
                                            <p class="text-xs text-slate-500 mt-2">Valor medio recurrente por afiliado activo.</p>
                                        </div>
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p class="text-sm font-semibold text-slate-500">Afiliados en mora</p>
                                            <p class="text-2xl font-bold text-slate-800 mt-2" id="dashboard-overdue-count">0 afiliados</p>
                                            <p class="text-xs text-slate-500 mt-2">Valor asociado: <span id="dashboard-overdue-value" class="font-semibold">$0</span></p>
                                        </div>
                                        <div class="rounded-2xl border border-slate-200 p-4">
                                            <p class="text-sm font-semibold text-slate-500">Nuevos afiliados del mes</p>
                                            <p id="dashboard-monthly-new" class="text-2xl font-bold text-slate-800 mt-2">0</p>
                                            <p id="dashboard-monthly-new-delta" class="text-xs text-slate-500 mt-2">0 vs. mes anterior</p>
                                        </div>
                                    </div>
                                </article>

                                <article class="rounded-3xl bg-slate-900 text-white shadow-xl border border-slate-800 p-6 flex flex-col justify-between" data-role="admin-only">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-semibold">Mejor asesor del mes</h3>
                                        <span class="rounded-full bg-white/10 text-primary-200 p-2">
                                            <i data-lucide="award" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <div class="mt-6 space-y-2">
                                        <p id="dashboard-top-advisor" class="text-2xl font-bold">Sin datos</p>
                                        <p class="text-sm text-white/70">Comisiones generadas: <span id="dashboard-top-advisor-commission" class="font-semibold text-primary-200">$0</span></p>
                                    </div>
                                    <p class="text-xs text-white/50 mt-6">Basado en las comisiones calculadas automáticamente durante el mes.</p>
                                </article>
                            </div>
                        </div>
                    </section>

                    <section id="empresa" class="content-section">
                        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg max-w-3xl mx-auto">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Perfil de la Empresa</h2>
                            <form id="company-profile-form" class="space-y-6">
                                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                                    <div id="company-logo-display" class="relative h-20 w-20 rounded-2xl border border-dashed border-slate-300/60 bg-slate-50 flex items-center justify-center overflow-hidden shadow-sm">
                                        <img id="company-logo-preview" src="" alt="Logo de la empresa" class="h-full w-full object-cover hidden">
                                        <div id="company-logo-placeholder" class="flex flex-col items-center justify-center text-slate-400">
                                            <i data-lucide="image" class="w-8 h-8"></i>
                                            <span class="mt-1 text-[10px] uppercase tracking-wide font-medium">Logo</span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <label for="company-logo" class="block text-sm font-medium text-slate-600">Logo de la Empresa</label>
                                        <div class="mt-1 flex flex-col sm:flex-row sm:items-center gap-3">
                                            <input type="file" id="company-logo" accept="image/png,image/jpeg,image/jpg,image/webp" class="w-full sm:w-auto text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border file:border-slate-200 file:text-sm file:font-semibold file:bg-white file:text-slate-700 hover:file:bg-slate-50">
                                            <button type="button" id="remove-company-logo" class="text-sm text-rose-500 hover:text-rose-600 hidden">Quitar logo</button>
                                        </div>
                                        <p class="mt-2 text-xs text-slate-500">Formatos PNG o JPG de hasta 1.5&nbsp;MB. El logo aparecerá en tu panel y en los PDF generados.</p>
                                    </div>
                                </div>
                                <div><label for="company-name" class="block text-sm font-medium text-slate-600">Nombre</label><input type="text" id="company-name" class="w-full mt-1 p-2 border rounded-lg" required></div>
                                <div><label for="company-nit" class="block text-sm font-medium text-slate-600">NIT / Documento</label><input type="text" id="company-nit" class="w-full mt-1 p-2 border rounded-lg" required></div>
                                <div><label for="company-address" class="block text-sm font-medium text-slate-600">Dirección</label><input type="text" id="company-address" class="w-full mt-1 p-2 border rounded-lg"></div>
                                <div><label for="company-phone" class="block text-sm font-medium text-slate-600">Tel&#233;fono</label><input type="tel" id="company-phone" class="w-full mt-1 p-2 border rounded-lg"></div>
                                <div><label for="company-email" class="block text-sm font-medium text-slate-600">Email</label><input type="email" id="company-email" class="w-full mt-1 p-2 border rounded-lg"></div>
                                <div class="mt-6 pt-6 border-t">
    <h3 class="text-lg font-medium text-slate-700 mb-4">Color del Tema Principal</h3>
    <div id="theme-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
        
        <label class="cursor-pointer">
            <input type="radio" name="theme" value="default" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-500/50"><div class="flex items-center justify-between"><span class="font-semibold">&#205;ndigo</span><div class="w-6 h-6 rounded-full bg-[#4f46e5]"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="bosque" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-lime-500 peer-checked:ring-2 peer-checked:ring-lime-500/50"><div class="flex items-center justify-between"><span class="font-semibold">Bosque</span><div style="background-image: linear-gradient(to right top, #a3e635, #06b6d4);" class="w-6 h-6 rounded-full"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="atardecer" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-orange-500 peer-checked:ring-2 peer-checked:ring-orange-500/50"><div class="flex items-center justify-between"><span class="font-semibold">Atardecer</span><div style="background-image: linear-gradient(to right top, #fde047, #f97316, #ef4444);" class="w-6 h-6 rounded-full"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="elegant" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-amber-500 peer-checked:ring-2 peer-checked:ring-amber-500/50"><div class="flex items-center justify-between"><span class="font-semibold">Elegant</span><div style="background-image: linear-gradient(to right top, #f59e0b, #0ea5e9);" class="w-6 h-6 rounded-full"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="espacial" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-sky-500 peer-checked:ring-2 peer-checked:ring-sky-500/50"><div class="flex items-center justify-between"><span class="font-semibold">Espacial</span><div class="w-6 h-6 rounded-full bg-gradient-to-br from-[#38bdf8] to-[#8b5cf6]"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="verano-tropical" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-fuchsia-600 peer-checked:ring-2 peer-checked:ring-fuchsia-600/50"><div class="flex items-center justify-between"><span class="font-semibold">Tropical</span><div class="w-6 h-6 rounded-full bg-gradient-to-br from-[#a3e635] to-[#ec4899]"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="apple" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-gray-300 peer-checked:ring-2 peer-checked:ring-gray-300/50"><div class="flex items-center justify-between"><span class="font-semibold">Apple</span><div class="w-6 h-6 rounded-full bg-black border-2 border-white"></div></div></div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="neon-amarillo" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-yellow-400 peer-checked:ring-2 peer-checked:ring-yellow-400/50"><div class="flex items-center justify-between"><span class="font-semibold">Ne&#243;n</span><div class="w-6 h-6 rounded-full bg-[#ccff00]"></div></div></div>
        </label>
        
        <label class="cursor-pointer">
            <input type="radio" name="theme" value="liquid-glass" class="sr-only peer">
            <div class="relative p-4 rounded-lg border-2 border-slate-200 peer-checked:border-sky-400 peer-checked:ring-2 peer-checked:ring-sky-400/50">
                <span class="premium-theme-tag">
                    <i data-lucide="crown" class="w-3 h-3"></i>
                </span>
                <div class="flex items-center justify-between">
                    <span class="font-semibold">Liquid Glass</span>
                    <div style="background-image: linear-gradient(to top, #0c2b64, #0075a1, #00b9a8, #00f871); position: relative; overflow: hidden;" class="w-6 h-6 rounded-full">
                        <div style="backdrop-filter: blur(2px); background: rgba(255,255,255,0.4);" class="w-full h-full"></div>
                    </div>
                </div>
            </div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="aurora" class="sr-only peer">
            <div class="relative p-4 rounded-lg border-2 border-slate-200 peer-checked:border-purple-500 peer-checked:ring-2 peer-checked:ring-purple-500/50">
                <span class="premium-theme-tag" style="background-image: linear-gradient(to right, #4c2889, #9d4edd);">
                    <i data-lucide="crown" class="w-3 h-3"></i>
                </span>
                <div class="flex items-center justify-between">
                    <span class="font-semibold">Aurora</span>
                    <div style="background-image: linear-gradient(135deg, #00ffc3, #a94cf2, #0084ff);" class="w-6 h-6 rounded-full"></div>
                </div>
            </div>
        </label>

        <label class="cursor-pointer">
            <input type="radio" name="theme" value="spotify" class="sr-only peer">
            <div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-green-500 peer-checked:ring-2 peer-checked:ring-green-500/50"><div class="flex items-center justify-between"><span class="font-semibold">Spotify</span><div class="w-6 h-6 rounded-full bg-[#1DB954]"></div></div></div>
        </label>

    </div>
</div>
                                <div class="mt-6 pt-6 border-t"><h3 class="text-lg font-medium text-slate-700 mb-4">Tema del Panel Lateral</h3><div id="sidebar-theme-selector" class="grid grid-cols-2 gap-4"><label class="cursor-pointer"><input type="radio" name="sidebar-theme" value="dark" class="sr-only peer"><div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-slate-800 peer-checked:ring-2 peer-checked:ring-slate-800/50"><div class="flex items-center justify-between"><span class="font-semibold">Oscuro</span><div class="w-6 h-6 rounded-full bg-slate-900 border-2"></div></div></div></label><label class="cursor-pointer"><input type="radio" name="sidebar-theme" value="light" class="sr-only peer"><div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-slate-400 peer-checked:ring-2 peer-checked:ring-slate-400/50"><div class="flex items-center justify-between"><span class="font-semibold">Claro</span><div class="w-6 h-6 rounded-full bg-white border-2"></div></div></div></label></div></div>
                                <div class="mt-6 pt-6 border-t"><h3 class="text-lg font-medium text-slate-700 mb-4">Tema del Men&#250; Inferior (M&#243;vil)</h3><div id="bottom-nav-theme-selector" class="grid grid-cols-2 gap-4"><label class="cursor-pointer"><input type="radio" name="bottom-nav-theme" value="dark" class="sr-only peer"><div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-slate-800 peer-checked:ring-2 peer-checked:ring-slate-800/50"><div class="flex items-center justify-between"><span class="font-semibold">Oscuro</span><div class="w-6 h-6 rounded-full bg-slate-900 border-2"></div></div></div></label><label class="cursor-pointer"><input type="radio" name="bottom-nav-theme" value="light" class="sr-only peer"><div class="p-4 rounded-lg border-2 border-slate-200 peer-checked:border-slate-400 peer-checked:ring-2 peer-checked:ring-slate-400/50"><div class="flex items-center justify-between"><span class="font-semibold">Claro</span><div class="w-6 h-6 rounded-full bg-white border-2"></div></div></div></label></div></div>
                                <div class="pt-4"><button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div>
                            </form>
                        </div>
                    </section>
                    
                    <section id="calendario" class="content-section">
                        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800">Rendimiento Mensual de Asesores</h2>
                                    <p class="text-slate-500">Nuevos afiliados por asesor en el periodo seleccionado.</p>
                                </div>
                                <div id="calendar-month-year-filter-container" class="flex items-center gap-2">
                                    <select id="metric-month" class="p-2 border rounded-lg"></select>
                                    <select id="metric-year" class="p-2 border rounded-lg"></select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-6 gap-4 flex-wrap">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-slate-600 mr-2">Vista:</span>
                                <button id="calendar-view-cards-btn" class="p-2 rounded-lg" title="Ver como tarjetas"><i data-lucide="layout-grid" class="h-5 w-5 pointer-events-none"></i></button>
                                <button id="calendar-view-table-btn" class="p-2 rounded-lg" title="Ver como tabla"><i data-lucide="table-2" class="h-5 w-5 pointer-events-none"></i></button>
                                <button id="calendar-view-list-btn" class="p-2 rounded-lg" title="Ver como lista multimes"><i data-lucide="list" class="h-5 w-5 pointer-events-none"></i></button>
                            </div>
                        </div>
                        <div id="calendar-card-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                        <div id="calendar-table-container" style="display: none;" class="bg-white rounded-xl shadow-lg overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50">
                                    <tr class="text-left">
                                        <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Asesor</th>
                                        <th class="p-3 text-xs font-semibold text-slate-600 uppercase text-center">Nuevos Afiliados</th>
                                        <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Detalle de Afiliados</th>
                                    </tr>
                                </thead>
                                <tbody id="calendar-table-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                        <div id="calendar-list-container" style="display: none;">
                            <div class="flex justify-end mb-4">
                                <select id="calendar-list-range-filter" class="p-2 border rounded-lg">
    <option value="3" selected>Últimos 3 meses</option> <option value="6">Últimos 6 meses</option>
    <option value="12">Últimos 12 meses</option>
</select>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead id="calendar-list-head" class="bg-slate-50 sticky top-0"></thead>
                                    <tbody id="calendar-list-body" class="divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section id="flujo-caja" class="content-section"><div class="bg-white p-6 rounded-xl shadow-lg mb-8"><div class="flex flex-col md:flex-row justify-between md:items-center gap-4"><div><h2 class="text-2xl font-bold text-slate-800">Flujo de Caja</h2><p class="text-slate-500">Gesti&#243;n de ingresos, egresos y reportes financieros.</p></div><div class="flex items-center gap-4"><button id="add-expense-btn" class="w-full md:w-auto bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center whitespace-nowrap"><i data-lucide="minus" class="w-5 h-5 mr-2"></i>Nuevo Egreso</button><button id="add-income-btn" class="w-full md:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center whitespace-nowrap"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>Nuevo Ingreso</button></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center"><div class="bg-emerald-50 text-emerald-800 p-4 rounded-lg"><h3 class="text-sm font-semibold uppercase">Ingresos (Mes)</h3><p id="cashflow-income" class="text-3xl font-bold mt-1">$0</p></div><div class="bg-rose-50 text-rose-800 p-4 rounded-lg"><h3 class="text-sm font-semibold uppercase">Egresos (Mes)</h3><p id="cashflow-expenses" class="text-3xl font-bold mt-1">$0</p></div><div class="bg-sky-50 text-sky-800 p-4 rounded-lg"><h3 class="text-sm font-semibold uppercase">Balance (Mes)</h3><p id="cashflow-profit" class="text-3xl font-bold mt-1">$0</p></div></div></div><div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg"><div class="flex flex-col md:flex-row justify-between md:items-center gap-4 border-b pb-4 mb-4"><div><h3 class="text-lg font-semibold text-slate-700">Historial de Transacciones</h3></div><div class="flex flex-col sm:flex-row gap-4 items-center"><input type="date" id="report-start-date" class="w-full p-2 border rounded-lg"><span class="text-slate-500">a</span><input type="date" id="report-end-date" class="w-full p-2 border rounded-lg"><button id="generate-report-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center flex-shrink-0"><i data-lucide="file-text" class="w-5 h-5 mr-2"></i>Generar PDF</button></div></div><div class="max-h-96 overflow-y-auto"><table class="w-full text-sm"><thead class="sticky top-0 bg-slate-100"><tr class="text-left"><th class="p-2 text-xs font-semibold text-slate-600 uppercase">Fecha</th><th class="p-2 text-xs font-semibold text-slate-600 uppercase">Concepto</th><th class="p-2 text-right text-xs font-semibold text-slate-600 uppercase">Monto</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div></div></div></section>
                    <section id="afiliados" class="content-section"><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end"><div class="md:col-span-2"><label for="search-affiliate" class="text-sm font-medium text-slate-600">Buscar Afiliado</label><div class="relative mt-1"><input type="text" id="search-affiliate" placeholder="Nombre o documento..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg placeholder-slate-400"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i></div></div><div><label for="filter-affiliate-status" class="text-sm font-medium text-slate-600">Estado</label><select id="filter-affiliate-status" class="w-full mt-1 py-2 px-3 border border-slate-300 rounded-lg"><option value="all">Todos</option><option value="Activo">Activo</option><option value="Pendiente">Pendiente</option><option value="Inactivo">Inactivo</option></select></div><div><label for="filter-affiliate-payment-status" class="text-sm font-medium text-slate-600">Estado de Pago</label><select id="filter-affiliate-payment-status" class="w-full mt-1 py-2 px-3 border border-slate-300 rounded-lg"><option value="all">Todos</option><option value="Al d&#237;a">Al d&#237;a</option><option value="En mora">En mora</option></select></div></div></div><div class="flex justify-between items-center mb-6 gap-4 flex-wrap"><div class="flex items-center gap-2"><span class="text-sm font-medium text-slate-600 mr-2">Vista:</span><button id="view-as-cards-btn" class="p-2 rounded-lg" title="Ver como tarjetas"><i data-lucide="layout-grid" class="h-5 w-5 pointer-events-none"></i></button><button id="view-as-table-btn" class="p-2 rounded-lg" title="Ver como tabla"><i data-lucide="table-2" class="h-5 w-5 pointer-events-none"></i></button></div><div class="flex items-center gap-4"><button id="export-affiliates-btn" class="bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm flex items-center justify-center whitespace-nowrap"><i data-lucide="download" class="w-5 h-5 mr-2 text-green-600"></i>Exportar a CSV</button><button id="add-affiliate-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center whitespace-nowrap"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Afiliado</button></div></div><div id="affiliates-card-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div><div id="affiliates-table-container" style="display: none;" class="bg-white rounded-xl shadow-lg overflow-x-auto"><table class="w-full text-sm"><thead class="bg-slate-50"><tr class="text-left"><th class="p-3 text-xs font-semibold text-slate-600 uppercase">Afiliado</th><th class="p-3 text-xs font-semibold text-slate-600 uppercase">Plan / Asesor</th><th class="p-3 text-xs font-semibold text-slate-600 uppercase">Contacto</th><th class="p-3 text-xs font-semibold text-slate-600 uppercase">Estado</th><th class="p-3 text-xs font-semibold text-slate-600 uppercase text-center">Acciones</th></tr></thead><tbody id="affiliates-table-body" class="divide-y divide-slate-200"></tbody></table></div></section>
                    <section id="asesores" class="content-section"><div class="flex justify-end items-center mb-6 gap-4"><button id="export-advisors-btn" class="bg-white hover:bg-slate-50 border border-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm flex items-center justify-center whitespace-nowrap"><i data-lucide="download" class="w-5 h-5 mr-2 text-green-600"></i>Exportar a CSV</button><button id="add-advisor-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center whitespace-nowrap"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Asesor</button></div><div id="advisors-container" class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6"></div></section>
                    <section id="ranking-vendedores" class="content-section"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-2"><h2 class="text-2xl font-bold text-slate-800">Ranking de Vendedores</h2><p class="text-sm text-slate-500">Top vendedores por comisiones totales generadas.</p></div><div id="ranking-list" class="space-y-4"></div></section>
                    <section id="planes" class="content-section"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">Administrar Planes de Salud</h2><button id="add-plan-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center whitespace-nowrap"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Nuevo Plan</button></div><div id="plans-list" class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6"></div></section>
                    
                    <section id="cotizador" class="content-section">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">Cotizador de Aportes a Seguridad Social</h2>
                                <p class="text-slate-500 mt-1">Calcula los aportes de forma rápida y precisa.</p>
                            </div>
                            <button id="open-settings-btn" data-role="admin" class="text-slate-500 hover:text-primary-600 p-2 rounded-full bg-slate-100 hover:bg-slate-200"><i data-lucide="settings" class="w-6 h-6"></i></button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start">
                            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg lg:col-span-2">
                                <form id="calculator-form" class="space-y-6">
                                    <fieldset id="calculator-fieldset-1">
                                        <legend class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">1. Ingresos y Tipo</legend>
                                        <div class="space-y-5">
                                            <div>
                                                <label for="income" class="block text-sm font-medium text-slate-600 mb-1">Ingreso Mensual Real (COP)</label>
                                                <div class="relative">
                                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="text-gray-500 sm:text-sm">$</span></div>
                                                    <input type="number" id="income" placeholder="2000000" class="w-full pl-7 pr-4 py-2 border border-slate-300 rounded-lg" required>
                                                </div>
                                                <p class="text-xs text-slate-500 mt-1">El sistema calcular&#225; el IBC (40% del ingreso).</p>
                                            </div>
                                            <div>
                                                <label for="contract-type" class="block text-sm font-medium text-slate-600 mb-1">Tipo de Cotizante</label>
                                                <select id="contract-type" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                                                    <option value="independiente">Independiente</option>
                                                    <option value="dependiente">Dependiente (Empleado)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="arl-level" class="block text-sm font-medium text-slate-600 mb-1">Nivel de Riesgo ARL</label>
                                                <select id="arl-level" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                                                    <option value="1">Nivel 1 (0.522%) - Riesgo M&#237;nimo</option>
                                                    <option value="2">Nivel 2 (1.044%) - Riesgo Bajo</option>
                                                    <option value="3">Nivel 3 (2.436%) - Riesgo Medio</option>
                                                    <option value="4">Nivel 4 (4.350%) - Riesgo Alto</option>
                                                    <option value="5">Nivel 5 (6.960%) - Riesgo M&#225;ximo</option>
                                                </select>
                                            </div>
                                        </div>
                                    </fieldset>
                                    <fieldset id="calculator-fieldset-2">
                                        <legend class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">2. Componentes a Cotizar</legend>
                                        <div class="grid grid-cols-2 gap-4">
                                            <label class="flex items-center space-x-2"><input type="checkbox" name="components" value="health" class="h-4 w-4 text-primary-600 rounded component-checkbox" checked><span>Salud</span></label>
                                            <label class="flex items-center space-x-2"><input type="checkbox" name="components" value="pension" class="h-4 w-4 text-primary-600 rounded component-checkbox" checked><span>Pensi&#243;n</span></label>
                                            <label class="flex items-center space-x-2"><input type="checkbox" name="components" value="arl" class="h-4 w-4 text-primary-600 rounded component-checkbox" checked><span>ARL</span></label>
                                            <label class="flex items-center space-x-2"><input type="checkbox" name="components" value="ccf" class="h-4 w-4 text-primary-600 rounded component-checkbox" checked><span>Caja Comp.</span></label>
                                        </div>
                                        <div class="mt-3">
                                            <label class="flex items-center space-x-2"><input type="checkbox" id="select-all-components" class="h-4 w-4 text-primary-600 rounded" checked><span>Seleccionar Todo</span></label>
                                        </div>
                                    </fieldset>
                                    <div class="pt-4 mt-4 border-t" id="cotizador-actions">
                                        <button type="submit" id="calculate-btn" class="w-full shimmer-button bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-px flex items-center justify-center transition-all duration-200"><i data-lucide="calculator" class="w-5 h-5 mr-2"></i>Cotizar Aportes</button>
                                        <button type="button" id="new-quote-btn" style="display: none;" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center justify-center"><i data-lucide="rotate-cw" class="w-5 h-5 mr-2"></i>Hacer Nueva Cotizaci&#243;n</button>
                                    </div>
                                </form>
                            </div>
                            <div id="calculator-results-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg lg:col-span-3">
                                <div id="quote-summary" class="hidden grid grid-cols-2 gap-4 mb-6 border-b pb-6">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Ingreso Base de Cotizaci&#243;n (IBC)</p>
                                        <p id="ibc-value" class="text-2xl font-bold text-slate-800">$0</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-slate-500">Total Aportes Mensuales</p>
                                        <p id="grand-total" class="text-3xl font-extrabold text-primary-600">$0</p>
                                    </div>
                                </div>
                                <div id="calculator-results-breakdown" class="space-y-4">
                                    </div>
                                <div id="quote-placeholder" class="text-center py-16 text-slate-400">
                                    <i data-lucide="scan-line" class="h-16 w-16 mx-auto mb-4 text-slate-300"></i>
                                    <h3 class="font-semibold text-slate-600">Esperando c&#225;lculo</h3>
                                    <p class="text-sm">Completa el formulario y presiona "Cotizar" para ver los resultados.</p>
                                </div>
                                <div id="quote-actions-container" class="mt-8 pt-6 border-t border-slate-200 hidden">
                                    <button id="sell-plan-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center justify-center transition-transform transform hover:scale-105">
                                        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>Registrar Afiliado con esta Cotizaci&#243;n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <section id="gestion-roles" class="content-section">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                            <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-1">
                                <h2 class="text-2xl font-bold text-slate-800 mb-1">Invitar Usuario</h2>
                                <p class="text-slate-500 mb-6">Crea una cuenta para un asesor o afiliado.</p>
                                <form id="invite-user-form" class="space-y-4">
                                    <div>
                                        <label for="invite-email" class="block text-sm font-medium text-slate-600">Email del Usuario</label>
                                        <input type="email" id="invite-email" class="w-full mt-1 p-2 border rounded-lg" required>
                                    </div>
                                    <div>
                                        <label for="invite-password" class="block text-sm font-medium text-slate-600">Contrase&#241;a Temporal</label>
                                        <input type="password" id="invite-password" class="w-full mt-1 p-2 border rounded-lg" required>
                                    </div>
                                    <div>
                                        <label for="invite-role" class="block text-sm font-medium text-slate-600">Rol</label>
                                        <select id="invite-role" class="w-full mt-1 p-2 border rounded-lg" required>
                                            <option value="" disabled selected>Seleccionar rol...</option>
                                            <option value="asesor">Asesor</option>
                                            <option value="afiliado">Afiliado</option>
                                        </select>
                                    </div>
                                    <div id="invite-link-container" class="hidden">
                                        <label for="invite-link-select" id="invite-link-label" class="block text-sm font-medium text-slate-600">Vincular con:</label>
                                        <select id="invite-link-select" class="w-full mt-1 p-2 border rounded-lg"></select>
                                    </div>
                                    <div class="pt-4">
                                        <button type="submit" id="invite-user-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-4 rounded-lg">Crear y Vincular Usuario</button>
                                    </div>
                                </form>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
                                <h2 class="text-2xl font-bold text-slate-800 mb-6">Usuarios con Rol</h2>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-slate-50">
                                            <tr class="text-left">
                                                <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Email</th>
                                                <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Rol</th>
                                                <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Vinculado a</th>
                                                <th class="p-3 text-xs font-semibold text-slate-600 uppercase">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="roles-table-body" class="divide-y divide-slate-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="perfil-afiliado" class="content-section">
                         <h2 class="text-2xl font-bold text-slate-800 mb-6">Mi Perfil y Plan de Salud</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                            
                            <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-1">
                                <div class="flex flex-col items-center text-center">
                                    <div class="w-24 h-24 rounded-full bg-primary-600/10 flex items-center justify-center mb-4">
                                        <i data-lucide="user-circle-2" class="w-12 h-12 text-primary-500"></i>
                                    </div>
                                    <h3 id="afiliado-profile-name" class="text-2xl font-bold text-slate-800">Cargando Nombre...</h3>
                                    <p class="text-sm text-slate-500">Doc: <span id="afiliado-profile-id">...</span></p>
                                </div>

                                <div class="border-t my-6"></div>

                                <div class="space-y-4 text-sm">
                                    <h4 class="font-semibold text-slate-700 mb-2">Informaci&#243;n de Contacto</h4>
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="mail" class="w-5 h-5 text-slate-400 flex-shrink-0"></i>
                                        <span id="afiliado-profile-email" class="text-slate-600 break-all">...</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="phone" class="w-5 h-5 text-slate-400 flex-shrink-0"></i>
                                        <span id="afiliado-profile-phone" class="text-slate-600">...</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg lg:col-span-2">
                                <div class="p-6 border-b flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                                    <div>
                                        <p class="text-sm font-medium text-slate-500">Plan de Salud Actual</p>
                                        <h3 id="afiliado-profile-plan-name" class="text-xl font-bold text-primary-600 mt-1">Cargando Plan...</h3>
                                        <div class="mt-2" id="afiliado-profile-status-container">
                                            </div>
                                    </div>
                                    <div class="text-left sm:text-right flex-shrink-0">
                                        <p class="text-sm font-medium text-slate-500">Valor Mensual</p>
                                        <p id="afiliado-profile-plan-price" class="text-4xl font-extrabold text-slate-800">$0</p>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div>
                                            <h4 class="font-semibold text-slate-700 mb-3">Caracter&#237;sticas Incluidas</h4>
                                            <ul id="afiliado-profile-plan-features" class="space-y-2 text-sm text-slate-600">
                                                <li>Cargando caracter&#237;sticas...</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-slate-700 mb-3">Fechas Clave</h4>
                                            <div class="space-y-4">
                                                <div class="flex items-start gap-3">
                                                    <i data-lucide="calendar-check" class="w-5 h-5 text-green-500 mt-0.5"></i>
                                                    <div>
                                                        <p class="font-medium text-slate-800">Fecha de Inicio</p>
                                                        <p id="afiliado-profile-start-date" class="text-sm text-slate-500">--/--/----</p>
                                                    </div>
                                                </div>
                                                 <div class="flex items-start gap-3">
                                                    <i data-lucide="calendar-clock" class="w-5 h-5 text-red-500 mt-0.5"></i>
                                                    <div>
                                                        <p class="font-medium text-slate-800">Pr&#243;ximo Pago / Vencimiento</p>
                                                        <p id="afiliado-profile-end-date" class="text-sm font-semibold text-red-600">--/--/----</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>

        <div id="new-affiliate-success-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-[60]">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 text-center">
            <div class="p-6">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100">
                    <i data-lucide="check-circle" class="h-10 w-10 text-green-600"></i>
                </div>
                <h2 id="success-modal-title" class="text-2xl font-bold mt-4 text-slate-800">&#161;Afiliado con &#201;xito!</h2>
                <p class="text-slate-500 mt-2">El nuevo afiliado ha sido registrado correctamente.</p>
            </div>
            <div class="p-6 pt-0 bg-slate-50 rounded-b-xl space-y-3">
                <button id="success-download-pdf-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-transform hover:scale-105">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Descargar Recibo PDF</span>
                </button>
                <button id="success-share-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-transform hover:scale-105">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                    <span>Compartir</span>
                </button>
                 <button data-close-modal="new-affiliate-success-modal" class="w-full text-sm text-slate-600 hover:text-slate-800 font-medium py-2 mt-2">Cerrar</button>
            </div>
        </div>
    </div>
        
        <div id="affiliate-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col transform scale-95"><div class="flex justify-between items-center p-5 border-b sticky top-0 bg-white z-10 flex-shrink-0"><h2 id="affiliate-modal-title" class="text-2xl font-bold">Nuevo Afiliado</h2><button data-close-modal="affiliate-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div><div class="flex-grow overflow-y-auto"><form id="affiliate-form" class="p-6"><input type="hidden" id="affiliate-doc-id"><div class="space-y-10"><div><h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">1. Informaci&#243;n Personal</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><input type="text" id="affiliate-name" placeholder="Nombre Completo" class="w-full px-4 py-2 border rounded-lg" required><input type="text" id="affiliate-id" placeholder="Documento" class="w-full px-4 py-2 border rounded-lg" required><input type="email" id="affiliate-email" placeholder="Correo Electr&#243;nico" class="w-full px-4 py-2 border rounded-lg" required><input type="tel" id="affiliate-phone" placeholder="Tel&#233;fono" class="w-full px-4 py-2 border rounded-lg"><input type="text" id="affiliate-address" placeholder="Direcci&#243;n" class="md:col-span-2 w-full px-4 py-2 border rounded-lg"></div></div><div><h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">2. Plan de Salud Complementario / Prepagada</h3><div id="health-plan-selector" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"></div></div><div><h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">3. Otras Afiliaciones</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"><div><label for="eps-plan" class="block text-sm font-medium text-slate-600 mb-1">EPS</label><select id="eps-plan" class="w-full px-4 py-2 border rounded-lg" required><option value="" disabled selected>Seleccione una EPS</option><option value="Asmet Salud">Asmet Salud</option><option value="EPS Sanitas">EPS Sanitas</option><option value="Nueva EPS">Nueva EPS</option><option value="EPS SURA">EPS SURA</option><option value="Salud Total">Salud Total</option><option value="Compensar EPS">Compensar EPS</option><option value="Coosalud">Coosalud</option><option value="Mutual Ser">Mutual Ser</option><option value="Famisanar">Famisanar</option><option value="Servicio Occidental de Salud (SOS)">Servicio Occidental de Salud (SOS)</option><option value="Capital Salud">Capital Salud</option><option value="Ecoopsos EPS">Ecoopsos EPS</option><option value="Savia Salud">Savia Salud</option><option value="Otra">Otra (especifique)</option></select></div><div id="eps-plan-other-container" class="hidden"><label for="eps-plan-other" class="block text-sm font-medium text-slate-600 mb-1">Nombre de la EPS</label><input type="text" id="eps-plan-other" class="w-full px-4 py-2 border rounded-lg" placeholder="Escriba el nombre de la EPS"></div><div><label for="pension-plan" class="block text-sm font-medium text-slate-600 mb-1">Fondo de Pensi&#243;n</label><select id="pension-plan" class="w-full px-4 py-2 border rounded-lg" required><option value="" disabled selected>Seleccione un fondo</option><option value="Colpensiones">Colpensiones (P&#250;blico)</option><option value="Porvenir">Porvenir</option><option value="Protecci&#243;n">Protecci&#243;n</option><option value="Colfondos">Colfondos</option><option value="Skandia">Skandia</option></select></div><div><label for="arl-plan" class="block text-sm font-medium text-slate-600 mb-1">ARL</label><select id="arl-plan" class="w-full px-4 py-2 border rounded-lg" required><option value="" disabled selected>Seleccione una ARL</option><option value="ARL Sura">ARL Sura</option><option value="ARL Positiva">ARL Positiva</option><option value="ARL Colmena">ARL Colmena</option><option value="Seguros Bol&#237;var ARL">Seguros Bol&#237;var ARL</option><option value="AXA Colpatria ARL">AXA Colpatria ARL</option></select></div><div><label for="ccf-plan" class="block text-sm font-medium text-slate-600 mb-1">Caja de Compensaci&#243;n</label><select id="ccf-plan" class="w-full px-4 py-2 border rounded-lg" required><option value="" disabled selected>Seleccione una caja</option><option value="Comfacauca">Comfacauca</option><option value="Comfamiliar del Cauca">Comfamiliar del Cauca</option><option value="Comfenalco Valle">Comfenalco Valle</option><option value="Comfandi">Comfandi (Valle)</option><option value="Comfamiliar Nari&#241;o">Comfamiliar Nari&#241;o</option><option value="Compensar">Compensar</option><option value="Colsubsidio">Colsubsidio</option><option value="Cafam">Cafam</option><option value="Comfama">Comfama (Antioquia)</option><option value="Ninguna">Ninguna</option><option value="Otra">Otra (especifique)</option></select></div><div id="ccf-plan-other-container" class="hidden"><label for="ccf-plan-other" class="block text-sm font-medium text-slate-600 mb-1">Nombre de la Caja</label><input type="text" id="ccf-plan-other" class="w-full px-4 py-2 border rounded-lg" placeholder="Escriba el nombre de la caja"></div></div></div><div><h3 class="text-lg font-semibold text-slate-700 border-b pb-2 mb-4">4. Detalles de Venta y Administrativos</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div><label for="advisor-select-list" class="block text-sm font-medium text-slate-600 mb-1">Asesor Asignado</label><select id="advisor-select-list" class="w-full px-4 py-2 border rounded-lg" required></select></div><div><label for="affiliate-start-date" class="block text-sm font-medium text-slate-600 mb-1">Fecha de Inicio</label><input type="date" id="affiliate-start-date" class="w-full px-4 py-2 border rounded-lg" required></div><div><label for="affiliate-end-date" class="block text-sm font-medium text-slate-600 mb-1">Fecha de Finalizaci&#243;n</label><input type="date" id="affiliate-end-date" class="w-full px-4 py-2 border rounded-lg"></div><div><label for="affiliate-status" class="block text-sm font-medium text-slate-600 mb-1">Estado del Afiliado</label><select id="affiliate-status" class="w-full px-4 py-2 border rounded-lg" required><option value="Activo">Activo</option><option value="Pendiente">Pendiente</option><option value="Inactivo">Inactivo</option></select></div></div><div class="mt-6"><label class="flex items-center space-x-2"><input type="checkbox" id="manual-override-checkbox" class="h-4 w-4 text-primary-600 rounded"><span>Usar costos y comisiones manuales</span></label></div><div id="manual-override-container" class="hidden mt-4 space-y-6 p-4 border rounded-lg bg-slate-50"><div><h4 class="text-md font-semibold text-slate-600 mb-3">Costos de Afiliaci&#243;n</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div><label class="text-sm font-medium">Salud ($)</label><input type="number" id="manual-cost-health" class="w-full p-2 border rounded-lg mt-1" placeholder="Ej: 95000"></div><div><label class="text-sm font-medium">Pensi&#243;n ($)</label><input type="number" id="manual-cost-pension" class="w-full p-2 border rounded-lg mt-1" placeholder="0"></div><div><label class="text-sm font-medium">ARL ($)</label><input type="number" id="manual-cost-arl" class="w-full p-2 border rounded-lg mt-1" placeholder="0"></div><div><label class="text-sm font-medium">Caja Comp. ($)</label><input type="number" id="manual-cost-ccf" class="w-full p-2 border rounded-lg mt-1" placeholder="0"></div></div></div><div class="pt-4 border-t"><h4 class="text-md font-semibold text-slate-600 mb-3">Comisiones</h4><div class="max-w-xs"><label class="text-sm font-medium">Comisi&#243;n Asesor ($)</label><input type="number" id="manual-commission" class="w-full p-2 border rounded-lg mt-1" placeholder="Ej: 20000"></div></div></div><div class="mt-6"><textarea id="affiliate-notes" placeholder="Notas adicionales..." class="w-full px-4 py-2 border rounded-lg h-24"></textarea></div></div></div><div class="pt-6 border-t mt-8 flex justify-end"><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-8 rounded-lg">Guardar Afiliado</button></div></form></div></div></div>
        <div id="plan-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-full overflow-y-auto transform scale-95"><div class="flex justify-between items-center p-6 border-b"><h2 id="plan-modal-title" class="text-2xl font-bold">Nuevo Plan de Salud</h2><button data-close-modal="plan-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div><form id="plan-form" class="p-6"><input type="hidden" id="plan-doc-id"><div class="space-y-4"><div><label for="plan-name" class="block text-sm font-medium text-slate-600">Nombre del Plan</label><input type="text" id="plan-name" placeholder="Ej: Plan Integral" class="w-full mt-1 p-2 border rounded-lg" required></div><div><label for="plan-price" class="block text-sm font-medium text-slate-600">Precio Mensual ($)</label><input type="number" id="plan-price" placeholder="Ej: 180000" class="w-full mt-1 p-2 border rounded-lg" required></div><div><label for="plan-features" class="block text-sm font-medium text-slate-600">Caracter&#237;sticas (una por l&#237;nea)</label><textarea id="plan-features" placeholder="Acceso directo a 5 especialidades&#10;Atenci&#243;n domiciliaria" class="w-full mt-1 p-2 border rounded-lg h-32" required></textarea></div></div><div class="pt-6 border-t mt-6 flex justify-end"><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar Plan</button></div></form></div></div>
        <div id="advisor-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto transform scale-95"><div class="flex justify-between items-center p-6 border-b"><h2 id="advisor-modal-title" class="text-2xl font-bold">Nuevo Asesor</h2><button data-close-modal="advisor-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div><form id="advisor-form" class="p-6"><input type="hidden" id="advisor-doc-id"><div class="space-y-4"><input type="text" id="advisor-name" placeholder="Nombre Completo" class="w-full px-4 py-2 border rounded-lg" required><input type="number" id="advisor-commission" placeholder="Comisi&#243;n (%)" min="0" max="100" class="w-full px-4 py-2 border rounded-lg" required></div><div class="pt-6 border-t mt-6 flex justify-end"><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar Asesor</button></div></form></div></div>
        <div id="settings-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95"><div class="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10"><h2 class="text-2xl font-bold">Configuraci&#243;n de Par&#225;metros</h2><button data-close-modal="settings-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div><form id="settings-form" class="p-6 space-y-6"><div><h3 class="font-semibold text-lg mb-2">Generales</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Salario M&#237;nimo (SMMLV)</label><input type="number" id="setting-smmlv" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Costo Admin. por Afiliado ($)</label><input type="number" id="setting-admin-fee" class="w-full p-2 border rounded-lg"></div></div></div><div><h3 class="font-semibold text-lg mb-2">Porcentajes de Cotizaci&#243;n (%)</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div><label class="block text-sm font-medium">Salud Total</label><input type="number" step="0.1" id="setting-health" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Pensi&#243;n Total</label><input type="number" step="0.1" id="setting-pension" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Caja Comp. Indep.</label><input type="number" step="0.1" id="setting-ccf-ind" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Caja Comp. Empleador</label><input type="number" step="0.1" id="setting-ccf-emp" class="w-full p-2 border rounded-lg"></div></div></div><div><h3 class="font-semibold text-lg mb-2">Porcentajes ARL (%)</h3><div class="grid grid-cols-2 md:grid-cols-5 gap-4"><div><label class="block text-sm font-medium">Riesgo 1</label><input type="number" step="0.001" id="setting-arl-1" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Riesgo 2</label><input type="number" step="0.001" id="setting-arl-2" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Riesgo 3</label><input type="number" step="0.001" id="setting-arl-3" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Riesgo 4</label><input type="number" step="0.001" id="setting-arl-4" class="w-full p-2 border rounded-lg"></div><div><label class="block text-sm font-medium">Riesgo 5</label><input type="number" step="0.001" id="setting-arl-5" class="w-full p-2 border rounded-lg"></div></div></div><div class="pt-6 border-t mt-6 flex justify-end"><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar Cambios</button></div></form></div></div>
        <div id="transaction-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto transform scale-95"><div class="flex justify-between items-center p-6 border-b"><h2 id="transaction-modal-title" class="text-2xl font-bold"></h2><button data-close-modal="transaction-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div><form id="transaction-form" class="p-6"><input type="hidden" id="transaction-type"><div class="space-y-4"><div><label for="transaction-concept" class="block text-sm font-medium text-slate-600">Concepto</label><input type="text" id="transaction-concept" class="w-full mt-1 p-2 border rounded-lg" required></div><div><label for="transaction-amount" class="block text-sm font-medium text-slate-600">Monto</label><input type="number" id="transaction-amount" min="0" class="w-full mt-1 p-2 border rounded-lg" required></div><div><label for="transaction-date" class="block text-sm font-medium text-slate-600">Fecha</label><input type="date" id="transaction-date" class="w-full mt-1 p-2 border rounded-lg" required></div></div><div class="pt-6 border-t mt-6 flex justify-end"><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Guardar</button></div></form></div></div>
        
        <nav class="bottom-nav md:hidden fixed bottom-0 inset-x-0 flex justify-around p-2 z-40">
            <a href="#" data-target="dashboard" class="bottom-nav-link active flex flex-col items-center justify-center text-center w-full p-1"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[10px] mt-1">Dashboard</span></a>
            <a href="#" data-target="afiliados" class="bottom-nav-link flex flex-col items-center justify-center text-center w-full p-1"><i data-lucide="users" class="w-5 h-5"></i><span class="text-[10px] mt-1">Afiliados</span></a>
            <a href="#" data-target="asesores" data-role="admin" class="bottom-nav-link flex flex-col items-center justify-center text-center w-full p-1"><i data-lucide="user-circle" class="w-5 h-5"></i><span class="text-[10px] mt-1">Asesores</span></a>
            <a href="#" data-target="cotizador" class="bottom-nav-link flex flex-col items-center justify-center text-center w-full p-1"><i data-lucide="calculator" class="w-5 h-5"></i><span class="text-[10px] mt-1">Cotizador</span></a>
            <a href="#" data-target="perfil-afiliado" data-role="afiliado" class="bottom-nav-link flex flex-col items-center justify-center text-center w-full p-1"><i data-lucide="user" class="w-5 h-5"></i><span class="text-[10px] mt-1">Mi Perfil</span></a>
        </nav>
    </div>

<script type="module">
    // =================================================================
    // INICIO DE LA SOLUCIÓN: IMPORTACIONES DE FIREBASE
    // =================================================================
    import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, writeBatch, deleteDoc, serverTimestamp, onSnapshot, query, where, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* === INICIO DE LA SOLUCIÓN: APLICAR TEMA AL CARGAR LA PÁGINA === */
(() => {
    const savedTheme = localStorage.getItem('userTheme') || 'bosque';
    document.documentElement.setAttribute('data-theme', savedTheme);
})();
/* === FIN DE LA SOLUCIÓN === */
    
    // --- INICIALIZACIÓN Y CONFIGURACIÓN DE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDS4VDnwGia2ZUe3o81rqLe-oEu_pVCUHc",
        authDomain: "seb-salud.firebaseapp.com",
        projectId: "seb-salud",
        storageBucket: "seb-salud.appspot.com",
        messagingSenderId: "1094873327284",
        appId: "1:1094873327284:web:001e70e84c2de45389d9e1",
        measurementId: "G-EJCS9FYWHK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db)
      .catch((err) => {
        if (err.code == 'failed-precondition') {
          console.warn('La persistencia falló, probablemente porque ya hay otra pestaña abierta.');
        } else if (err.code == 'unimplemented') {
          console.warn('El navegador actual no soporta la persistencia offline de Firestore.');
        }
      });

    let currentUser = null;

    // --- ESTADO GLOBAL PARA ROLES ---
    let currentUserRole = null; // 'admin', 'asesor', 'afiliado'
    let adminUidForRole = null; // UID del admin al que pertenece el usuario con rol
    let userRoleData = {}; // Guardará datos del rol, como el ID vinculado

    // --- ESTADO GLOBAL Y CONFIGURACIÓN ---
    let affiliates = [], advisors = [], manualTransactions = [], novedades = [], healthPlans = [], userRoles = [];
    let companyProfile = {};
    let settings = {};
    let affiliatesViewMode = 'card';
    let calendarViewMode = 'list'; // <--- VISTA POR DEFECTO DEL CALENDARIO
    let lastQuoteResult = null;
    let lastCreatedAffiliate = null;
    let activeListeners = [];

    const defaultSettings = { 
        SMMLV: 1423500, 
        ADMIN_FEE_PER_AFFILIATE: 29000,
        CONTRIBUTION_RATES: { health: 12.5, pension: 16, employee_health: 4, employer_health: 8.5, employee_pension: 4, employer_pension: 12, independiente_ccf: 2, employer_ccf: 4 }, 
        ARL_RATES: { 1: 0.522, 2: 1.044, 3: 2.436, 4: 4.350, 5: 6.960 } 
    };
    
    const defaultCompanyProfile = { name: 'Mi Empresa de Seguridad Social', nit: '900.123.456-7', address: 'Calle 123 # 45-67, Bogotá', phone: '3001234567', email: 'contacto@empresa.com', theme: 'spotify', sidebarTheme: 'dark', bottomNavTheme: 'dark', logo: null };

    const MAX_COMPANY_LOGO_SIZE = 1.5 * 1024 * 1024; // 1.5 MB
    const LOGO_CANVAS_MAX_SIZE = 512;
    const LOGO_COMPRESSION_QUALITY = 0.85;
    const isDashboardDemoMode = window.location.hash.toLowerCase().includes('demo-dashboard');
    let dashboardDemoInitialized = false;

    function getImageFormatFromDataURL(dataUrl) {
        if (typeof dataUrl !== 'string') return 'PNG';
        const match = dataUrl.match(/^data:image\/(png|jpeg|jpg|webp)/i);
        if (!match) return 'PNG';
        const type = match[1].toLowerCase();
        if (type === 'jpg') return 'JPEG';
        return type === 'jpeg' ? 'JPEG' : type.toUpperCase();
    }

    function updateSidebarBranding() {
        const logoImg = document.getElementById('sidebar-logo-image');
        const logoIcon = document.querySelector('#sidebar .logo-icon');
        const logoText = document.getElementById('sidebar-logo-text');

        if (logoText) {
            logoText.textContent = companyProfile.name || 'Seb Salud';
        }

        if (logoImg && logoIcon) {
            if (companyProfile.logo) {
                logoImg.src = companyProfile.logo;
                logoImg.classList.remove('hidden');
                logoIcon.classList.add('hidden');
            } else {
                logoImg.src = '';
                logoImg.classList.add('hidden');
                logoIcon.classList.remove('hidden');
            }
        }
    }

    function updateCompanyLogoUI(logoDataUrl) {
        const preview = document.getElementById('company-logo-preview');
        const placeholder = document.getElementById('company-logo-placeholder');
        const removeBtn = document.getElementById('remove-company-logo');

        if (preview && placeholder && removeBtn) {
            if (logoDataUrl) {
                preview.src = logoDataUrl;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
        }

        updateSidebarBranding();
    }

    function calculateBase64Size(dataUrl) {
        if (typeof dataUrl !== 'string') return 0;
        const base64 = dataUrl.split(',')[1];
        if (!base64) return 0;
        return Math.ceil((base64.length * 3) / 4);
    }

    function pixelsToMillimeters(pixels, dpi = 96) {
        if (!pixels || dpi <= 0) return 0;
        return (pixels / dpi) * 25.4;
    }

    async function getImageDimensionsFromDataURL(dataUrl) {
        if (!dataUrl) return null;
        return new Promise((resolve, reject) => {
            const image = new Image();
            image.onload = () => {
                resolve({ width: image.naturalWidth, height: image.naturalHeight });
            };
            image.onerror = (error) => reject(error);
            image.src = dataUrl;
        }).catch(error => {
            console.error('No se pudieron obtener las dimensiones del logo:', error);
            return null;
        });
    }

    async function addLogoToPDF(doc, logoDataUrl, { x = 14, y = 12, maxWidthMm = 48, maxHeightMm = 24 } = {}) {
        if (!logoDataUrl) return null;

        const dimensions = await getImageDimensionsFromDataURL(logoDataUrl);
        if (!dimensions || !dimensions.width || !dimensions.height) return null;

        let renderWidthMm = pixelsToMillimeters(dimensions.width);
        let renderHeightMm = pixelsToMillimeters(dimensions.height);

        if (renderWidthMm <= 0 || renderHeightMm <= 0) return null;

        const widthScale = maxWidthMm / renderWidthMm;
        const heightScale = maxHeightMm / renderHeightMm;
        const scale = Math.min(widthScale, heightScale, 1);

        renderWidthMm *= scale;
        renderHeightMm *= scale;

        const logoFormat = getImageFormatFromDataURL(logoDataUrl);
        doc.addImage(logoDataUrl, logoFormat, x, y, renderWidthMm, renderHeightMm);

        return { width: renderWidthMm, height: renderHeightMm, x, y };
    }

    function updateTextContent(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    }

    function setKpiLabel(key, text) {
        const label = document.querySelector(`[data-kpi-label="${key}"]`);
        if (label) {
            label.textContent = text;
        }
    }

    function updateGrowthIndicator(value) {
        const growthElement = document.getElementById('dashboard-growth-rate');
        if (!growthElement) return;
        const formatted = `${value > 0 ? '+' : ''}${formatPercentage(value)}`;
        growthElement.textContent = formatted;
        growthElement.classList.toggle('text-emerald-600', value >= 0);
        growthElement.classList.toggle('text-rose-500', value < 0);
    }

    function parseAppDate(value) {
        if (!value) return null;
        if (value instanceof Date) {
            return Number.isNaN(value.getTime()) ? null : value;
        }
        if (typeof value?.toDate === 'function') {
            const converted = value.toDate();
            return Number.isNaN(converted?.getTime?.()) ? null : converted;
        }
        if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) return null;
            const isoDateMatch = /^\d{4}-\d{2}-\d{2}$/.test(trimmed);
            if (isoDateMatch) {
                const [year, month, day] = trimmed.split('-').map(Number);
                const localDate = new Date(year, month - 1, day);
                return Number.isNaN(localDate.getTime()) ? null : localDate;
            }
            const parsed = new Date(trimmed);
            return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
    }

    function normalizeDateInput(value) {
        if (!value) return null;

        if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                return `${trimmed}T00:00:00`;
            }
            if (/^\d{4}-\d{2}-\d{2}T/.test(trimmed)) {
                const parsedIso = new Date(trimmed);
                if (!Number.isNaN(parsedIso.getTime())) {
                    const year = parsedIso.getUTCFullYear();
                    const month = String(parsedIso.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(parsedIso.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}T00:00:00`;
                }
            }
        }

        const parsed = parseAppDate(value);
        if (!parsed) return null;
        const year = parsed.getFullYear();
        const month = String(parsed.getMonth() + 1).padStart(2, '0');
        const day = String(parsed.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}T00:00:00`;
    }

    function getComparableDate(value) {
        if (!value) return null;
        const parsed = parseAppDate(value);
        if (parsed) return parsed;
        const fallback = new Date(value);
        return Number.isNaN(fallback.getTime()) ? null : fallback;
    }

    function setupConditionalField(selectElement, containerElement, inputElement) {
        if (!selectElement || !containerElement || !inputElement) {
            return () => {};
        }
        const handler = () => {
            const useOther = selectElement.value === 'Otra';
            containerElement.classList.toggle('hidden', !useOther);
            inputElement.required = useOther;
            if (!useOther) {
                inputElement.value = '';
            }
        };
        selectElement.addEventListener('change', handler);
        handler();
        return handler;
    }

    function isAffiliateActiveAtDate(affiliate, referenceDate) {
        if (!affiliate || !referenceDate) return false;
        const startDate = parseAppDate(affiliate.startDate || affiliate.createdAt);
        const endDate = parseAppDate(affiliate.endDate);
        if (startDate && referenceDate < startDate) return false;
        if (endDate && referenceDate > endDate) return false;
        const status = (affiliate.status || '').toLowerCase();
        if (['inactivo', 'cancelado', 'retirado'].includes(status)) {
            return endDate ? referenceDate <= endDate : false;
        }
        return true;
    }

    function compressImageFile(file, maxSize = LOGO_CANVAS_MAX_SIZE, quality = LOGO_COMPRESSION_QUALITY) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error('No se pudo leer el archivo del logo.'));
            reader.onload = (event) => {
                const image = new Image();
                image.onerror = () => reject(new Error('No se pudo cargar la imagen seleccionada.'));
                image.onload = () => {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    const scale = Math.min(maxSize / image.width, maxSize / image.height, 1);
                    const targetWidth = Math.round(image.width * scale);
                    const targetHeight = Math.round(image.height * scale);

                    canvas.width = targetWidth;
                    canvas.height = targetHeight;

                    if (context) {
                        context.clearRect(0, 0, targetWidth, targetHeight);
                        context.imageSmoothingEnabled = true;
                        context.imageSmoothingQuality = 'high';
                        context.drawImage(image, 0, 0, targetWidth, targetHeight);
                    }

                    let outputType = file.type.includes('png') ? 'image/png'
                        : file.type.includes('webp') ? 'image/webp'
                        : 'image/jpeg';
                    let dataUrl;

                    try {
                        dataUrl = canvas.toDataURL(outputType, outputType === 'image/png' ? undefined : quality);
                    } catch (error) {
                        outputType = 'image/png';
                        dataUrl = canvas.toDataURL(outputType);
                    }

                    resolve({ dataUrl, outputType });
                };
                image.src = event.target?.result;
            };
            reader.readAsDataURL(file);
        });
    }
    
    // --- MANEJO DE VISTAS Y ESTADO DE CARGA ---
    const loader = document.getElementById('loader');
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');

    const updateEpsOtherFieldVisibility = setupConditionalField(
        document.getElementById('eps-plan'),
        document.getElementById('eps-plan-other-container'),
        document.getElementById('eps-plan-other')
    );

    const updateCcfOtherFieldVisibility = setupConditionalField(
        document.getElementById('ccf-plan'),
        document.getElementById('ccf-plan-other-container'),
        document.getElementById('ccf-plan-other')
    );
    
    const showView = (view) => { loader.style.display = 'none'; authContainer.style.display = 'none'; appContainer.style.display = 'none'; view.style.display = view === appContainer ? 'block' : 'flex'; lucide.createIcons(); };

    // --- FLUJO DE AUTENTICACIÓN MEJORADO CON ROLES ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const roleDocRef = doc(db, "userRoles", user.uid);
            const roleDocSnap = await getDoc(roleDocRef);

            if (roleDocSnap.exists()) {
                // Es un Asesor o Afiliado
                const roleData = roleDocSnap.data();
                currentUserRole = roleData.role;
                adminUidForRole = roleData.adminUid;
                
                const userRoleDataRef = doc(db, `users/${adminUidForRole}/roles`, user.uid);
                const userRoleDataSnap = await getDoc(userRoleDataRef);
                userRoleData = userRoleDataSnap.exists() ? userRoleDataSnap.data() : {};

                // --- INICIO DE LA SOLUCIÓN ---
                // Precargamos los datos de la empresa ANTES de inicializar la app.
                try {
                    const adminProfileRef = doc(db, "users", adminUidForRole);
                    const adminProfileSnap = await getDoc(adminProfileRef);
                    if (adminProfileSnap.exists()) {
                        // Llenamos la variable global 'companyProfile' con los datos.
                        companyProfile = {
                            ...defaultCompanyProfile,
                            ...(adminProfileSnap.data().companyProfile || {})
                        };
                    }
                } catch (error) {
                    console.error("Error precargando el perfil de la empresa:", error);
                    // Si falla, usamos el perfil por defecto para que la app no se rompa.
                    companyProfile = { ...defaultCompanyProfile };
                }
                // --- FIN DE LA SOLUCIÓN ---

                updateSidebarBranding();
                await initializeAppForUser(); // Ahora esta función ya tendrá los datos listos.
                showView(appContainer);

            } else {
                // Es un Administrador
                currentUserRole = 'admin';
                adminUidForRole = user.uid;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists() && userDocSnap.data().licenseActivated) {
                    await initializeAppForUser();
                    showView(appContainer);
                } else {
                    loader.style.display = 'none';
                    appContainer.style.display = 'none';
                    authContainer.style.display = 'none';
                    modalManager.open('license-modal');
                }
            }
        } else {
            currentUser = null;
            currentUserRole = null;
            adminUidForRole = null;
            unsubscribeAllListeners();
            resetLocalData();
            
            /* === INICIO DE LA SOLUCIÓN: APLICAR TEMA AL CERRAR SESIÓN === */
const savedTheme = localStorage.getItem('userTheme') || 'bosque';
applyTheme(savedTheme);
/* === FIN DE LA SOLUCIÓN === */ 
            
            showView(authContainer);
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('register-view').style.display = 'none';
            if (isDashboardDemoMode) {
                runDashboardDemoPreview();
            }
        }
    });
    
    // --- LÓGICA DE DATOS CON FIRESTORE ---
    async function setupNewUserDocument(user) { const userDocRef = doc(db, "users", user.uid); const batch = writeBatch(db); batch.set(userDocRef, { email: user.email, createdAt: serverTimestamp(), licenseActivated: false, companyProfile: defaultCompanyProfile, settings: defaultSettings }); const advisorRef = doc(collection(userDocRef, "advisors")); batch.set(advisorRef, { id: advisorRef.id, name: 'Asesor Inicial', commissionRate: 10 }); const planRef = doc(collection(userDocRef, "healthPlans")); batch.set(planRef, { id: planRef.id, name: 'Plan de Ejemplo', price: 100000, features: 'Característica 1\nCaracterística 2' }); await batch.commit(); }
    
    async function handleLicenseActivation() {
        const licenseKey = document.getElementById('license-key-input').value.trim();
        const errorMsgElement = document.getElementById('license-error-message');
        const activateBtn = document.getElementById('activate-license-btn');
        activateBtn.disabled = true;
        activateBtn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> Verificando...';
        lucide.createIcons();
        try {
            const licensesRef = collection(db, 'licences');
            const q = query(licensesRef, where("code", "==", licenseKey), where("status", "==", "available"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                setTimeout(() => {
                    errorMsgElement.textContent = 'Código de licencia inválido o ya utilizado.';
                    activateBtn.disabled = false;
                    activateBtn.textContent = 'Activar';
                }, 500);
                return;
            }
            const licenseDoc = querySnapshot.docs[0];
            const batch = writeBatch(db);
            const licenseDocRef = doc(db, 'licences', licenseDoc.id);
            batch.update(licenseDocRef, { status: 'used', usedBy: currentUser.uid, usedAt: serverTimestamp() });
            const userDocRef = doc(db, "users", currentUser.uid);
            batch.set(userDocRef, { licenseActivated: true }, { merge: true });
            await batch.commit();
            showToast('¡Licencia activada con éxito!', 'success');
            modalManager.close('license-modal');
            await initializeAppForUser();
            showView(appContainer);
        } catch (error) {
            console.error("ERROR TÉCNICO durante la activación de la licencia:", error);
            errorMsgElement.textContent = 'Ocurrió un error al verificar. Intenta de nuevo.';
            activateBtn.disabled = false;
            activateBtn.textContent = 'Activar';
        }
    }

    function setupRealtimeListeners() {
        if (!currentUser || !adminUidForRole || activeListeners.length > 0) return;
        
        const basePath = `users/${adminUidForRole}`;

        const unsubUser = onSnapshot(doc(db, basePath), (docSnap) => {
    if (docSnap.exists()) {
        const data = docSnap.data();
        companyProfile = {
            ...defaultCompanyProfile,
            ...(data.companyProfile || {})
        };

        updateCompanyLogoUI(companyProfile.logo || null);
        renderSidebarUserInfo(); // <--- AÑADE LA LLAMADA AQUÍ

                settings = {
                    ...defaultSettings,
                    ...(data.settings || {}),
                    CONTRIBUTION_RATES: {
                        ...defaultSettings.CONTRIBUTION_RATES,
                        ...(data.settings?.CONTRIBUTION_RATES || {})
                    },
                    ARL_RATES: {
                        ...defaultSettings.ARL_RATES,
                        ...(data.settings?.ARL_RATES || {})
                    }
                };
                applyTheme(companyProfile.theme);
                applySidebarTheme(companyProfile.sidebarTheme);
                applyBottomNavTheme(companyProfile.bottomNavTheme);
                updateCompanyLogoUI(companyProfile.logo || null);
                if (document.getElementById('empresa').classList.contains('active')) renderEmpresaSection();
                if (document.getElementById('dashboard').classList.contains('active')) renderDashboard();
            }
        });
        activeListeners.push(unsubUser);

        const collectionsToListen = {
            affiliates: (data) => {
                const oldAffiliates = [...affiliates];
                affiliates = data.map(aff => ({
                    ...aff,
                    createdAt: aff.createdAt?.toDate(),
                    commissionPaid: aff.commissionPaid ?? false,
                    commissionPaidAt: aff.commissionPaidAt?.toDate ? aff.commissionPaidAt.toDate() : (aff.commissionPaidAt ? new Date(aff.commissionPaidAt) : null)
                }));
                renderAllDependentOnAffiliates();
                if (currentUserRole === 'admin') {
                   checkAndGenerateNovedades(data, oldAffiliates); 
                }
            },
            advisors: (data) => {
                advisors = data;
                renderAllDependentOnAdvisors();
            },
            healthPlans: (data) => {
                healthPlans = data;
                renderAllDependentOnPlans();
            },
            manualTransactions: (data) => {
                manualTransactions = data;
                if (document.getElementById('flujo-caja').classList.contains('active')) renderFlujoCajaSection();
            },
            novedades: (data) => {
                novedades = data.sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                updateNovedadesBadge();
                renderNovedadesDropdown();
            },
            roles: (data) => {
                userRoles = data;
                if(document.getElementById('gestion-roles').classList.contains('active')) renderGestionRolesSection();
            }
        };

        for (const [colName, callback] of Object.entries(collectionsToListen)) {
            if (currentUserRole !== 'admin' && ['roles', 'manualTransactions'].includes(colName)) continue;

            const colRef = collection(db, `${basePath}/${colName}`);
            const unsub = onSnapshot(colRef, (snapshot) => {
                const data = snapshot.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                callback(data);
            });
            activeListeners.push(unsub);
        }
    }
    
    function renderAllDependentOnAffiliates() { 
        if(currentUserRole === 'afiliado' && document.getElementById('perfil-afiliado').classList.contains('active')) {
            renderPerfilAfiliadoSection();
            return;
        }
        renderDashboard(); 
        if(currentUserRole === 'admin') {
            renderFlujoCajaSection(); 
            renderAdvisorsSection(); 
            renderRankingSection(); 
            renderCalendarioSection(); 
        }
        if (document.getElementById('afiliados').classList.contains('active')) renderAffiliatesList();
    }
    function renderAllDependentOnAdvisors() { if(currentUserRole !== 'admin') return; populateAdvisorSelect(); renderAdvisorsSection(); renderRankingSection(); if (document.getElementById('afiliados').classList.contains('active')) renderAffiliatesList(); if (document.getElementById('calendario').classList.contains('active')) renderCalendarioSection(); }
    function renderAllDependentOnPlans() { if(currentUserRole === 'admin') renderPlansList(); if (document.getElementById('afiliados').classList.contains('active')) renderAffiliatesList(); if (currentUserRole === 'afiliado' && document.getElementById('perfil-afiliado').classList.contains('active')) renderPerfilAfiliadoSection(); }
    
    function unsubscribeAllListeners() { activeListeners.forEach(unsub => unsub()); activeListeners = []; }
    function resetLocalData() { affiliates = []; advisors = []; manualTransactions = []; novedades = []; healthPlans = []; userRoles = []; companyProfile = {}; settings = {}; lastQuoteResult = null; }
    async function saveDataToFirestore(collectionName, data) { if (!currentUser) return; const docRef = doc(db, `users/${adminUidForRole}/${collectionName}/${data.id}`); await setDoc(docRef, data, { merge: true }); }
    async function deleteDataFromFirestore(collectionName, docId) { if (!currentUser) return; const docRef = doc(db, `users/${adminUidForRole}/${collectionName}/${docId}`); await deleteDoc(docRef); }
    
    async function initializeAppForUser() {
    updateSidebarBranding();
    renderSidebarUserInfo();
    document.getElementById('profile-modal-name').textContent = currentUser.email;
        
        setupRealtimeListeners();
        updateUIVisibilityByRole();

        switch (currentUserRole) {
            case 'admin':
                document.getElementById('profile-modal-role').textContent = 'Administrador';
                document.getElementById('profile-modal-license').style.display = 'inline-block';
                initializeCalendarSelectors();
                renderContent('dashboard');
                break;
            case 'asesor':
                document.getElementById('profile-modal-role').textContent = 'Asesor';
                document.getElementById('profile-modal-license').style.display = 'none';
                renderContent('dashboard');
                break;
            case 'afiliado':
                document.getElementById('profile-modal-role').textContent = 'Afiliado';
                document.getElementById('profile-modal-license').style.display = 'none';
                renderContent('perfil-afiliado');
                break;
        }
    }

// =========================================================================
// INICIO DE LA SOLUCIÓN FINAL v2 - A PRUEBA DE "RACE CONDITIONS"
// =========================================================================

function renderSidebarUserInfo() {
    const userInfoContainer = document.getElementById('sidebar-user-info');
    if (!userInfoContainer) return;

    // ▼▼▼ ¡ESTA ES LA LÍNEA QUE CAMBIA Y LO SOLUCIONA TODO! ▼▼▼
    // ANTES (Poco fiable): const isLightTheme = document.body.getAttribute('data-sidebar-theme') === 'light';
    // AHORA (Robusto): Leemos la configuración directamente desde los datos, no desde el HTML.
    const sidebarTheme = companyProfile.sidebarTheme || 'dark'; // Usamos 'dark' como valor seguro por si algo falla
    const isLightTheme = sidebarTheme === 'light';
    
    // El resto de la lógica no necesita cambios.
    const companyNameColor = isLightTheme ? '' : 'text-white';
    const cardBgClass = isLightTheme ? 'bg-slate-100' : 'bg-white/5';
    const emailColor = isLightTheme ? 'text-slate-500' : 'text-slate-300';
    const borderColor = isLightTheme ? 'border-slate-200' : 'border-slate-700/50';

    const companyName = companyProfile.name || 'Nombre de la Empresa';
    let userRoleText = 'Usuario';
    switch (currentUserRole) {
        case 'admin': userRoleText = 'Administrador'; break;
        case 'asesor': userRoleText = 'Asesor'; break;
        case 'afiliado': userRoleText = 'Afiliado'; break;
    }

    const cardHTML = `
        <div class="${cardBgClass} p-3 rounded-lg">
            <div class="flex items-center gap-2">
                <i data-lucide="building-2" class="w-4 h-4 text-slate-400 flex-shrink-0"></i>
                <p class="text-sm font-bold ${companyNameColor} truncate" title="${companyName}">
                    ${companyName}
                </p>
            </div>
            
            <div class="border-t ${borderColor} my-3"></div>

            <div>
                <p id="user-email-display" class="font-mono text-xs ${emailColor} break-words" title="${currentUser.email}">
                    ${currentUser.email}
                </p>
                <p class="text-xs font-semibold text-primary-600 mt-1">
                    ${userRoleText}
                </p>
            </div>
        </div>

        <button id="logout-btn" class="w-full mt-4 text-left text-sm flex items-center">
            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>Cerrar Sesi&#243;n
        </button>
    `;

    userInfoContainer.innerHTML = cardHTML;
    lucide.createIcons();
}

// =========================================================================
// FIN DE LA SOLUCIÓN FINAL
// =========================================================================
    
// =========================================================================
// INICIO DE LA SOLUCIÓN FINAL Y CORRECTA v3.0
// =========================================================================
function updateUIVisibilityByRole() {
    // 1. Obtenemos referencias a los elementos que queremos controlar.
    const notificacionesBtn = document.getElementById('novedades-toggle-btn');
    const buscadorDesktop = document.getElementById('header-search-container');
    const buscadorMobileBtn = document.getElementById('search-toggle-mobile');
    const elementosHeaderControlados = [notificacionesBtn, buscadorDesktop, buscadorMobileBtn];

    // 2. Reseteamos cualquier estilo en línea que hayamos puesto antes.
    // Esto es CRUCIAL para dejar que las clases de Tailwind funcionen.
    elementosHeaderControlados.forEach(el => {
        if (el) el.style.display = ''; // Un string vacío elimina el estilo en línea.
    });

    // Lógica original para los menús (se mantiene igual)
    document.querySelectorAll('[data-role]').forEach(el => el.style.display = 'none');
    document.querySelectorAll('#sidebar-nav .nav-link, .bottom-nav > a').forEach(el => el.style.display = 'none');

    let visibleTargets = [];

    // 3. Aplicamos la lógica de visibilidad por rol
    if (currentUserRole === 'admin') {
        visibleTargets = ['dashboard', 'empresa', 'calendario', 'flujo-caja', 'afiliados', 'asesores', 'ranking-vendedores', 'planes', 'cotizador', 'gestion-roles'];
        document.querySelectorAll('[data-role="admin"]').forEach(el => el.style.display = '');
    
    } else if (currentUserRole === 'asesor') {
        visibleTargets = ['dashboard', 'afiliados', 'cotizador'];

    } else if (currentUserRole === 'afiliado') {
        // Para el afiliado, OCULTAMOS explícitamente los elementos del header.
        elementosHeaderControlados.forEach(el => {
            if (el) el.style.display = 'none';
        });
        visibleTargets = ['perfil-afiliado', 'cotizador'];
    }

    // Lógica final para mostrar los enlaces de navegación (se mantiene igual)
    document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(el => {
        if (visibleTargets.includes(el.dataset.target)) {
            el.style.display = 'flex';
        }
    });
}
// =========================================================================
// FIN DE LA SOLUCIÓN FINAL
// =========================================================================
    
    function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); }
    function applySidebarTheme(theme) { document.body.setAttribute('data-sidebar-theme', theme || 'dark'); }
    function applyBottomNavTheme(theme) { document.body.setAttribute('data-bottom-nav-theme', theme || 'dark'); }
    async function createNovedad(type, description) { if (!currentUser || currentUserRole !== 'admin') return; const novedad = { type, description, read: false, timestamp: serverTimestamp() }; const collectionRef = collection(db, `users/${adminUidForRole}/novedades`); await addDoc(collectionRef, novedad); }
    function getAffiliateCommissionBase(affiliate) { if (affiliate.manualCosts && Object.values(affiliate.manualCosts).some(cost => cost > 0)) { return Object.values(affiliate.manualCosts).reduce((sum, cost) => sum + (Number(cost) || 0), 0); } const plan = healthPlans.find(p => p.id === affiliate.healthPlan); return plan ? plan.price : 0; }
    function getAdvisorCommissionForAffiliate(affiliate) { if (affiliate.manualCommission && affiliate.manualCommission > 0) { return affiliate.manualCommission; } const advisor = advisors.find(v => v.id === affiliate.advisorId); if (!advisor) return 0; return getAffiliateCommissionBase(affiliate) * (advisor.commissionRate / 100); }
    
    function renderContent(targetId) { 
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active')); 
        const section = document.getElementById(targetId); 
        if (section) { 
            section.classList.add('active'); 
            try { 
                const renderMap = { 
                    'dashboard': renderDashboard, 'afiliados': renderAffiliatesList, 
                    'asesores': renderAdvisorsSection, 'ranking-vendedores': renderRankingSection, 
                    'empresa': renderEmpresaSection, 'flujo-caja': renderFlujoCajaSection, 
                    'planes': renderPlansList, 
                    'calendario': renderCalendarioSection, 'gestion-roles': renderGestionRolesSection,
                    'perfil-afiliado': renderPerfilAfiliadoSection,
                    'cotizador': () => {} 
                }; 
                if(renderMap[targetId]) renderMap[targetId](); 
                lucide.createIcons(); 
            } catch(error) { console.error(`Error rendering ${targetId}:`, error); } 
        } 
    }
    
    function updateViewToggleButtons() { const cardBtn = document.getElementById('view-as-cards-btn'); const tableBtn = document.getElementById('view-as-table-btn'); cardBtn.className = affiliatesViewMode === 'card' ? 'p-2 rounded-lg bg-primary-600 text-white shadow-md' : 'p-2 rounded-lg bg-white hover:bg-slate-100 border text-slate-600'; tableBtn.className = affiliatesViewMode === 'table' ? 'p-2 rounded-lg bg-primary-600 text-white shadow-md' : 'p-2 rounded-lg bg-white hover:bg-slate-100 border text-slate-600'; }
    
    function renderAffiliatesList() {
        const cardContainer = document.getElementById('affiliates-card-container');
        const tableContainer = document.getElementById('affiliates-table-container');
        const searchTerm = document.getElementById('search-affiliate').value.toLowerCase();
        const statusFilter = document.getElementById('filter-affiliate-status').value;
        const paymentStatusFilter = document.getElementById('filter-affiliate-payment-status').value;
        
        let filteredAffiliates = affiliates;
        
        if (currentUserRole === 'asesor' && userRoleData.linkedAdvisorId) {
            filteredAffiliates = affiliates.filter(a => a.advisorId === userRoleData.linkedAdvisorId);
        }

        filteredAffiliates = filteredAffiliates.filter(a =>
            (a.name.toLowerCase().includes(searchTerm) || (a.documentId && a.documentId.includes(searchTerm))) &&
            (statusFilter === 'all' || a.status === statusFilter) &&
            (paymentStatusFilter === 'all' || (a.paymentStatus === (paymentStatusFilter === 'En mora' ? 'En mora' : 'Al día')))
        );
        
        cardContainer.style.display = 'none';
        tableContainer.style.display = 'none';

        if (filteredAffiliates.length === 0) {
            cardContainer.innerHTML = `<div class="col-span-full text-center py-10 bg-white rounded-lg shadow-md"><p class="text-slate-500">No se encontraron afiliados.</p></div>`;
            cardContainer.style.display = 'grid';
            return;
        }

        if (affiliatesViewMode === 'card') {
            renderAffiliatesAsCards(filteredAffiliates);
            cardContainer.style.display = 'grid';
        } else {
            renderAffiliatesAsTable(filteredAffiliates);
            tableContainer.style.display = 'block';
        }
    }
    
    function renderAffiliatesAsCards(filteredData) { const listContainer = document.getElementById('affiliates-card-container'); const statusStyles = { 'Activo': 'bg-green-100 text-green-800', 'Pendiente': 'bg-yellow-100 text-yellow-800', 'Inactivo': 'bg-red-100 text-red-800' }; listContainer.innerHTML = filteredData.map(aff => { const advisor = advisors.find(v => v.id === aff.advisorId); const commission = getAdvisorCommissionForAffiliate(aff); const commissionBase = getAffiliateCommissionBase(aff); const healthPlan = healthPlans.find(p => p.id === aff.healthPlan); 
        const commissionStatus = aff.commissionPaid ? 'Pagada' : 'Pendiente';
        const commissionBadge = aff.commissionPaid ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
        const commissionIcon = aff.commissionPaid ? 'check-circle-2' : 'clock';
        const commissionDateLabel = aff.commissionPaid && aff.commissionPaidAt ? `<span class="block text-xs text-slate-400 mt-1">Pagada el ${formatDateShort(aff.commissionPaidAt)}</span>` : '';
        const nextCommissionStatus = aff.commissionPaid ? 'pending' : 'paid';
        const commissionActionLabel = aff.commissionPaid ? 'Marcar como pendiente' : 'Marcar como pagada';
        const commissionActionIcon = aff.commissionPaid ? 'rotate-ccw' : 'check-circle-2';
        const commissionActionClass = aff.commissionPaid ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200';
        const commissionActionButton = `<button class="toggle-commission-btn inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${commissionActionClass}" data-id="${aff.id}" data-next-status="${nextCommissionStatus}"><i data-lucide="${commissionActionIcon}" class="h-4 w-4"></i>${commissionActionLabel}</button>`;
        const actionsHtml = `
            <div>
                <button class="download-receipt-btn text-slate-500 hover:text-blue-600 p-2 rounded-full" data-id="${aff.id}" title="Descargar Recibo">
                    <i data-lucide="file-down" class="h-5 w-5 pointer-events-none"></i>
                </button>
                <button class="edit-affiliate-btn text-slate-500 hover:text-primary-600 p-2 rounded-full" data-id="${aff.id}" title="Editar">
                    <i data-lucide="pencil" class="h-5 w-5 pointer-events-none"></i>
                </button>
                ${currentUserRole === 'admin' ? `
                <button class="delete-affiliate-btn text-slate-500 hover:text-red-600 p-2 rounded-full" data-id="${aff.id}" title="Eliminar">
                    <i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i>
                </button>` : ''}
            </div>`;
 return ` <div class="bg-white rounded-xl shadow-lg transition hover:shadow-2xl flex flex-col"> <div class="p-5"> <div class="flex justify-between items-start"> <div><h3 class="font-bold text-lg text-slate-800">${aff.name}</h3><p class="text-sm text-slate-500">Doc: ${aff.documentId}</p></div> <div class="flex items-center gap-2 flex-shrink-0 ml-2"><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusStyles[aff.status] || ''}">${aff.status}</span></div> </div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4 text-sm"> <div><strong class="block text-slate-500">Asesor</strong><span>${advisor ? advisor.name : 'N/A'}</span></div> <div><strong class="block text-slate-500">Comisión Mensual</strong><span class="font-bold text-green-600">${formatCurrency(commission)} ${aff.manualCommission ? '<span title="Comisión Manual" class="text-blue-500 font-bold">*</span>' : ''}</span></div> <div><strong class="block text-slate-500">Valor Plan/Base</strong><span>${formatCurrency(commissionBase)} ${aff.manualCosts ? '<span title="Costos Manuales" class="text-blue-500 font-bold">*</span>' : ''}</span></div> <div><strong class="block text-slate-500">Fecha Inicio</strong><span>${formatDateShort(aff.startDate) || "N/A"}</span></div><div><strong class="block text-slate-500">EPS</strong><span>${aff.epsPlan || "N/A"}</span></div> <div class="sm:col-span-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"><div><strong class="block text-slate-500">Estado Comisión</strong><span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full ${commissionBadge}"><i data-lucide="${commissionIcon}" class="h-4 w-4"></i>${commissionStatus}</span>${commissionDateLabel}</div>${commissionActionButton}</div> </div> </div> <div class="details-section hidden p-5 border-t bg-slate-50"> <h4 class="font-semibold mb-2">Detalles Completos:</h4> <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm"> <p><strong class="text-slate-500">Plan:</strong> ${healthPlan ? healthPlan.name : 'N/A'}</p><p><strong class="text-slate-500">EPS:</strong> ${aff.epsPlan || 'N/A'}</p><p><strong class="text-slate-500">Pensión:</strong> ${aff.pensionPlan}</p> <p><strong class="text-slate-500">ARL:</strong> ${aff.arlPlan}</p><p><strong class="text-slate-500">Caja Comp.:</strong> ${aff.ccfPlan}</p> <p class="sm:col-span-2"><strong class="text-slate-500">Notas:</strong> <span class="whitespace-pre-wrap">${aff.notes || 'N/A'}</span></p> </div> </div> <div class="border-t p-3 mt-auto flex justify-between items-center bg-gray-50/50 rounded-b-xl"> <button data-toggle-details="${aff.id}" class="text-sm text-primary-600 font-semibold hover:text-primary-700 flex items-center">Ver Detalles<i data-lucide="chevron-down" class="details-toggle-icon h-5 w-5 ml-1"></i></button> ${actionsHtml} </div> </div>`; }).join(''); lucide.createIcons(); }
    function renderAffiliatesAsTable(filteredData) { const tableBody = document.getElementById('affiliates-table-body'); const statusStyles = { 'Activo': 'bg-green-100 text-green-800', 'Pendiente': 'bg-yellow-100 text-yellow-800', 'Inactivo': 'bg-red-100 text-red-800' }; tableBody.innerHTML = filteredData.map(aff => { const advisor = advisors.find(v => v.id === aff.advisorId); const healthPlan = healthPlans.find(p => p.id === aff.healthPlan); const commissionBadge = aff.commissionPaid ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'; const commissionIcon = aff.commissionPaid ? 'check-circle-2' : 'clock'; const commissionStatus = aff.commissionPaid ? 'Pagada' : 'Pendiente'; const commissionDateLabel = aff.commissionPaid && aff.commissionPaidAt ? `<div class="text-xs text-slate-500">Pagada el ${formatDateShort(aff.commissionPaidAt)}</div>` : ''; const nextCommissionStatus = aff.commissionPaid ? 'pending' : 'paid'; const commissionActionLabel = aff.commissionPaid ? 'Marcar como pendiente' : 'Marcar como pagada'; const commissionActionIcon = aff.commissionPaid ? 'rotate-ccw' : 'check-circle-2'; const commissionActionClass = aff.commissionPaid ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'; const commissionActionButton = `<button class="toggle-commission-btn inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold ${commissionActionClass}" data-id="${aff.id}" data-next-status="${nextCommissionStatus}"><i data-lucide="${commissionActionIcon}" class="h-4 w-4"></i>${commissionActionLabel}</button>`; const actionsHtml = currentUserRole === 'admin' ? `<button class="edit-affiliate-btn text-slate-500 hover:text-primary-600 p-2 rounded-full" data-id="${aff.id}" title="Editar"><i data-lucide="pencil" class="h-4 w-4 pointer-events-none"></i></button> <button class="delete-affiliate-btn text-slate-500 hover:text-red-600 p-2 rounded-full" data-id="${aff.id}" title="Eliminar"><i data-lucide="trash-2" class="h-4 w-4 pointer-events-none"></i></button>` : `<button class="edit-affiliate-btn text-slate-500 hover:text-primary-600 p-2 rounded-full" data-id="${aff.id}" title="Editar"><i data-lucide="pencil" class="h-4 w-4 pointer-events-none"></i></button>`; return ` <tr class="hover:bg-slate-50"> <td class="p-3"><div class="font-semibold text-slate-800">${aff.name}</div><div class="text-xs text-slate-500">Doc: ${aff.documentId}</div></td> <td class="p-3"><div class="text-slate-800">${healthPlan ? healthPlan.name : 'N/A'}</div><div class="text-xs text-slate-500">Asesor: ${advisor ? advisor.name : 'N/A'}</div><div class="text-xs text-slate-500 mt-1">EPS: ${aff.epsPlan || 'N/A'}</div></td> <td class="p-3"><div class="text-slate-800 break-all">${aff.email || 'N/A'}</div><div class="text-xs text-slate-500">${aff.phone || 'N/A'}</div></td> <td class="p-3"><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusStyles[aff.status] || ''}">${aff.status}</span><div class="text-xs text-slate-500 mt-1">Inicio: ${formatDateShort(aff.startDate) || "N/A"}</div><div class="mt-2 flex flex-col gap-1"><span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full ${commissionBadge}"><i data-lucide="${commissionIcon}" class="h-4 w-4"></i>${commissionStatus}</span>${commissionDateLabel}</div></td> <td class="p-3 text-center"><div class="flex flex-col items-center gap-2">${commissionActionButton}<div class="flex items-center gap-2">${actionsHtml}</div></div></td> </tr>`; }).join(''); lucide.createIcons(); }
    function renderAdvisorsSection() {
        const container = document.getElementById("advisors-container");
        if (!container) return;
        if (advisors.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 col-span-full">No hay asesores registrados.</p>';
            return;
        }
        const statusStyles = { 'Activo': "bg-green-100 text-green-800", 'Pendiente': "bg-yellow-100 text-yellow-800", 'Inactivo': "bg-red-100 text-red-800", };
        container.innerHTML = advisors.map((advisor) => {
            const affs = affiliates.filter((a) => a.advisorId === advisor.id);
            const activeAffs = affs.filter((a) => a.status === "Activo");
            const totalCommission = affs.reduce((sum, a) => sum + getAdvisorCommissionForAffiliate(a), 0);
            const commissionTotals = activeAffs.reduce((acc, affiliate) => {
                const commissionValue = getAdvisorCommissionForAffiliate(affiliate);
                acc.total += commissionValue;
                if (affiliate.commissionPaid) acc.paid += commissionValue;
                else acc.pending += commissionValue;
                return acc;
            }, { total: 0, paid: 0, pending: 0 });
            const hasAffiliates = affs.length > 0;
            const breakdownHtml = hasAffiliates ? affs.map((aff) => {
                const commission = getAdvisorCommissionForAffiliate(aff);
                const commissionPaid = !!aff.commissionPaid;
                const statusBadgeClass = commissionPaid ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
                const statusIcon = commissionPaid ? 'check-circle-2' : 'clock';
                const commissionStatusLabel = commissionPaid ? 'Pagada' : 'Pendiente';
                const nextStatus = commissionPaid ? 'pending' : 'paid';
                const actionLabel = commissionPaid ? 'Marcar como pendiente' : 'Marcar como pagada';
                const actionIcon = commissionPaid ? 'rotate-ccw' : 'check-circle-2';
                const actionClass = commissionPaid ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200';
                const paidDate = commissionPaid && aff.commissionPaidAt ? `<p class="text-[10px] text-slate-500">Pagada el ${formatDateShort(aff.commissionPaidAt)}</p>` : '';
                return `<tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-100"><td class="p-2 font-medium text-slate-800">${aff.name}</td><td class="p-2"><span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusStyles[aff.status] || ""}">${aff.status}</span></td><td class="p-2 text-right font-mono text-green-700">${formatCurrency(commission)}</td><td class="p-2 text-right"><div class="flex flex-col items-end gap-1"><span class="inline-flex items-center gap-1 text-[11px] font-semibold px-2 py-0.5 rounded-full ${statusBadgeClass}"><i data-lucide="${statusIcon}" class="h-3 w-3"></i>${commissionStatusLabel}</span>${paidDate}<button class="toggle-commission-btn inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ${actionClass}" data-id="${aff.id}" data-next-status="${nextStatus}"><i data-lucide="${actionIcon}" class="h-4 w-4"></i>${actionLabel}</button></div></td></tr>`;
            }).join("") : `<tr><td colspan="4" class="text-center p-4 text-slate-500">Este asesor no tiene afiliados.</td></tr>`;
            return `
            <div class="bg-white rounded-xl shadow-lg flex flex-col transition hover:shadow-2xl">
                <div class="p-5 flex justify-between items-start">
                    <div><h3 class="font-bold text-xl text-slate-800">${advisor.name}</h3><p class="text-sm text-primary-600 font-semibold">Comisión Base: ${advisor.commissionRate}%</p></div>
                    <div class="flex-shrink-0"><button class="edit-advisor-btn text-slate-500 hover:text-primary-600 p-2 rounded-full" data-id="${advisor.id}"><i data-lucide="pencil" class="h-5 w-5 pointer-events-none"></i></button><button class="delete-advisor-btn text-slate-500 hover:text-red-600 p-2 rounded-full" data-id="${advisor.id}"><i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i></button></div>
                </div>
                <div class="p-5 grid grid-cols-2 md:grid-cols-4 gap-4 text-center border-y">
                    <div><p class="text-3xl font-bold text-slate-700">${affs.length}</p><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Afiliados</p></div>
                    <div><p class="text-xl font-bold text-emerald-600">${formatCurrency(commissionTotals.paid, 0)}</p><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Comisión Pagada (Mes)</p></div>
                    <div><p class="text-xl font-bold text-amber-600">${formatCurrency(commissionTotals.pending, 0)}</p><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Comisión Pendiente (Mes)</p></div>
                    <div><p class="text-xl font-bold text-green-600">${formatCurrency(totalCommission, 0)}</p><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">Comisión Total Generada</p></div>
                </div>
                <div id="advisor-stats-${advisor.id}" class="hidden">
                    <div class="p-4 bg-slate-50"><h4 class="font-semibold mb-3 text-slate-700 text-sm">Desglose de Afiliados</h4><div class="max-h-64 overflow-y-auto pr-1"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-200 sticky top-0"><tr><th class="p-2 font-semibold">Afiliado</th><th class="p-2 font-semibold">Estado</th><th class="p-2 font-semibold text-right">Ganancia</th><th class="p-2 font-semibold text-right">Pago Comisión</th></tr></thead><tbody class="bg-white">${breakdownHtml}</tbody></table></div></div>
                </div>
                <div class="mt-auto border-t p-3 flex justify-end items-center bg-gray-50/50 rounded-b-xl"><button ${hasAffiliates ? "" : "disabled"} data-toggle-stats="${advisor.id}" class="stats-toggle-btn text-sm text-primary-600 font-semibold hover:text-primary-700 flex items-center disabled:opacity-50 disabled:cursor-not-allowed"><span class="button-text">Ver Desglose</span><i data-lucide="chevron-down" class="stats-toggle-icon h-5 w-5 ml-1"></i></button></div>
            </div>`;
        }).join("");
        lucide.createIcons();
    }
    function renderRankingSection(){const e=document.getElementById("ranking-list");if(!e)return;const t=advisors.map(e=>{const t=affiliates.filter(t=>t.advisorId===e.id).reduce((e,t)=>e+getAdvisorCommissionForAffiliate(t),0);return{...e,totalCommission:t}});if(t.sort((e,t)=>t.totalCommission-e.totalCommission),0===t.length){e.innerHTML='<div class="text-center py-10 bg-white rounded-lg shadow-md"><p class="text-slate-500">No hay asesores para mostrar en el ranking.</p></div>';return}const a=["bg-amber-400 text-amber-900","bg-slate-300 text-slate-800","bg-orange-400 text-orange-900"],n=['<i data-lucide="trophy" class="w-6 h-6 text-amber-500"></i>','<i data-lucide="award" class="w-6 h-6 text-slate-500"></i>','<i data-lucide="medal" class="w-6 h-6 text-orange-500"></i>'];e.innerHTML=t.map((e,t)=>{const o=t+1,s=3>=o?a[t]:"bg-slate-200 text-slate-700",i=3>=o?n[t]:`<span class="font-bold text-lg">${o}</span>`;return` <div class="bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4 transition hover:shadow-xl hover:scale-[1.02]"> <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center ${s}">${i}</div> <div class="flex-grow"> <h3 class="font-bold text-lg text-slate-800">${e.name}</h3> <p class="text-sm text-slate-500">Comisión Base: ${e.commissionRate}%</p> </div> <div class="text-right"> <p class="text-xl font-extrabold text-green-600">${formatCurrency(e.totalCommission)}</p> <p class="text-xs font-medium text-slate-500 uppercase">Comisión Total</p> </div> </div>`}).join("");}
    function renderPlansList(){const e=document.getElementById("plans-list");if(!e)return;if(0===healthPlans.length){e.innerHTML='<div class="col-span-full text-center py-10 bg-white rounded-lg shadow-md"><p class="text-slate-500">No hay planes de salud creados. ¡Añade el primero!</p></div>';return}e.innerHTML=healthPlans.map(e=>` <div class="bg-white rounded-xl shadow-lg flex flex-col"> <div class="p-5 flex-grow"> <div class="flex justify-between items-start"><h3 class="font-bold text-lg text-slate-800">${e.name}</h3><p class="text-xl font-extrabold text-primary-600">${formatCurrency(e.price)}</p></div> <ul class="text-sm text-slate-600 space-y-1 mt-4"> ${e.features.split("\n").map(e=>`<li class="flex items-start"><i data-lucide="check-circle-2" class="w-4 h-4 mr-2 text-green-500 mt-0.5 flex-shrink-0"></i><span>${e}</span></li>`).join("")} </ul> </div> <div class="border-t p-3 flex justify-end items-center bg-gray-50/50 rounded-b-xl"> <button class="edit-plan-btn text-slate-500 hover:text-primary-600 p-2 rounded-full" data-id="${e.id}"><i data-lucide="pencil" class="h-5 w-5 pointer-events-none"></i></button> <button class="delete-plan-btn text-slate-500 hover:text-red-600 p-2 rounded-full" data-id="${e.id}"><i data-lucide="trash-2" class="h-5 w-5 pointer-events-none"></i></button> </div> </div>`).join("");}
    function populateAdvisorSelect(){const e=document.getElementById("advisor-select-list");e&&(e.innerHTML='<option value="" disabled selected>Asignar Asesor</option>'+advisors.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""))}
    
    function renderAsesorDashboard() {
        if (!userRoleData.linkedAdvisorId) return;

        destroyDashboardPerformanceChart();

        const relevantAffiliates = affiliates.filter(a => a.advisorId === userRoleData.linkedAdvisorId);
        const activeAffiliates = relevantAffiliates.filter(a => a.status === 'Activo');
        const totalAffiliates = relevantAffiliates.length;
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const startOfPreviousMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const endOfPreviousMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);

        const monthlyNewAffiliates = relevantAffiliates.filter(aff => aff.createdAt && aff.createdAt >= startOfMonth && aff.createdAt <= now);
        const previousMonthNewAffiliates = relevantAffiliates.filter(aff => aff.createdAt && aff.createdAt >= startOfPreviousMonth && aff.createdAt <= endOfPreviousMonth);

        const recurringRevenue = activeAffiliates.reduce((sum, aff) => sum + getAffiliateCommissionBase(aff), 0);
        const monthlyCommissions = activeAffiliates.reduce((sum, aff) => sum + getAdvisorCommissionForAffiliate(aff), 0);
        const adminFee = settings?.ADMIN_FEE_PER_AFFILIATE ?? defaultSettings.ADMIN_FEE_PER_AFFILIATE;
        const adminNetProfit = monthlyNewAffiliates.length * adminFee;
        const growthRate = previousMonthNewAffiliates.length > 0
            ? ((monthlyNewAffiliates.length - previousMonthNewAffiliates.length) / previousMonthNewAffiliates.length) * 100
            : (monthlyNewAffiliates.length > 0 ? 100 : 0);
        const retentionRate = totalAffiliates > 0 ? (activeAffiliates.length / totalAffiliates) * 100 : 0;
        const averageTicket = activeAffiliates.length > 0 ? recurringRevenue / activeAffiliates.length : 0;
        const overdueAffiliates = relevantAffiliates.filter(a => a.paymentStatus === 'En mora');
        const overdueValue = overdueAffiliates.reduce((sum, aff) => sum + getAffiliateCommissionBase(aff), 0);
        const overdueCount = overdueAffiliates.length;

        setKpiLabel('monthly-income', 'Ingresos de mi cartera');
        setKpiLabel('admin-net-profit', 'Ganancia admin neta (mi cartera)');
        setKpiLabel('net-profit', 'Comisiones del mes');
        setKpiLabel('new-affiliates', 'Afiliados nuevos');
        setKpiLabel('active-affiliates', 'Afiliados activos');
        setKpiLabel('overdue-payments', 'Cartera por recuperar');

        updateTextContent('dashboard-hero-name', 'Equipo Comercial');
        updateTextContent('dashboard-hero-subtitle', 'Seguimiento de tus afiliados y comisiones en tiempo real.');
        updateTextContent('dashboard-hero-active', activeAffiliates.length);
        updateTextContent('dashboard-hero-projected', formatCurrency(recurringRevenue));

        updateTextContent('kpi-monthly-income', formatCurrency(recurringRevenue));
        updateTextContent('kpi-admin-net-profit', formatCurrency(adminNetProfit));
        updateTextContent('kpi-net-profit', formatCurrency(monthlyCommissions));
        updateTextContent('kpi-new-affiliates', monthlyNewAffiliates.length);
        updateTextContent('kpi-active-affiliates', activeAffiliates.length);
        updateTextContent('kpi-overdue-payments', formatCurrency(overdueValue));

        updateTextContent('dashboard-net-label', 'Ingresos recurrentes estimados');
        updateTextContent('dashboard-net-description', 'Basados en tu cartera activa actual.');
        updateTextContent('dashboard-expense-label', 'Comisiones proyectadas');
        updateTextContent('dashboard-expense-description', 'Valor aproximado de tus comisiones actuales.');
        updateTextContent('dashboard-net-cashflow', formatCurrency(recurringRevenue));
        updateTextContent('dashboard-monthly-expenses', formatCurrency(monthlyCommissions));

        updateGrowthIndicator(growthRate);
        updateTextContent('dashboard-retention-rate', formatPercentage(retentionRate));
        updateTextContent('dashboard-average-ticket', formatCurrency(averageTicket));
        updateTextContent('dashboard-overdue-count', `${overdueCount} afiliados`);
        updateTextContent('dashboard-overdue-value', formatCurrency(overdueValue));
        updateTextContent('dashboard-monthly-new', monthlyNewAffiliates.length);
        const advisorDelta = monthlyNewAffiliates.length - previousMonthNewAffiliates.length;
        updateTextContent('dashboard-monthly-new-delta', `${advisorDelta > 0 ? '+' : ''}${advisorDelta} vs. mes anterior`);

        document.querySelectorAll('#dashboard [data-role="admin-only"]').forEach(el => el.classList.add('hidden'));
        lucide.createIcons();
    }

    function renderDashboard() {
        const dashboardSection = document.getElementById('dashboard');
        if (!dashboardSection) return;

        if (currentUserRole === 'asesor') {
            renderAsesorDashboard();
            return;
        }

        document.querySelectorAll('#dashboard [data-role="admin-only"]').forEach(el => el.classList.remove('hidden'));

        setKpiLabel('monthly-income', 'Ingresos del mes');
        setKpiLabel('admin-net-profit', 'Ganancia administrativa neta');
        setKpiLabel('net-profit', 'Resultado neto (mes)');
        setKpiLabel('new-affiliates', 'Nuevos afiliados');
        setKpiLabel('active-affiliates', 'Afiliados activos');
        setKpiLabel('overdue-payments', 'Cartera vencida');

        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const startOfPreviousMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const endOfPreviousMonth = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59, 999);

        const activeAffiliates = affiliates.filter(a => a.status === 'Activo');
        const totalAffiliates = affiliates.length;
        const monthlyNewAffiliates = affiliates.filter(aff => aff.createdAt && aff.createdAt >= startOfMonth && aff.createdAt <= now);
        const previousMonthNewAffiliates = affiliates.filter(aff => aff.createdAt && aff.createdAt >= startOfPreviousMonth && aff.createdAt <= endOfPreviousMonth);

        const transactions = getAllTransactions();
        const filterTransactionsByPeriod = (collection, month, year) => collection.filter(item => {
            const parsedDate = getComparableDate(item.date);
            return parsedDate && parsedDate.getMonth() === month && parsedDate.getFullYear() === year;
        });

        const sumByType = (collection, type) => collection
            .filter(item => item.type === type)
            .reduce((sum, item) => sum + (item.amount || 0), 0);

        const monthlyTransactions = filterTransactionsByPeriod(transactions, now.getMonth(), now.getFullYear());
        const previousMonthTransactions = filterTransactionsByPeriod(transactions, startOfPreviousMonth.getMonth(), startOfPreviousMonth.getFullYear());

        const monthlyIncome = sumByType(monthlyTransactions, 'ingreso');
        const monthlyExpenses = sumByType(monthlyTransactions, 'egreso');
        const netCashflow = monthlyIncome - monthlyExpenses;
        const adminFee = settings?.ADMIN_FEE_PER_AFFILIATE ?? defaultSettings.ADMIN_FEE_PER_AFFILIATE;
        const adminNetProfit = monthlyNewAffiliates.length * adminFee;

        const previousIncome = sumByType(previousMonthTransactions, 'ingreso');
        const previousExpenses = sumByType(previousMonthTransactions, 'egreso');
        const previousNetCashflow = previousIncome - previousExpenses;
        const growthRate = previousNetCashflow !== 0
            ? ((netCashflow - previousNetCashflow) / Math.abs(previousNetCashflow)) * 100
            : (netCashflow !== 0 ? 100 : 0);

        const recurringRevenue = activeAffiliates.reduce((sum, aff) => sum + getAffiliateCommissionBase(aff), 0);
        const retentionRate = totalAffiliates > 0 ? (activeAffiliates.length / totalAffiliates) * 100 : 0;
        const averageTicket = activeAffiliates.length > 0 ? recurringRevenue / activeAffiliates.length : 0;
        const overdueAffiliates = affiliates.filter(a => a.paymentStatus === 'En mora');
        const overdueValue = overdueAffiliates.reduce((sum, aff) => sum + getAffiliateCommissionBase(aff), 0);
        const overdueCount = overdueAffiliates.length;

        const advisorPerformance = advisors.map(advisor => {
            const advisorAffiliates = affiliates.filter(aff => aff.advisorId === advisor.id && aff.status === 'Activo');
            const totalCommission = advisorAffiliates.reduce((sum, aff) => sum + getAdvisorCommissionForAffiliate(aff), 0);
            return {
                advisor,
                commission: totalCommission
            };
        }).filter(entry => entry.commission > 0)
        .sort((a, b) => b.commission - a.commission);

        const topAdvisorData = advisorPerformance[0] || null;

        updateTextContent('dashboard-hero-name', companyProfile.name ? `Equipo ${companyProfile.name}` : 'Equipo Seb Salud');
        updateTextContent('dashboard-hero-subtitle', 'Monitorea el pulso de la operación y actúa con anticipación.');
        updateTextContent('dashboard-hero-active', activeAffiliates.length);
        updateTextContent('dashboard-hero-projected', formatCurrency(recurringRevenue));

        updateTextContent('kpi-monthly-income', formatCurrency(monthlyIncome));
        updateTextContent('kpi-admin-net-profit', formatCurrency(adminNetProfit));
        updateTextContent('kpi-net-profit', formatCurrency(netCashflow));
        updateTextContent('kpi-new-affiliates', monthlyNewAffiliates.length);
        updateTextContent('kpi-active-affiliates', activeAffiliates.length);
        updateTextContent('kpi-overdue-payments', formatCurrency(overdueValue));

        updateTextContent('dashboard-net-label', 'Resultado neto mensual');
        updateTextContent('dashboard-net-description', 'Ingresos menos egresos para el periodo seleccionado.');
        updateTextContent('dashboard-expense-label', 'Egresos totales del mes');
        updateTextContent('dashboard-expense-description', 'Incluye comisiones a asesores y egresos manuales.');
        updateTextContent('dashboard-net-cashflow', formatCurrency(netCashflow));
        updateTextContent('dashboard-monthly-expenses', formatCurrency(monthlyExpenses));

        updateGrowthIndicator(growthRate);
        updateTextContent('dashboard-retention-rate', formatPercentage(retentionRate));
        updateTextContent('dashboard-average-ticket', formatCurrency(averageTicket));
        updateTextContent('dashboard-overdue-count', `${overdueCount} afiliados`);
        updateTextContent('dashboard-overdue-value', formatCurrency(overdueValue));
        updateTextContent('dashboard-monthly-new', monthlyNewAffiliates.length);
        const newDelta = monthlyNewAffiliates.length - previousMonthNewAffiliates.length;
        updateTextContent('dashboard-monthly-new-delta', `${newDelta > 0 ? '+' : ''}${newDelta} vs. mes anterior`);

        if (topAdvisorData) {
            updateTextContent('dashboard-top-advisor', topAdvisorData.advisor.name);
            updateTextContent('dashboard-top-advisor-commission', formatCurrency(topAdvisorData.commission));
        } else {
            updateTextContent('dashboard-top-advisor', 'Sin datos');
            updateTextContent('dashboard-top-advisor-commission', '$0');
        }

        lucide.createIcons();
    }

    function runDashboardDemoPreview() {
        if (dashboardDemoInitialized) return;
        dashboardDemoInitialized = true;

        const now = new Date();
        const monthOffsets = [5, 4, 3, 2, 1, 0];

        currentUser = { email: 'demo@sebsalud.com' };
        currentUserRole = 'admin';
        adminUidForRole = 'demo-admin';
        userRoleData = {};

        companyProfile = {
            ...defaultCompanyProfile,
            name: 'Seb Salud Administración',
            theme: 'bosque',
            sidebarTheme: 'dark',
            bottomNavTheme: 'dark'
        };

        settings = { ...defaultSettings };

        advisors = [
            { id: 'adv-1', name: 'Laura Gómez', commissionRate: 12 },
            { id: 'adv-2', name: 'Miguel Rojas', commissionRate: 10 }
        ];

        healthPlans = [
            { id: 'plan-premium', name: 'Plan Premium', price: 320000 },
            { id: 'plan-empresarial', name: 'Plan Empresarial', price: 410000 }
        ];

        affiliates = [
            {
                id: 'aff-1',
                name: 'Carlos Pérez',
                status: 'Activo',
                paymentStatus: 'Al día',
                startDate: new Date(now.getFullYear(), now.getMonth() - 5, 4).toISOString(),
                createdAt: new Date(now.getFullYear(), now.getMonth() - 5, 4),
                advisorId: 'adv-1',
                healthPlan: 'plan-premium',
                commissionPaid: true,
                commissionPaidAt: new Date(now.getFullYear(), now.getMonth() - 1, 20)
            },
            {
                id: 'aff-2',
                name: 'Daniela Rodríguez',
                status: 'Activo',
                paymentStatus: 'Al día',
                startDate: new Date(now.getFullYear(), now.getMonth() - 3, 11).toISOString(),
                createdAt: new Date(now.getFullYear(), now.getMonth() - 3, 11),
                advisorId: 'adv-2',
                healthPlan: 'plan-empresarial',
                commissionPaid: false,
                commissionPaidAt: null
            },
            {
                id: 'aff-3',
                name: 'María Fernanda',
                status: 'Activo',
                paymentStatus: 'En mora',
                startDate: new Date(now.getFullYear(), now.getMonth() - 2, 6).toISOString(),
                createdAt: new Date(now.getFullYear(), now.getMonth() - 2, 6),
                advisorId: 'adv-1',
                healthPlan: 'plan-empresarial',
                commissionPaid: false,
                commissionPaidAt: null
            },
            {
                id: 'aff-4',
                name: 'Roberto Pineda',
                status: 'Activo',
                paymentStatus: 'Al día',
                startDate: new Date(now.getFullYear(), now.getMonth() - 1, 14).toISOString(),
                createdAt: new Date(now.getFullYear(), now.getMonth() - 1, 14),
                advisorId: 'adv-2',
                healthPlan: 'plan-premium',
                commissionPaid: true,
                commissionPaidAt: new Date(now.getFullYear(), now.getMonth() - 1, 28)
            }
        ];

        manualTransactions = monthOffsets.flatMap((offset) => {
            const incomeDate = new Date(now.getFullYear(), now.getMonth() - offset, 12, 10, 30);
            const expenseDate = new Date(now.getFullYear(), now.getMonth() - offset, 24, 14, 15);
            return [
                {
                    id: `demo-income-${offset}`,
                    type: 'ingreso',
                    concept: 'Ingresos recurrentes',
                    amount: 4800000 + offset * 140000,
                    date: incomeDate.toISOString()
                },
                {
                    id: `demo-expense-${offset}`,
                    type: 'egreso',
                    concept: 'Operación y comisiones',
                    amount: 1950000 + offset * 90000,
                    date: expenseDate.toISOString()
                }
            ];
        });

        novedades = [];
        userRoles = [];

        applyTheme(companyProfile.theme);
        applySidebarTheme(companyProfile.sidebarTheme);
        applyBottomNavTheme(companyProfile.bottomNavTheme);
        updateSidebarBranding();

        showView(appContainer);
        updateUIVisibilityByRole();

        const profileRole = document.getElementById('profile-modal-role');
        if (profileRole) profileRole.textContent = 'Administrador';
        const profileLicense = document.getElementById('profile-modal-license');
        if (profileLicense) profileLicense.style.display = 'inline-block';
        const profileName = document.getElementById('profile-modal-name');
        if (profileName) profileName.textContent = currentUser.email;

        renderSidebarUserInfo();
        renderContent('dashboard');
        renderDashboard();
    }
    
    function calculateContributions(income, contractType, arlLevel, selectedComponents) { if (!settings.SMMLV || !income || income <= 0) return null; const ibc = Math.max(0.4 * income, settings.SMMLV); let results = { ibc: ibc, grandTotal: 0, health: null, pension: null, arl: null, ccf: null }; const rates = settings.CONTRIBUTION_RATES; const arlRates = settings.ARL_RATES; if (selectedComponents.health) { results.health = { total: ibc * (rates.health / 100) }; if (contractType === 'independiente') { results.health.details = `Aporte total (${rates.health}%)`; } else { results.health.details = `Empleado (${rates.employee_health}%): ${formatCurrency(ibc * (rates.employee_health / 100))} | Empleador (${rates.employer_health}%): ${formatCurrency(ibc * (rates.employer_health / 100))}`; } results.grandTotal += results.health.total; } if (selectedComponents.pension) { results.pension = { total: ibc * (rates.pension / 100) }; if (contractType === 'independiente') { results.pension.details = `Aporte total (${rates.pension}%)`; } else { results.pension.details = `Empleado (${rates.employee_pension}%): ${formatCurrency(ibc * (rates.employee_pension / 100))} | Empleador (${rates.employer_pension}%): ${formatCurrency(ibc * (rates.employer_pension / 100))}`; } results.grandTotal += results.pension.total; } if (selectedComponents.arl) { results.arl = { total: ibc * (arlRates[arlLevel] / 100), details: `A cargo del contratante/empleador (${arlRates[arlLevel]}%)` }; results.grandTotal += results.arl.total; } if (selectedComponents.ccf) { const ccfRate = contractType === 'independiente' ? rates.independiente_ccf : rates.employer_ccf; results.ccf = { total: ibc * (ccfRate / 100), details: contractType === 'independiente' ? `Aporte voluntario (${ccfRate}%)` : `A cargo del empleador (${ccfRate}%)` }; results.grandTotal += results.ccf.total; } return results; }

    function renderCalculatorResults(results) {
        const breakdownContainer = document.getElementById("calculator-results-breakdown");
        const placeholder = document.getElementById("quote-placeholder");
        const summaryContainer = document.getElementById("quote-summary");
        const actionsContainer = document.getElementById('quote-actions-container');

        if (!results) {
            resetCalculatorState();
            return;
        }

        placeholder.style.display = 'none';
        summaryContainer.classList.remove('hidden');
        summaryContainer.classList.add('grid');

        // Mostrar acciones solo para admin y asesor
        if (currentUserRole === 'admin' || currentUserRole === 'asesor') {
            actionsContainer.classList.remove('hidden');
        } else {
            actionsContainer.classList.add('hidden');
        }

        document.getElementById("ibc-value").textContent = formatCurrency(results.ibc);
        document.getElementById("grand-total").textContent = formatCurrency(results.grandTotal);

        const componentMap = {
            health:  { title: "Salud (EPS)", icon: "heart-pulse", color: "rose" },
            pension: { title: "Pensión", icon: "landmark", color: "amber" },
            arl:     { title: "Riesgos Laborales (ARL)", icon: "hard-hat", color: "sky" },
            ccf:     { title: "Caja de Compensación", icon: "boxes", color: "indigo" }
        };

        let htmlOutput = [];
        for (const [key, config] of Object.entries(componentMap)) {
            if (results[key]) {
                htmlOutput.push(`
                    <div class="flex items-start gap-4 p-4 bg-slate-50 rounded-lg border">
                        <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-${config.color}-100 text-${config.color}-600 flex items-center justify-center">
                            <i data-lucide="${config.icon}" class="h-5 w-5"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-700">${config.title}</p>
                            <p class="text-xs text-slate-500">${results[key].details}</p>
                        </div>
                        <p class="font-bold text-lg text-slate-800 whitespace-nowrap">${formatCurrency(results[key].total)}</p>
                    </div>
                `);
            }
        }
        breakdownContainer.innerHTML = htmlOutput.join('');
        lucide.createIcons();
    }
    
    function resetCalculatorState() {
        const calculatorForm = document.getElementById('calculator-form');
        const calculateBtn = document.getElementById('calculate-btn');
        const newQuoteBtn = document.getElementById('new-quote-btn');
        const breakdownContainer = document.getElementById("calculator-results-breakdown");
        const placeholder = document.getElementById("quote-placeholder");
        const summaryContainer = document.getElementById("quote-summary");
        const actionsContainer = document.getElementById('quote-actions-container');

        lastQuoteResult = null;
        calculatorForm.reset();
        
        document.querySelectorAll('#calculator-fieldset-1, #calculator-fieldset-2').forEach(fs => fs.disabled = false);
        
        newQuoteBtn.style.display = 'none';
        calculateBtn.style.display = 'flex';
        calculateBtn.disabled = false;
        calculateBtn.innerHTML = '<i data-lucide="calculator" class="w-5 h-5 mr-2"></i>Cotizar Aportes';
        
        breakdownContainer.innerHTML = '';
        placeholder.style.display = 'block';
        summaryContainer.classList.add('hidden');
        summaryContainer.classList.remove('grid');
        actionsContainer.classList.add('hidden');
        
        document.querySelectorAll('.component-checkbox').forEach(cb => cb.checked = true);
        document.getElementById('select-all-components').checked = true;

        lucide.createIcons();
    }

    function renderHealthPlanCards(){const e=document.getElementById("health-plan-selector");if(!e)return;if(0===healthPlans.length){e.innerHTML='<p class="text-slate-500 md:col-span-4">No hay planes de salud definidos. Por favor, cree un plan en la sección "Planes de Salud".</p>';return}e.innerHTML=healthPlans.map((e,t)=>` <label class="health-plan-card cursor-pointer rounded-lg p-4 flex flex-col justify-between"> <div> <div class="flex justify-between items-center"><h4 class="font-bold text-md text-slate-800">${e.name}</h4><input type="radio" name="health-plan" value="${e.id}" class="h-4 w-4 text-primary-600"></div> <p class="text-xl font-extrabold text-primary-600 my-2">${formatCurrency(e.price)}<span class="text-sm font-medium text-slate-500">/mes</span></p> <ul class="text-xs text-slate-600 space-y-1 mt-3"> ${e.features.split("\n").map(e=>`<li class="flex items-start"><i data-lucide="check" class="w-3.5 h-3.5 mr-2 text-green-500 mt-0.5 flex-shrink-0"></i><span>${e}</span></li>`).join("")} </ul> </div> </label>`).join("");}
    
    function renderNovedadesDropdown(){
        const container = document.getElementById("novedades-list");
        if (!container) return;

        if (novedades.length === 0) {
            container.innerHTML = '<p class="text-center text-sm text-slate-500 p-4">No hay notificaciones.</p>';
            return;
        }

        container.innerHTML = novedades.map(novedad => `
            <div class="flex items-start gap-3 p-2 rounded-lg hover:bg-slate-50">
                ${novedad.read === false ? '<div class="w-2 h-2 rounded-full bg-blue-500 mt-2 flex-shrink-0"></div>' : '<div class="w-2 h-2"></div>'}
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center">${getNovedadIcon(novedad.type)}</div>
                <div class="flex-grow">
                    <p class="text-sm text-slate-800 leading-tight">${novedad.description}</p>
                    <p class="text-xs text-slate-400 mt-1">${formatTimeAgo(novedad.timestamp?.toDate())}</p>
                </div>
            </div>
        `).join("");
        lucide.createIcons();
    }

    function renderEmpresaSection() {
        if (!companyProfile) return;

        document.getElementById("company-name").value = companyProfile.name || '';
        document.getElementById("company-nit").value = companyProfile.nit || '';
        document.getElementById("company-address").value = companyProfile.address || '';
        document.getElementById("company-phone").value = companyProfile.phone || '';
        document.getElementById("company-email").value = companyProfile.email || '';

        const themeInput = document.querySelector(`#theme-selector input[value="${companyProfile.theme || "default"}"]`);
        if (themeInput) themeInput.checked = true;

        const sidebarThemeInput = document.querySelector(`#sidebar-theme-selector input[value="${companyProfile.sidebarTheme || "dark"}"]`);
        if (sidebarThemeInput) sidebarThemeInput.checked = true;

        const bottomNavThemeInput = document.querySelector(`#bottom-nav-theme-selector input[value="${companyProfile.bottomNavTheme || "dark"}"]`);
        if (bottomNavThemeInput) bottomNavThemeInput.checked = true;

        updateCompanyLogoUI(companyProfile.logo || null);
    }
    function renderFlujoCajaSection() {
        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

        const reportStartInput = document.getElementById('report-start-date');
        const reportEndInput = document.getElementById('report-end-date');
        if (reportStartInput) {
            reportStartInput.value = startOfMonth.toISOString().split('T')[0];
        }
        if (reportEndInput) {
            reportEndInput.value = today.toISOString().split('T')[0];
        }

        const transactions = getAllTransactions();
        const currentMonthTransactions = transactions.filter(item => {
            const parsedDate = getComparableDate(item.date);
            return parsedDate && parsedDate.getMonth() === today.getMonth() && parsedDate.getFullYear() === today.getFullYear();
        });

        const monthIncome = currentMonthTransactions
            .filter(item => item.type === 'ingreso')
            .reduce((sum, item) => sum + (item.amount || 0), 0);

        const monthExpenses = currentMonthTransactions
            .filter(item => item.type === 'egreso')
            .reduce((sum, item) => sum + (item.amount || 0), 0);

        document.getElementById('cashflow-income').textContent = formatCurrency(monthIncome);
        document.getElementById('cashflow-expenses').textContent = formatCurrency(monthExpenses);
        document.getElementById('cashflow-profit').textContent = formatCurrency(monthIncome - monthExpenses);

        renderTransactionsTable(transactions);
    }
    function getAllTransactions() {
        const transactions = [];
        affiliates.forEach(aff => {
            if (aff.status === 'Activo') {
                const incomeAmount = getAffiliateCommissionBase(aff);
                const normalizedStartDate = normalizeDateInput(aff.startDate) || aff.startDate;
                transactions.push({ id: `auto-i-${aff.id}`, type: 'ingreso', concept: `Pago afiliado: ${aff.name}`, amount: incomeAmount, date: normalizedStartDate });
                const commissionAmount = getAdvisorCommissionForAffiliate(aff);
                if (commissionAmount > 0 && aff.commissionPaid) {
                    const advisor = advisors.find(item => item.id === aff.advisorId);
                    const normalizedCommissionDate = normalizeDateInput(aff.commissionPaidAt) || normalizedStartDate;
                    transactions.push({ id: `auto-e-${aff.id}`, type: 'egreso', concept: `Comisión ${advisor?.name || 'N/A'} (Afiliado: ${aff.name})`, amount: commissionAmount, date: normalizedCommissionDate });
                }
            }
        });

        const normalizedManualTransactions = manualTransactions.map(tx => ({
            ...tx,
            date: normalizeDateInput(tx.date) || tx.date
        }));

        return [...transactions, ...normalizedManualTransactions].sort((a, b) => {
            const dateA = getComparableDate(a.date);
            const dateB = getComparableDate(b.date);
            return (dateB ? dateB.getTime() : 0) - (dateA ? dateA.getTime() : 0);
        });
    }

    async function setAffiliateCommissionPaymentStatus(affiliateId, isPaid) {
        const currentAffiliate = affiliates.find(aff => aff.id === affiliateId);
        if (!currentAffiliate) throw new Error('Affiliate not found');
        const paidAtLocal = isPaid ? new Date() : null;
        affiliates = affiliates.map(aff => aff.id === affiliateId ? { ...aff, commissionPaid: isPaid, commissionPaidAt: paidAtLocal } : aff);
        renderAllDependentOnAffiliates();
        const payload = { id: affiliateId, commissionPaid: isPaid, commissionPaidAt: isPaid ? serverTimestamp() : null };
        await saveDataToFirestore('affiliates', payload);
    }
    function renderTransactionsTable(collection) {
        const tableBody = document.getElementById('transactions-table-body');
        if (!tableBody) return;

        if (collection.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-slate-500">No hay transacciones registradas.</td></tr>';
            return;
        }

        tableBody.innerHTML = collection.map(item => {
            const isIncome = item.type === 'ingreso';
            const parsedDate = getComparableDate(item.date);
            const displayDate = parsedDate ? parsedDate.toLocaleDateString('es-CO') : '--/--/----';
            return `<tr class="border-b"><td class="p-3">${displayDate}</td><td class="p-3 text-slate-700">${item.concept}</td><td class="p-3 text-right font-semibold ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">${isIncome ? '+' : '-'}${formatCurrency(item.amount)}</td></tr>`;
        }).join('');
    }
    async function generatePDFReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const primaryColorRGB = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-600').trim().split(' ').map(Number);
    const startDate = new Date(document.getElementById('report-start-date').value + 'T00:00:00');
    const endDate = new Date(document.getElementById('report-end-date').value + 'T23:59:59');

    if (isNaN(startDate) || isNaN(endDate)) {
        return showToast("Por favor, selecciona un rango de fechas válido.", "error");
    }

    const transactionsInPeriod = getAllTransactions().filter(t => {
        const tDate = getComparableDate(t.date);
        return tDate && tDate >= startDate && tDate <= endDate;
    });
    const activeAffiliatesCount = affiliates.filter(a => a.status === 'Activo').length;
    const affiliatesInPeriod = affiliates.filter(aff => {
        if (!aff.createdAt) return false;
        const createdAt = aff.createdAt instanceof Date ? aff.createdAt : new Date(aff.createdAt);
        return !isNaN(createdAt) && createdAt >= startDate && createdAt <= endDate;
    });

    const totalIncome = transactionsInPeriod.filter(t => t.type === 'ingreso').reduce((sum, t) => sum + t.amount, 0);
    const advisorCommissions = transactionsInPeriod.filter(t => t.type === 'egreso' && t.id.startsWith('auto-e-')).reduce((sum, t) => sum + t.amount, 0);
    const manualExpenses = transactionsInPeriod.filter(t => t.type === 'egreso' && !t.id.startsWith('auto-e-')).reduce((sum, t) => sum + t.amount, 0);
    const totalExpenses = advisorCommissions + manualExpenses;
    const adminFee = settings?.ADMIN_FEE_PER_AFFILIATE ?? defaultSettings.ADMIN_FEE_PER_AFFILIATE;
    const adminGrossProfit = activeAffiliatesCount * adminFee;
    const adminNetProfit = affiliatesInPeriod.length * adminFee;
    const netProfit = totalIncome - totalExpenses;

    const commissionBreakdown = advisors.map(advisor => {
        const totalCommissionForAdvisor = transactionsInPeriod
            .filter(t => t.type === 'egreso' && t.id.startsWith('auto-e-') && t.concept.includes(advisor.name))
            .reduce((sum, t) => sum + t.amount, 0);
        return { name: advisor.name, commission: totalCommissionForAdvisor };
    }).filter(item => item.commission > 0);

    let textStartX = 14;
    let headerPrimaryY = 22;
    let headerSecondaryY = 30;
    let headerBottomY = 34;

    if (companyProfile.logo) {
        const placement = await addLogoToPDF(doc, companyProfile.logo, { x: 14, y: 12, maxWidthMm: 48, maxHeightMm: 24 });
        if (placement) {
            textStartX = placement.x + placement.width + 8;
            headerPrimaryY = Math.max(20, placement.y + 6);
            headerSecondaryY = headerPrimaryY + 8;
            headerBottomY = Math.max(headerBottomY, placement.y + placement.height);
        }
    }

    doc.setFontSize(18);
    doc.setTextColor(primaryColorRGB[0], primaryColorRGB[1], primaryColorRGB[2]);
    doc.text(companyProfile.name || 'Reporte Financiero', textStartX, headerPrimaryY);
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`NIT: ${companyProfile.nit || 'N/A'}`, textStartX, headerSecondaryY);
    doc.text(`Reporte Financiero Detallado`, doc.internal.pageSize.getWidth() - 14, headerPrimaryY, { align: 'right' });
    doc.setFontSize(10);
    doc.text(`Periodo: ${startDate.toLocaleDateString('es-CO')} - ${endDate.toLocaleDateString('es-CO')}`, doc.internal.pageSize.getWidth() - 14, headerSecondaryY, { align: 'right' });

    let currentY = Math.max(headerBottomY + 14, headerSecondaryY + 14);

    doc.autoTable({
        startY: currentY,
        head: [['Resumen Financiero', '']],
        body: [
            ['Ingresos Totales', formatCurrency(totalIncome)],
            ['Egresos Totales', formatCurrency(totalExpenses)],
            [{content: `   - Total Comisiones a Asesores`, styles: {cellPadding: {left: 8}}}, formatCurrency(advisorCommissions)],
            [{content: `   - Otros Egresos Manuales`, styles: {cellPadding: {left: 8}}}, formatCurrency(manualExpenses)],
            ['Ganancia por Administración (Afiliados Activos x Tarifa)', formatCurrency(adminGrossProfit)],
            ['Ganancia Administrativa Neta', formatCurrency(adminNetProfit)],
            [{content: 'Ganancia Neta (Saldo Real en Caja)', styles: {fontStyle: 'bold', fillColor: '#f0fdf4', textColor: '#15803d'}},
             {content: formatCurrency(netProfit), styles: {fontStyle: 'bold', fillColor: '#f0fdf4', textColor: '#15803d'}}]
        ],
        theme: 'grid',
        headStyles: { fillColor: primaryColorRGB, fontSize: 12, fontStyle: 'bold' },
        styles: { fontSize: 10, cellPadding: 3 },
        didParseCell: function (data) {
            if (data.row.index >= 2 && data.row.index <= 3) {
                data.cell.styles.fontSize = 9;
                data.cell.styles.textColor = '#475569';
            }
        }
    });

    currentY = doc.lastAutoTable.finalY + 10;

    if (commissionBreakdown.length > 0) {
        doc.autoTable({
            startY: currentY,
            head: [['Desglose de Comisiones por Asesor', 'Comisión Generada']],
            body: commissionBreakdown.map(item => [item.name, formatCurrency(item.commission)]),
            theme: 'striped',
            headStyles: { fillColor: primaryColorRGB }
        });
        currentY = doc.lastAutoTable.finalY + 10;
    }

    doc.autoTable({
        startY: currentY,
        head: [['Historial Detallado de Transacciones', 'Fecha', 'Tipo', 'Monto']],
        body: transactionsInPeriod.map(t => [
            t.concept,
        (() => {
            const printableDate = getComparableDate(t.date);
            return printableDate ? printableDate.toLocaleDateString('es-CO') : '--/--/----';
        })(),
            t.type === 'ingreso' ? 'Ingreso' : 'Egreso',
            {content: formatCurrency(t.amount), styles: {halign: 'right'}}
        ]),
        theme: 'striped',
        headStyles: { fillColor: [45, 55, 72] }
    });

    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text('Página ' + String(i) + ' de ' + String(pageCount), doc.internal.pageSize.width - 14, doc.internal.pageSize.height - 6, { align: 'right' });
        doc.text(`Generado el ${new Date().toLocaleString('es-CO')}`, 14, doc.internal.pageSize.height - 6);
    }

    doc.save(`Reporte_Financiero_${startDate.toLocaleDateString('es-CO').replace(/\//g, '-')}.pdf`);
    showToast('Generando reporte financiero detallado.', 'success');
}

    function updateNovedadesBadge(){
        const unreadCount = novedades.filter(n => n.read === false).length;
        const badge = document.getElementById("novedades-header-badge");
        const markAsReadBtn = document.getElementById("mark-novedades-read");

        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove("hidden");
            markAsReadBtn.disabled = false;
        } else {
            badge.classList.add("hidden");
            markAsReadBtn.disabled = true;
        }
    }

    function getNovedadIcon(e){return{creation:'<i data-lucide="user-plus" class="h-5 w-5 text-green-500"></i>',status_change:'<i data-lucide="shuffle" class="h-5 w-5 text-yellow-500"></i>',payment_reminder:'<i data-lucide="calendar-clock" class="h-5 w-5 text-red-500"></i>',commission_earned:'<i data-lucide="award" class="h-5 w-5 text-blue-500"></i>',admin_profit:'<i data-lucide="trending-up" class="h-5 w-5 text-indigo-500"></i>',deletion:'<i data-lucide="user-x" class="h-5 w-5 text-red-500"></i>'}[e]||'<i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-500"></i>'}
    function formatTimeAgo(e){if(!e) return "hace un momento"; const t=Math.floor((new Date-e)/1e3);let a=t/31536e3;if(1<a)return`hace ${Math.floor(a)} años`;if(1<(a=t/2592e3))return`hace ${Math.floor(a)} meses`;if(1<(a=t/86400))return`hace ${Math.floor(a)} días`;if(1<(a=t/3600))return`hace ${Math.floor(a)} horas`;if(1<(a=t/60))return`hace ${Math.floor(a)} minutos`;return`hace ${Math.floor(t)} segundos`}
    function checkAndGenerateNovedades(newAffiliates, oldAffiliates){}
    
    // --- LÓGICA DEL CALENDARIO (MODIFICADA) ---
    function initializeCalendarSelectors() {
        const monthSelect = document.getElementById('metric-month');
        const yearSelect = document.getElementById('metric-year');
        const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth();

        monthSelect.innerHTML = months.map((month, i) => `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${month}</option>`).join('');
        
        let yearOptions = '';
        for (let year = currentYear; year >= currentYear - 5; year--) {
            yearOptions += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
        }
        yearSelect.innerHTML = yearOptions;
    }

    function renderCalendarioSection() {
        if (currentUserRole !== 'admin') return;

        const cardContainer = document.getElementById('calendar-card-container');
        const tableContainer = document.getElementById('calendar-table-container');
        const listContainer = document.getElementById('calendar-list-container');
        const monthYearFilter = document.getElementById('calendar-month-year-filter-container');

        [cardContainer, tableContainer, listContainer].forEach(c => c.style.display = 'none');
        monthYearFilter.style.display = 'none';
        
        updateCalendarViewToggle();

        if (calendarViewMode === 'card' || calendarViewMode === 'table') {
            monthYearFilter.style.display = 'flex';
            const selectedMonth = parseInt(document.getElementById('metric-month').value, 10);
            const selectedYear = parseInt(document.getElementById('metric-year').value, 10);

            const newAffiliatesThisMonth = affiliates.filter(aff => {
                const createdAt = aff.createdAt;
                return createdAt && createdAt.getMonth() === selectedMonth && createdAt.getFullYear() === selectedYear;
            });

            const dataByAdvisor = advisors.map(advisor => ({
                advisor,
                newAffiliates: newAffiliatesThisMonth.filter(aff => aff.advisorId === advisor.id)
            })).filter(item => item.newAffiliates.length > 0);

            if (calendarViewMode === 'card') {
                cardContainer.style.display = 'grid';
                renderCalendarAsCards(dataByAdvisor);
            } else {
                tableContainer.style.display = 'block';
                renderCalendarAsTable(dataByAdvisor);
            }
        } else if (calendarViewMode === 'list') {
            listContainer.style.display = 'block';
            renderCalendarAsList();
        }

        lucide.createIcons();
    }

    function renderCalendarAsCards(data) {
        const container = document.getElementById('calendar-card-container');
        if (data.length === 0) {
            container.innerHTML = '<p class="col-span-full text-center text-slate-500 bg-white p-6 rounded-lg shadow">No se registraron nuevos afiliados en este periodo.</p>';
            return;
        }
        container.innerHTML = data.map(({ advisor, newAffiliates }) => `
            <div class="bg-white rounded-xl shadow-lg p-5">
                <h3 class="font-bold text-lg text-slate-800">${advisor.name}</h3>
                <p class="text-sm text-slate-500">Nuevos Afiliados: <span class="font-bold text-primary-600">${newAffiliates.length}</span></p>
                <div class="mt-4 pt-4 border-t">
                    <ul class="space-y-2 text-sm max-h-48 overflow-y-auto pr-2">
                        ${newAffiliates.map(aff => `
                            <li class="flex justify-between items-center hover:bg-slate-50 p-1 rounded">
                                <span class="text-slate-700">${aff.name}</span>
                                <span class="text-xs text-slate-400">${formatDateShort(aff.startDate) || ''}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        `).join('');
    }

    function renderCalendarAsTable(data) {
        const tableBody = document.getElementById('calendar-table-body');
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-6 text-slate-500">No se registraron nuevos afiliados en este periodo.</td></tr>';
            return;
        }
        tableBody.innerHTML = data.map(({ advisor, newAffiliates }) => `
            <tr class="hover:bg-slate-50">
                <td class="p-3 font-semibold text-slate-800">${advisor.name}</td>
                <td class="p-3 text-center text-lg font-bold text-primary-600">${newAffiliates.length}</td>
                <td class="p-3">
                    <ul class="space-y-1 text-sm">
                        ${newAffiliates.map(aff => `<li>${aff.name} <span class="text-xs text-slate-400">(${formatDateShort(aff.startDate) || ''})</span></li>`).join('')}
                    </ul>
                </td>
            </tr>
        `).join('');
    }

    function renderCalendarAsList() {
        const range = parseInt(document.getElementById('calendar-list-range-filter').value, 10);
        const headContainer = document.getElementById('calendar-list-head');
        const bodyContainer = document.getElementById('calendar-list-body');
        const monthsLocale = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    
        // 1. OBTENER LOS MESES PARA LAS CABECERAS
        const monthHeaders = [];
        let currentDate = new Date();
        currentDate.setDate(1); // Normalizar al primer día del mes
        for (let i = 0; i < range; i++) {
            monthHeaders.unshift({ // Usamos unshift para que queden en orden cronológico
                year: currentDate.getFullYear(),
                month: currentDate.getMonth(),
                label: `${monthsLocale[currentDate.getMonth()]} ${currentDate.getFullYear()}`
            });
            currentDate.setMonth(currentDate.getMonth() - 1);
        }
        const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        const endDate = new Date();
    
        // 2. GENERAR LAS CABECERAS DE LA TABLA
        headContainer.innerHTML = `
            <tr>
                <th class="p-3 text-xs font-semibold text-slate-600 uppercase text-left sticky left-0 bg-slate-100 z-10">Asesor</th>
                ${monthHeaders.map(h => `<th class="p-3 text-xs font-semibold text-slate-600 uppercase text-center">${h.label}</th>`).join('')}
            </tr>`;
    
        // 3. FILTRAR Y AGRUPAR LOS DATOS
        const affiliatesInRange = affiliates.filter(aff => aff.createdAt && aff.createdAt >= startDate && aff.createdAt <= endDate);
        const groupedData = affiliatesInRange.reduce((acc, aff) => {
            const key = `${aff.createdAt.getFullYear()}-${aff.createdAt.getMonth()}`;
            if (!acc[aff.advisorId]) acc[aff.advisorId] = {};
            if (!acc[aff.advisorId][key]) acc[aff.advisorId][key] = [];
            acc[aff.advisorId][key].push(aff);
            return acc;
        }, {});
    
        if (advisors.length === 0) {
            bodyContainer.innerHTML = `<tr><td colspan="${range + 1}" class="text-center p-6 text-slate-500">No hay asesores registrados.</td></tr>`;
            return;
        }
    
        // 4. GENERAR EL CUERPO DE LA TABLA CON LA LÓGICA DE DESGLOSE
        bodyContainer.innerHTML = advisors.map(advisor => {
            const cells = monthHeaders.map(header => {
                const key = `${header.year}-${header.month}`;
                const affiliatesForMonth = groupedData[advisor.id]?.[key];
                const cellId = `${advisor.id}-${key}`; // ID único para cada celda
    
                if (affiliatesForMonth && affiliatesForMonth.length > 0) {
                    const count = affiliatesForMonth.length;
                    // Generamos el HTML para la celda con el contador, el botón y la lista oculta
                    return `
                        <td class="p-3 align-top text-center">
                            <div class="flex items-center justify-center gap-2">
                                <span class="font-bold text-lg text-primary-600">${count}</span>
                                <button class="calendar-details-toggle p-1 rounded-full hover:bg-slate-200" data-toggle-cell="${cellId}" title="Ver desglose">
                                    <i data-lucide="chevron-down" class="h-5 w-5 text-slate-500 pointer-events-none details-toggle-icon"></i>
                                </button>
                            </div>
                            <ul id="details-${cellId}" class="hidden text-left mt-2 space-y-1 text-sm max-h-40 overflow-y-auto pr-2">
                                ${affiliatesForMonth.map(aff => `
                                    <li class="p-1.5 rounded hover:bg-slate-100">
                                        <p class="font-medium text-slate-800">${aff.name}</p>
                                        <p class="text-xs text-slate-500">Registrado: ${aff.createdAt.toLocaleDateString('es-CO')}</p>
                                    </li>
                                `).join('')}
                            </ul>
                        </td>`;
                } else {
                    // Si no hay afiliados, mostramos un guion
                    return `<td class="p-3 align-top text-center"><span class="text-slate-400">-</span></td>`;
                }
            }).join('');
    
            return `
                <tr class="border-b">
                    <td class="p-3 font-semibold text-slate-800 align-top sticky left-0 bg-white z-10">${advisor.name}</td>
                    ${cells}
                </tr>`;
        }).join('');
    }

    function updateCalendarViewToggle() {
        const buttons = {
            card: document.getElementById('calendar-view-cards-btn'),
            table: document.getElementById('calendar-view-table-btn'),
            list: document.getElementById('calendar-view-list-btn')
        };
        const activeClass = 'p-2 rounded-lg bg-primary-600 text-white shadow-md';
        const inactiveClass = 'p-2 rounded-lg bg-white hover:bg-slate-100 border text-slate-600';
        
        Object.keys(buttons).forEach(key => {
            buttons[key].className = (key === calendarViewMode) ? activeClass : inactiveClass;
        });
    }

    function renderGestionRolesSection() {
        const tableBody = document.getElementById('roles-table-body');
        if (!tableBody) return;
        
        if (userRoles.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">No has creado usuarios con roles.</td></tr>`;
            return;
        }

        tableBody.innerHTML = userRoles.map(role => {
            let linkedName = 'N/A';
            if (role.role === 'asesor' && role.linkedAdvisorId) {
                const advisor = advisors.find(a => a.id === role.linkedAdvisorId);
                linkedName = advisor ? advisor.name : 'Asesor no encontrado';
            } else if (role.role === 'afiliado' && role.linkedAffiliateId) {
                const affiliate = affiliates.find(a => a.id === role.linkedAffiliateId);
                linkedName = affiliate ? affiliate.name : 'Afiliado no encontrado';
            }
            return `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 font-medium text-slate-800">${role.email}</td>
                    <td class="p-3"><span class="font-semibold text-xs px-2 py-1 rounded-full ${role.role === 'asesor' ? 'bg-sky-100 text-sky-800' : 'bg-lime-100 text-lime-800'}">${role.role}</span></td>
                    <td class="p-3 text-slate-600">${linkedName}</td>
                    <td class="p-3">
                        <button class="delete-role-btn text-slate-500 hover:text-red-600 p-2 rounded-full" data-id="${role.id}" title="Eliminar Usuario y Rol (irreversible)"><i data-lucide="trash-2" class="h-4 w-4 pointer-events-none"></i></button>
                    </td>
                </tr>
            `;
        }).join('');
        lucide.createIcons();
    }

    async function handleInviteUser(e) {
        e.preventDefault();
        const btn = document.getElementById('invite-user-btn');
        btn.disabled = true;
        btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> Creando...`;
        lucide.createIcons();

        const email = document.getElementById('invite-email').value;
        const password = document.getElementById('invite-password').value;
        const role = document.getElementById('invite-role').value;
        const linkedId = document.getElementById('invite-link-select').value;
        
        if (!email || !password || !role || !linkedId) {
            showToast('Todos los campos son requeridos.', 'error');
            btn.disabled = false;
            btn.textContent = 'Crear y Vincular Usuario';
            return;
        }

        try {
            const secondaryApp = initializeApp(firebaseConfig, `secondary-auth-${Date.now()}`);
            const secondaryAuth = getAuth(secondaryApp);
            const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
            const newUserUid = userCredential.user.uid;
            await signOut(secondaryAuth);
            await deleteApp(secondaryApp);

            const batch = writeBatch(db);
            
            const userRoleRef = doc(db, "userRoles", newUserUid);
            batch.set(userRoleRef, {
                email: email,
                role: role,
                adminUid: currentUser.uid
            });

            const adminRoleRef = doc(db, `users/${currentUser.uid}/roles`, newUserUid);
            const roleData = {
                uid: newUserUid,
                email: email,
                role: role,
                createdAt: serverTimestamp()
            };
            if (role === 'asesor') roleData.linkedAdvisorId = linkedId;
            if (role === 'afiliado') roleData.linkedAffiliateId = linkedId;
            batch.set(adminRoleRef, roleData);

            await batch.commit();

            showToast('Usuario creado y vinculado exitosamente.', 'success');
            e.target.reset();
            document.getElementById('invite-link-container').classList.add('hidden');

        } catch (error) {
            console.error("Error creando usuario:", error);
            showToast(getFirebaseAuthErrorMessage(error), 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Crear y Vincular Usuario';
        }
    }

    function renderPerfilAfiliadoSection() {
        if (!userRoleData.linkedAffiliateId) return;
        
        const affiliate = affiliates.find(a => a.id === userRoleData.linkedAffiliateId);
        if (!affiliate) { return; }

        const plan = healthPlans.find(p => p.id === affiliate.healthPlan);
        const statusStyles = { 
            'Activo': { bg: 'bg-green-100', text: 'text-green-800', icon: 'check-circle' },
            'Pendiente': { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'clock' },
            'Inactivo': { bg: 'bg-red-100', text: 'text-red-800', icon: 'x-circle' }
        };

        document.getElementById('afiliado-profile-name').textContent = affiliate.name;
        document.getElementById('afiliado-profile-id').textContent = affiliate.documentId;
        document.getElementById('afiliado-profile-email').textContent = affiliate.email;
        document.getElementById('afiliado-profile-phone').textContent = affiliate.phone;
        
        document.getElementById('afiliado-profile-plan-name').textContent = plan ? plan.name : "Plan no especificado";
        document.getElementById('afiliado-profile-plan-price').textContent = plan ? formatCurrency(plan.price) : "$0";
        document.getElementById('afiliado-profile-start-date').textContent = formatDateShort(affiliate.startDate) || '--/--/----';
        document.getElementById('afiliado-profile-end-date').textContent = affiliate.endDate || "Indefinido";
        
        const statusContainer = document.getElementById('afiliado-profile-status-container');
        const currentStatus = statusStyles[affiliate.status] || statusStyles['Pendiente'];
        statusContainer.innerHTML = `
            <span class="inline-flex items-center gap-1.5 font-semibold text-xs px-2 py-1 rounded-full ${currentStatus.bg} ${currentStatus.text}">
                <i data-lucide="${currentStatus.icon}" class="w-3.5 h-3.5"></i>
                ${affiliate.status}
            </span>`;

        const featuresList = document.getElementById('afiliado-profile-plan-features');
        if (plan && plan.features) {
            featuresList.innerHTML = plan.features.split('\n').map(feature => `
                <li class="flex items-start gap-2">
                    <i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i>
                    <span>${feature}</span>
                </li>
            `).join('');
        } else {
            featuresList.innerHTML = '<li>No hay características detalladas para este plan.</li>';
        }

        lucide.createIcons();
    }

   /**
 * Limpia y formatea un número de teléfono al estándar de WhatsApp para Colombia.
 * @param {string} phone El número de teléfono a formatear.
 * @returns {string|null} El número formateado (ej: 573001234567) o null si el número es inválido.
 */
function formatPhoneNumberForWhatsApp(phone) {
    if (!phone || typeof phone !== 'string') {
        return null;
    }

    // 1. Eliminar todos los caracteres que no sean dígitos
    let cleaned = phone.replace(/\D/g, '');

    // 2. Validar si es un número colombiano válido (10 dígitos) o ya tiene el código de país
    if (cleaned.length === 12 && cleaned.startsWith('57')) {
        // El número ya está en el formato correcto (ej: 573001234567)
        return cleaned;
    } else if (cleaned.length === 10) {
        // Es un número de 10 dígitos, le añadimos el código de país
        return '57' + cleaned;
    } else {
        // El número no parece ser un celular colombiano válido
        console.warn(`Número de teléfono no válido para WhatsApp: ${phone}`);
        return null;
    }
}

    document.addEventListener('DOMContentLoaded', () => {
        // --- INICIO LÓGICA DEL BUSCADOR GLOBAL (VERSIÓN MÓVIL INCLUIDA) ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        const headerSearchInput = document.getElementById('header-search-input');
        const headerSearchResults = document.getElementById('header-search-results');
        const headerSearchContainer = document.getElementById('header-search-container');
        const headerMainContent = document.getElementById('header-main-content');
        const searchToggleMobile = document.getElementById('search-toggle-mobile');
        const closeSearchMobile = document.getElementById('close-search-mobile');
        const headerActions = document.getElementById('header-actions');
        const toggleMobileSearch = (show) => {
            if (show) {
                headerMainContent.classList.add('hidden');
                headerActions.classList.add('hidden');
                headerSearchContainer.classList.remove('hidden');
                headerSearchContainer.classList.add('flex');
                headerSearchInput.focus();
            } else {
                headerMainContent.classList.remove('hidden');
                headerActions.classList.remove('hidden');
                headerSearchContainer.classList.add('hidden');
                headerSearchContainer.classList.remove('flex');
                headerSearchResults.classList.add('hidden');
                headerSearchInput.value = '';
            }
        };
        searchToggleMobile.addEventListener('click', () => toggleMobileSearch(true));
        closeSearchMobile.addEventListener('click', () => toggleMobileSearch(false));
        const renderHeaderSearchResults = (results) => {
            if (results.length === 0) {
                headerSearchResults.innerHTML = `<div class="p-4 text-center text-sm text-slate-500">No se encontraron afiliados.</div>`;
            } else {
                headerSearchResults.innerHTML = results.map(aff => `
                    <div class="search-result-item p-3 border-b border-slate-200/50 hover:bg-slate-50 cursor-pointer" 
                         data-affiliate-id="${aff.id}" data-affiliate-doc="${aff.documentId}">
                        <p class="font-semibold text-slate-800">${aff.name}</p>
                        <p class="text-sm text-slate-500">Doc: ${aff.documentId}</p>
                    </div>
                `).join('');
            }
            headerSearchResults.classList.remove('hidden');
        };
        const handleHeaderSearch = () => {
            const searchTerm = headerSearchInput.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                headerSearchResults.classList.add('hidden');
                return;
            }
            const filteredAffiliates = affiliates.filter(aff => 
                aff.name.toLowerCase().includes(searchTerm) || 
                (aff.documentId && aff.documentId.toLowerCase().includes(searchTerm))
            );
            renderHeaderSearchResults(filteredAffiliates);
        };
        const debouncedSearch = debounce(handleHeaderSearch, 300);
        headerSearchInput.addEventListener('input', debouncedSearch);
        headerSearchResults.addEventListener('click', (e) => {
            const resultItem = e.target.closest('.search-result-item');
            if (!resultItem) return;
            const affiliateDoc = resultItem.dataset.affiliateDoc;
            
            document.querySelectorAll('[data-target]').forEach(l => l.classList.remove('active'));
            document.querySelectorAll(`[data-target="afiliados"]`).forEach(l => l.classList.add('active'));
            renderContent('afiliados');

            const mainAffiliateSearchInput = document.getElementById('search-affiliate');
            if (mainAffiliateSearchInput) {
                mainAffiliateSearchInput.value = affiliateDoc;
                mainAffiliateSearchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            
            if (window.innerWidth < 768) {
                toggleMobileSearch(false);
            } else {
                headerSearchResults.classList.add('hidden');
                headerSearchInput.value = '';
            }
        });
        document.addEventListener('click', (e) => {
            if (!headerSearchContainer.contains(e.target) && !searchToggleMobile.contains(e.target)) {
                headerSearchResults.classList.add('hidden');
                if (window.innerWidth < 768 && !headerSearchContainer.classList.contains('hidden')) {
                    toggleMobileSearch(false);
                }
            }
        });
        // --- FIN LÓGICA DEL BUSCADOR GLOBAL ---
        
        // --- INICIO LÓGICA DE FILTROS EN TIEMPO REAL (SECCIÓN AFILIADOS) ---
        const searchAffiliateInput = document.getElementById('search-affiliate');
        const filterAffiliateStatus = document.getElementById('filter-affiliate-status');
        const filterAffiliatePaymentStatus = document.getElementById('filter-affiliate-payment-status');
        const debouncedRenderAffiliates = debounce(renderAffiliatesList, 300);
        if (searchAffiliateInput) {
            searchAffiliateInput.addEventListener('input', () => {
                debouncedRenderAffiliates();
            });
        }
        if (filterAffiliateStatus) {
            filterAffiliateStatus.addEventListener('change', () => {
                renderAffiliatesList();
            });
        }
        if (filterAffiliatePaymentStatus) {
            filterAffiliatePaymentStatus.addEventListener('change', () => {
                renderAffiliatesList();
            });
        }
        // --- FIN LÓGICA DE FILTROS EN TIEMPO REAL ---

        document.getElementById('invite-user-form').addEventListener('submit', handleInviteUser);
        const inviteRoleSelect = document.getElementById('invite-role');
        const inviteLinkContainer = document.getElementById('invite-link-container');
        const inviteLinkSelect = document.getElementById('invite-link-select');
        const inviteLinkLabel = document.getElementById('invite-link-label');

        inviteRoleSelect.addEventListener('change', (e) => {
            const selectedRole = e.target.value;
            if (selectedRole === 'asesor' || selectedRole === 'afiliado') {
                let options = '<option value="" disabled selected>Seleccionar para vincular...</option>';
                if (selectedRole === 'asesor') {
                    inviteLinkLabel.textContent = 'Vincular con Asesor Existente:';
                    options += advisors.map(advisor => `<option value="${advisor.id}">${advisor.name}</option>`).join('');
                } else { 
                    inviteLinkLabel.textContent = 'Vincular con Afiliado Existente:';
                    options += affiliates.map(aff => `<option value="${aff.id}">${aff.name} (${aff.documentId})</option>`).join('');
                }
                inviteLinkSelect.innerHTML = options;
                inviteLinkContainer.classList.remove('hidden'); 
            } else {
                inviteLinkContainer.classList.add('hidden'); 
            }
        });

        document.body.addEventListener('click', async (e) => { 
            const target = e.target;
            const button = target.closest('button');
            const navLink = target.closest('[data-target]');
            const profileModal = document.getElementById('profile-modal');
            const profileToggleBtn = document.getElementById('profile-toggle-btn');
            const novedadesModal = document.getElementById('novedades-modal');
            const novedadesToggleBtn = document.getElementById('novedades-toggle-btn');

            if (profileModal && !profileModal.contains(target) && profileToggleBtn && !profileToggleBtn.contains(target)) { profileModal.classList.add('scale-95', 'opacity-0', 'pointer-events-none'); } 
            if (novedadesModal && !novedadesModal.contains(target) && novedadesToggleBtn && !novedadesToggleBtn.contains(target)) { novedadesModal.classList.add('scale-95', 'opacity-0', 'pointer-events-none'); } 
            
            if (navLink) { 
                e.preventDefault(); 
                const targetId = navLink.dataset.target; 
                renderContent(targetId); 
                document.querySelectorAll('[data-target]').forEach(l => l.classList.remove('active')); 
                document.querySelectorAll(`[data-target="${targetId}"]`).forEach(l => l.classList.add('active')); 
                const title = navLink.querySelector('span')?.textContent.trim() || navLink.textContent.trim().split('\n')[0].trim() || targetId; 
                document.getElementById('header-title').textContent = title.charAt(0).toUpperCase() + title.slice(1); 
                if (window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('opacity-0', 'pointer-events-none'); } 
                return; 
            } 
            
            if (!button) return; 
            const id = button.dataset.id; 
            
            switch (button.id) { 
                case 'show-register': document.getElementById('login-view').style.display = 'none'; document.getElementById('register-view').style.display = 'block'; return; 
                case 'show-login': document.getElementById('register-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; return; 
                case 'logout-btn': case 'profile-modal-logout-btn': signOut(auth); return; 
                case 'menu-toggle': document.getElementById('sidebar').classList.toggle('-translate-x-full'); const overlay = document.getElementById('sidebar-overlay'); overlay.classList.toggle('opacity-0'); overlay.classList.toggle('pointer-events-none'); return; 
                case 'profile-toggle-btn': document.getElementById('profile-modal').classList.toggle('scale-95'); document.getElementById('profile-modal').classList.toggle('opacity-0'); document.getElementById('profile-modal').classList.toggle('pointer-events-none'); return; 
                case 'novedades-toggle-btn': document.getElementById('novedades-modal').classList.toggle('scale-95'); document.getElementById('novedades-modal').classList.toggle('opacity-0'); document.getElementById('novedades-modal').classList.toggle('pointer-events-none'); return;
                case 'sidebar-overlay': document.getElementById('menu-toggle').click(); return; 
                case 'add-affiliate-btn': modalManager.open('affiliate-modal'); return; 
                case 'add-advisor-btn': modalManager.open('advisor-modal'); return; 
                case 'add-plan-btn': modalManager.open('plan-modal'); return; 
                case 'add-income-btn': modalManager.open('transaction-modal', { type: 'ingreso', title: 'Nuevo Ingreso' }); return; 
                case 'add-expense-btn': modalManager.open('transaction-modal', { type: 'egreso', title: 'Nuevo Egreso' }); return; 
                case 'open-settings-btn': modalManager.open('settings-modal'); return; 
                case 'export-affiliates-btn': handleExportAffiliates(); return; 
                case 'export-advisors-btn': handleExportAdvisors(); return; 
                case 'generate-report-btn': generatePDFReport(); return; 
                case 'view-as-cards-btn': affiliatesViewMode = 'card'; updateViewToggleButtons(); renderAffiliatesList(); return; 
                case 'view-as-table-btn': affiliatesViewMode = 'table'; updateViewToggleButtons(); renderAffiliatesList(); return; 
                case 'calendar-view-cards-btn': calendarViewMode = 'card'; renderCalendarioSection(); return; 
                case 'calendar-view-table-btn': calendarViewMode = 'table'; renderCalendarioSection(); return; 
                case 'calendar-view-list-btn': calendarViewMode = 'list'; renderCalendarioSection(); return; 
            } 
            
            if (button.dataset.closeModal) modalManager.close(button.dataset.closeModal); 
            else if (button.matches('.edit-affiliate-btn')) modalManager.open('affiliate-modal', affiliates.find(a => a.id === id)); 
            else if (button.matches('.edit-advisor-btn')) modalManager.open('advisor-modal', advisors.find(v => v.id === id)); 
            else if (button.matches('.edit-plan-btn')) modalManager.open('plan-modal', healthPlans.find(p => p.id === id)); 
            else if (button.matches('[data-toggle-details]')) { const card = button.closest('.bg-white'); if (card) { card.querySelector('.details-section').classList.toggle('hidden'); button.classList.toggle('details-shown'); } } 
            else if (button.matches('[data-toggle-stats]')) { const statsContainer = document.getElementById(`advisor-stats-${button.dataset.toggleStats}`); if (statsContainer) { statsContainer.classList.toggle('hidden'); button.classList.toggle('stats-shown'); button.querySelector('.button-text').textContent = statsContainer.classList.contains('hidden') ? 'Ver Desglose' : 'Ocular Desglose'; } } 
            else if (button.matches('.toggle-commission-btn')) { const affiliateId = button.dataset.id; const nextStatus = button.dataset.nextStatus; if (!affiliateId || !nextStatus) return; button.disabled = true; button.classList.add('opacity-75'); try { const markAsPaid = nextStatus === 'paid'; await setAffiliateCommissionPaymentStatus(affiliateId, markAsPaid); showToast(`Comisión ${markAsPaid ? 'marcada como pagada' : 'marcada como pendiente'}.`); } catch (error) { console.error('Error actualizando estado de comisión:', error); showToast('No se pudo actualizar el estado de la comisión.', 'error'); } finally { button.disabled = false; button.classList.remove('opacity-75'); } }
            else if (button.matches('.delete-affiliate-btn')) { if (confirm('¿Seguro que deseas eliminar este afiliado?')) { await deleteDataFromFirestore('affiliates', id); showToast('Afiliado eliminado.'); } } 
            else if (button.matches('.delete-advisor-btn')) { if (confirm('¿Seguro? Se desasignará de todos los afiliados.')) { const batch = writeBatch(db); affiliates.forEach(aff => { if(aff.advisorId === id) { const affRef = doc(db, `users/${adminUidForRole}/affiliates/${aff.id}`); batch.update(affRef, { advisorId: null }); } }); const advisorRef = doc(db, `users/${adminUidForRole}/advisors/${id}`); batch.delete(advisorRef); await batch.commit(); showToast('Asesor eliminado.'); } } 
            else if (button.matches('.delete-plan-btn')) { const isPlanInUse = affiliates.some(aff => aff.healthPlan === id); if(isPlanInUse) return showToast('Plan en uso. No se puede eliminar.', 'error'); if (confirm('¿Seguro?')) { await deleteDataFromFirestore('healthPlans', id); showToast('Plan eliminado.'); } }
            else if (button.matches('.download-receipt-btn')) {
                showToast('Generando recibo PDF...', 'success');
                const affiliateId = button.dataset.id;
                const affiliateToPrint = affiliates.find(a => a.id === affiliateId);
                if (!affiliateToPrint) {
                    return showToast('No se encontró el afiliado para generar el recibo.', 'error');
                }
                const planToPrint = healthPlans.find(p => p.id === affiliateToPrint.healthPlan) || {};
                const advisorForPrint = advisors.find(a => a.id === affiliateToPrint.advisorId) || {};
                setTimeout(() => {
                     generarReciboAfiliacionPDF(affiliateToPrint, planToPrint, advisorForPrint, companyProfile);
                }, 300);
            }
            else if (button.matches('.delete-role-btn')) {
                 const roleToDelete = userRoles.find(r => r.id === id);
                 if (confirm(`¿Estás seguro de eliminar al usuario ${roleToDelete.email}? Esta acción no se puede deshacer y su cuenta será eliminada permanentemente.`)) {
                      showToast('Esta función requiere un backend (Cloud Function) para eliminar de forma segura un usuario de Firebase Authentication. La implementación actual solo eliminará los registros de rol en Firestore.', 'error');
                      const batch = writeBatch(db);
                      const rootRoleRef = doc(db, 'userRoles', id);
                      const adminRoleRef = doc(db, `users/${adminUidForRole}/roles`, id);
                      batch.delete(rootRoleRef);
                      batch.delete(adminRoleRef);
                      await batch.commit();
                      showToast('Registros de rol eliminados.', 'success');
                 }
            }
            else if (button.id === 'sell-plan-btn') { if (!lastQuoteResult) { showToast('Por favor, realiza una cotización primero.', 'error'); return; } modalManager.open('affiliate-modal'); setTimeout(() => { const form = document.getElementById('affiliate-form'); if (!form) return; form['manual-override-checkbox'].checked = true; document.getElementById('manual-override-container').classList.remove('hidden'); form['manual-cost-health'].value = lastQuoteResult.health ? Math.round(lastQuoteResult.health.total) : ''; form['manual-cost-pension'].value = lastQuoteResult.pension ? Math.round(lastQuoteResult.pension.total) : ''; form['manual-cost-arl'].value = lastQuoteResult.arl ? Math.round(lastQuoteResult.arl.total) : ''; form['manual-cost-ccf'].value = lastQuoteResult.ccf ? Math.round(lastQuoteResult.ccf.total) : ''; const incomeValue = Number(document.getElementById('income').value); form['affiliate-notes'].value = `Cotización inicial basada en un ingreso mensual de ${formatCurrency(incomeValue)}. IBC: ${formatCurrency(lastQuoteResult.ibc)}.`; showToast('Datos de cotización precargados.'); }, 100); } 
        });
        
        // --- Lógica de desglose para la vista de Calendario ---
        const calendarListBody = document.getElementById('calendar-list-body');
        if(calendarListBody) {
            calendarListBody.addEventListener('click', (e) => {
                const toggleButton = e.target.closest('.calendar-details-toggle');
    
                if (!toggleButton) return; // Si no se hizo clic en un botón, no hacer nada
    
                e.preventDefault();
                
                const cellId = toggleButton.dataset.toggleCell;
                const detailsList = document.getElementById(`details-${cellId}`);
                const icon = toggleButton.querySelector('.details-toggle-icon');
    
                if (detailsList) {
                    // Alternar la visibilidad de la lista de nombres
                    detailsList.classList.toggle('hidden');
                    
                    // Alternar la clase en el botón para manejar el estado visual (opcional pero recomendado)
                    toggleButton.classList.toggle('details-shown');
                    
                    // La clase 'details-shown' con el CSS existente rotará el ícono
                }
            });
        }
        
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); showView(loader); try { await signInWithEmailAndPassword(auth, e.target['login-email'].value, e.target['login-password'].value); } catch (error) { showToast(getFirebaseAuthErrorMessage(error), 'error'); showView(authContainer); } });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); showView(loader); try { const userCredential = await createUserWithEmailAndPassword(auth, e.target['register-email'].value, e.target['register-password'].value); await setupNewUserDocument(userCredential.user); } catch (error) { showToast(getFirebaseAuthErrorMessage(error), 'error'); showView(authContainer); } });
        document.getElementById('license-form').addEventListener('submit', e => { e.preventDefault(); handleLicenseActivation(); });
        document.getElementById('affiliate-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const selectedPlan = form.querySelector('input[name="health-plan"]:checked');
            const manualOverride = form['manual-override-checkbox'].checked;
            const selectedEpsOption = form['eps-plan'].value;
            const epsOtherValue = form['eps-plan-other'].value.trim();
            if (selectedEpsOption === 'Otra' && !epsOtherValue) {
                return showToast('Debe especificar el nombre de la EPS.', 'error');
            }
            const finalEpsPlan = selectedEpsOption === 'Otra' ? epsOtherValue : selectedEpsOption;
            const selectedCcfOption = form['ccf-plan'].value;
            const ccfOtherValue = form['ccf-plan-other'].value.trim();
            if (selectedCcfOption === 'Otra' && !ccfOtherValue) {
                return showToast('Debe especificar el nombre de la caja de compensación.', 'error');
            }
            const finalCcfPlan = selectedCcfOption === 'Otra' ? ccfOtherValue : selectedCcfOption;
            if (!selectedPlan && !manualOverride && healthPlans.length > 0) {
                return showToast('Debe seleccionar un plan o ingresar costos manuales.', 'error');
            }
            const affiliateData = {
                name: form['affiliate-name'].value.trim(),
                documentId: form['affiliate-id'].value.trim(),
                email: form['affiliate-email'].value.trim(),
                phone: form['affiliate-phone'].value.trim(),
                address: form['affiliate-address'].value.trim(),
                healthPlan: selectedPlan ? selectedPlan.value : null,
                epsPlan: finalEpsPlan,
                pensionPlan: form['pension-plan'].value,
                arlPlan: form['arl-plan'].value,
                ccfPlan: finalCcfPlan,
                advisorId: form['advisor-select-list'].value,
                startDate: form['affiliate-start-date'].value,
                endDate: form['affiliate-end-date'].value,
                status: form['affiliate-status'].value,
                notes: form['affiliate-notes'].value.trim(),
                manualCosts: null,
                manualCommission: null
            };
            if (manualOverride) {
                affiliateData.manualCosts = {
                    health: Number(form['manual-cost-health'].value) || 0,
                    pension: Number(form['manual-cost-pension'].value) || 0,
                    arl: Number(form['manual-cost-arl'].value) || 0,
                    ccf: Number(form['manual-cost-ccf'].value) || 0
                };
                affiliateData.manualCommission = Number(form['manual-commission'].value) || null;
            }
            const existingId = form['affiliate-doc-id'].value;

            if (existingId) {
                affiliateData.id = existingId;
                const oldAffiliate = affiliates.find(a => a.id === existingId);
                if (oldAffiliate && oldAffiliate.status !== affiliateData.status) {
                    createNovedad('status_change', `El estado de ${affiliateData.name} cambió de ${oldAffiliate.status} a ${affiliateData.status}.`);
                }
                await saveDataToFirestore('affiliates', affiliateData);
                modalManager.close('affiliate-modal');
                showToast('Afiliado actualizado correctamente.');

            } else {
                const docRef = doc(collection(db, `users/${adminUidForRole}/affiliates`));
                affiliateData.id = docRef.id;
                affiliateData.createdAt = serverTimestamp();
                affiliateData.commissionPaid = false;
                affiliateData.commissionPaidAt = null;

                if (currentUserRole === 'asesor' && userRoleData.linkedAdvisorId) {
                    affiliateData.advisorId = userRoleData.linkedAdvisorId;
                }

                await saveDataToFirestore('affiliates', affiliateData);
                
                createNovedad('creation', `Nuevo afiliado registrado: ${affiliateData.name}.`);
                
                modalManager.close('affiliate-modal');

                lastCreatedAffiliate = affiliateData;

                setTimeout(() => { 
                    modalManager.open('new-affiliate-success-modal');
                }, 250);
            }
        });

        document.getElementById('advisor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const advisorId = form['advisor-doc-id'].value;

            const advisorData = {
                name: form['advisor-name'].value.trim(),
                commissionRate: Number(form['advisor-commission'].value)
            };

            if (!advisorData.name || isNaN(advisorData.commissionRate)) {
                showToast('Por favor, completa todos los campos correctamente.', 'error');
                return;
            }

            try {
                if (advisorId) {
                    advisorData.id = advisorId;
                    await saveDataToFirestore('advisors', advisorData);
                    showToast('Asesor actualizado con Éxito.', 'success');
                } else {
                    const docRef = doc(collection(db, `users/${adminUidForRole}/advisors`));
                    advisorData.id = docRef.id;
                    await saveDataToFirestore('advisors', advisorData);
                    showToast('Asesor guardado correctamente.', 'success');
                }
                modalManager.close('advisor-modal');
            } catch (error) {
                console.error("Error guardando asesor:", error);
                showToast('Hubo un error al guardar el asesor.', 'error');
            }
        });

        document.getElementById('success-download-pdf-btn').addEventListener('click', () => {
            if (!lastCreatedAffiliate) return;

            const planSeleccionado = healthPlans.find(p => p.id === lastCreatedAffiliate.healthPlan) || {};
            const asesorAsignado = advisors.find(a => a.id === lastCreatedAffiliate.advisorId) || {};
            
            generarReciboAfiliacionPDF(lastCreatedAffiliate, planSeleccionado, asesorAsignado, companyProfile);
        });

        document.getElementById('success-share-btn').addEventListener('click', async () => {
    if (!lastCreatedAffiliate) {
        showToast('No se encontró información del afiliado recién creado.', 'error');
        return;
    }

    // Obtener y formatear el número de teléfono
    const affiliatePhone = lastCreatedAffiliate.phone;
    const whatsappNumber = formatPhoneNumberForWhatsApp(affiliatePhone);

    // Preparar el mensaje
    const affiliateName = lastCreatedAffiliate.name;
    const companyName = companyProfile.name || 'nuestros servicios de salud';
    const shareText = `¡Hola, ${affiliateName}! Tu afiliación en ${companyName} ha sido exitosa. ¡Bienvenido/a!`;
    const encodedText = encodeURIComponent(shareText);

    if (whatsappNumber) {
        // Si tenemos un número de WhatsApp válido, creamos y abrimos el enlace directo
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedText}`;
        window.open(whatsappUrl, '_blank');
    } else {
        // --- FALLBACK (Plan B) ---
        // Si no hay un número válido, usamos la API de compartir genérica como antes.
        showToast('Número no disponible. Usando opción de compartir genérica.', 'error');
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Afiliación Exitosa',
                    text: shareText,
                });
            } catch (error) {
                console.error('Error al intentar compartir:', error);
                showToast('No se pudo completar la acción de compartir.', 'error');
            }
        } else {
            showToast('La función de compartir no está disponible en este navegador.', 'error');
        }
    }
});
        
        document.getElementById('affiliate-modal').addEventListener('change', (e) => {
            if (e.target.id === 'manual-override-checkbox') {
                const manualContainer = document.getElementById('manual-override-container');
                const isChecked = e.target.checked;
                manualContainer.classList.toggle('hidden', !isChecked);
            }
        });
        
        
        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const planId = form['plan-doc-id'].value;

            const planData = {
                name: form['plan-name'].value.trim(),
                price: Number(form['plan-price'].value),
                features: form['plan-features'].value.trim()
            };

            if (!planData.name || !planData.price || !planData.features) {
                showToast('Por favor, completa todos los campos.', 'error');
                return;
            }

            try {
                if (planId) {
                    planData.id = planId;
                    await saveDataToFirestore('healthPlans', planData);
                    showToast('Plan actualizado con Éxito.', 'success');
                } else {
                    const docRef = doc(collection(db, `users/${adminUidForRole}/healthPlans`));
                    planData.id = docRef.id;
                    await saveDataToFirestore('healthPlans', planData);
                    showToast('Plan guardado correctamente.', 'success');
                }
                modalManager.close('plan-modal');
            } catch (error) {
                console.error("Error guardando plan:", error);
                showToast('Hubo un error al guardar el plan.', 'error');
            }
        });
        
        const companyLogoInput = document.getElementById('company-logo');
        const removeCompanyLogoBtn = document.getElementById('remove-company-logo');

        if (companyLogoInput) {
            companyLogoInput.addEventListener('change', async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showToast('Selecciona un archivo de imagen válido.', 'error');
                    event.target.value = '';
                    return;
                }

                try {
                    const { dataUrl } = await compressImageFile(file);
                    const optimizedSize = calculateBase64Size(dataUrl);

                    if (optimizedSize > MAX_COMPANY_LOGO_SIZE) {
                        showToast('El logo optimizado sigue siendo demasiado pesado. Usa una imagen más ligera.', 'error');
                        event.target.value = '';
                        return;
                    }

                    companyProfile.logo = dataUrl;
                    updateCompanyLogoUI(companyProfile.logo);
                    showToast('Logo cargado y optimizado correctamente.', 'success');
                } catch (error) {
                    console.error('Error procesando el logo:', error);
                    showToast('No se pudo procesar el logo. Intenta con otra imagen.', 'error');
                    event.target.value = '';
                }
            });
        }

        if (removeCompanyLogoBtn) {
            removeCompanyLogoBtn.addEventListener('click', () => {
                companyProfile.logo = null;
                updateCompanyLogoUI(null);
                if (companyLogoInput) companyLogoInput.value = '';
            });
        }

        document.getElementById('company-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = e.target.querySelector('button[type="submit"]');
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            try {
                // CÓDIGO CORREGIDO Y MÁS SEGURO
const profileData = {
    name: document.getElementById('company-name').value,
    nit: document.getElementById('company-nit').value,
    address: document.getElementById('company-address').value,
    phone: document.getElementById('company-phone').value,
    email: document.getElementById('company-email').value,

    // Aquí está la corrección:
    // Usamos el operador de encadenamiento opcional (?.) para evitar el error si no hay nada seleccionado.
    // Luego, usamos el operador OR (||) para asignar un valor por defecto ('default' o 'dark').
    theme: document.querySelector('#theme-selector input[name="theme"]:checked')?.value || 'default',
    sidebarTheme: document.querySelector('#sidebar-theme-selector input[name="sidebar-theme"]:checked')?.value || 'dark',
    bottomNavTheme: document.querySelector('#bottom-nav-theme-selector input[name="bottom-nav-theme"]:checked')?.value || 'dark',
    logo: companyProfile.logo || null
};

                /* === INICIO DE LA SOLUCIÓN: GUARDAR TEMA EN NAVEGADOR === */
localStorage.setItem('userTheme', profileData.theme);
/* === FIN DE LA SOLUCIÓN === */

                const userDocRef = doc(db, `users/${adminUidForRole}`);
                
                await setDoc(userDocRef, {
                    companyProfile: profileData
                }, { merge: true });

                companyProfile = { ...companyProfile, ...profileData };
                applyTheme(companyProfile.theme);
                applySidebarTheme(companyProfile.sidebarTheme);
                applyBottomNavTheme(companyProfile.bottomNavTheme);
                updateCompanyLogoUI(companyProfile.logo || null);

                showToast('Perfil de la empresa guardado con Éxito.', 'success');

            } catch (error) {
                console.error("Error al guardar el perfil de la empresa:", error);
                showToast('Error al guardar los cambios. Intenta de nuevo.', 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Cambios';
            }
        });

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const saveButton = form.querySelector('button[type="submit"]');
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            const parseNumber = (field, fallback = 0) => {
                const value = Number(form[field].value);
                return Number.isFinite(value) ? value : fallback;
            };

            const currentRates = settings?.CONTRIBUTION_RATES || defaultSettings.CONTRIBUTION_RATES;
            const currentArlRates = settings?.ARL_RATES || defaultSettings.ARL_RATES;

            const updatedSettings = {
                SMMLV: parseNumber('setting-smmlv', defaultSettings.SMMLV),
                ADMIN_FEE_PER_AFFILIATE: parseNumber('setting-admin-fee', defaultSettings.ADMIN_FEE_PER_AFFILIATE),
                CONTRIBUTION_RATES: {
                    health: parseNumber('setting-health', defaultSettings.CONTRIBUTION_RATES.health),
                    pension: parseNumber('setting-pension', defaultSettings.CONTRIBUTION_RATES.pension),
                    independiente_ccf: parseNumber('setting-ccf-ind', defaultSettings.CONTRIBUTION_RATES.independiente_ccf),
                    employer_ccf: parseNumber('setting-ccf-emp', defaultSettings.CONTRIBUTION_RATES.employer_ccf),
                    employee_health: currentRates.employee_health ?? defaultSettings.CONTRIBUTION_RATES.employee_health,
                    employer_health: currentRates.employer_health ?? defaultSettings.CONTRIBUTION_RATES.employer_health,
                    employee_pension: currentRates.employee_pension ?? defaultSettings.CONTRIBUTION_RATES.employee_pension,
                    employer_pension: currentRates.employer_pension ?? defaultSettings.CONTRIBUTION_RATES.employer_pension
                },
                ARL_RATES: {}
            };

            for (let level = 1; level <= 5; level += 1) {
                updatedSettings.ARL_RATES[level] = parseNumber(`setting-arl-${level}`, currentArlRates[level] ?? defaultSettings.ARL_RATES[level]);
            }

            try {
                const userDocRef = doc(db, `users/${adminUidForRole}`);
                await setDoc(userDocRef, { settings: updatedSettings }, { merge: true });

                settings = {
                    ...settings,
                    ...updatedSettings,
                    CONTRIBUTION_RATES: {
                        ...settings.CONTRIBUTION_RATES,
                        ...updatedSettings.CONTRIBUTION_RATES
                    },
                    ARL_RATES: {
                        ...settings.ARL_RATES,
                        ...updatedSettings.ARL_RATES
                    }
                };

                if (document.getElementById('dashboard').classList.contains('active')) {
                    renderDashboard();
                }
                if (currentUserRole === 'admin' && document.getElementById('flujo-caja').classList.contains('active')) {
                    renderFlujoCajaSection();
                }

                const calculatorForm = document.getElementById('calculator-form');
                if (calculatorForm) {
                    const incomeValue = Number(calculatorForm['income'].value);
                    const contractType = calculatorForm['contract-type'].value;
                    const arlLevel = calculatorForm['arl-level'].value;
                    const selections = {
                        health: calculatorForm.querySelector('[value="health"]').checked,
                        pension: calculatorForm.querySelector('[value="pension"]').checked,
                        arl: calculatorForm.querySelector('[value="arl"]').checked,
                        ccf: calculatorForm.querySelector('[value="ccf"]').checked
                    };
                    if (incomeValue > 0) {
                        const recalculated = calculateContributions(incomeValue, contractType, arlLevel, selections);
                        if (recalculated) {
                            lastQuoteResult = recalculated;
                            renderCalculatorResults(recalculated);
                        }
                    }
                }

                showToast('Configuración guardada con éxito.');
                modalManager.close('settings-modal');
            } catch (error) {
                console.error('Error al guardar la configuración:', error);
                showToast('No se pudo guardar la configuración.', 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Cambios';
            }
        });

        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const saveButton = e.target.querySelector('button[type="submit"]');
            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            try {
                const form = e.target;
                const transactionType = form['transaction-type'].value; 

                const transactionData = {
                    concept: form['transaction-concept'].value.trim(),
                    amount: Number(form['transaction-amount'].value),
                    date: form['transaction-date'].value,
                    type: transactionType,
                };

                transactionData.date = normalizeDateInput(transactionData.date) || transactionData.date;

                if (!transactionData.concept || transactionData.amount <= 0 || !transactionData.date) {
                    showToast('Por favor, completa todos los campos correctamente.', 'error');
                    saveButton.disabled = false;
                    saveButton.textContent = 'Guardar';
                    return; 
                }

                const docRef = doc(collection(db, `users/${adminUidForRole}/manualTransactions`));
                transactionData.id = docRef.id;

                await saveDataToFirestore('manualTransactions', transactionData);

                showToast(`El ${transactionType} se guardo; correctamente.`, 'success');
                modalManager.close('transaction-modal');

            } catch (error) {
                console.error("Error al guardar la transacción:", error);
                showToast('Hubo un error al guardar la transacción.', 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar';
            }
        });

// =========================================================================
// INICIO DE LA SOLUCIÓN DEFINITIVA
// =========================================================================
        const setupThemePreview = (selectorId, applyFunction) => {
            const selectorContainer = document.getElementById(selectorId);
            if (selectorContainer) {
                selectorContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'radio' && e.target.name) {
                        const selectedValue = e.target.value;
                        
                        const mainContent = document.querySelector('main');
                        if (!mainContent) return;

                        const scrollPosition = mainContent.scrollTop;

                        applyFunction(selectedValue);

                        // ¡AQUÍ ESTÁ EL CAMBIO CLAVE!
                        // Usamos requestAnimationFrame para asegurar que la restauración
                        // ocurra JUSTO después de que el navegador haya procesado los cambios de estilo.
                        requestAnimationFrame(() => {
                            mainContent.scrollTop = scrollPosition;
                        });
                    }
                });
            }
        };
// =========================================================================
// FIN DE LA SOLUCIÓN DEFINITIVA
// =========================================================================
        setupThemePreview('theme-selector', applyTheme);
        setupThemePreview('sidebar-theme-selector', applySidebarTheme);
        setupThemePreview('bottom-nav-theme-selector', applyBottomNavTheme);

        document.getElementById('mark-novedades-read').addEventListener('click', async () => {
            const unreadNovedades = novedades.filter(n => n.read === false);
            if (unreadNovedades.length === 0) return;

            const batch = writeBatch(db);
            unreadNovedades.forEach(novedad => {
                const docRef = doc(db, `users/${adminUidForRole}/novedades`, novedad.id);
                batch.update(docRef, { read: true });
            });

            await batch.commit();
            showToast('Notificaciones marcadas como leídas.');
        });

        document.getElementById('clear-all-novedades').addEventListener('click', async () => {
    // 1. Verificamos si hay notificaciones para borrar.
    if (novedades.length === 0) {
        showToast('No hay notificaciones para borrar.', 'error');
        return;
    }

    // 2. Pedimos confirmación al usuario porque es una acción irreversible.
    if (!confirm('¿Estás seguro de que quieres borrar TODAS las notificaciones? Esta acción no se puede deshacer.')) {
        return;
    }

    // 3. Creamos un "batch write" para borrar todos los documentos en una sola operación.
    const batch = writeBatch(db);
    novedades.forEach(novedad => {
        const docRef = doc(db, `users/${adminUidForRole}/novedades`, novedad.id);
        batch.delete(docRef); // Usamos batch.delete() para eliminar el documento.
    });

    try {
        // 4. Ejecutamos el borrado en la base de datos.
        await batch.commit();
        showToast('Todas las notificaciones han sido borradas.', 'success');
        
        // 5. Opcional: Cerramos el modal después de borrar.
        document.getElementById('novedades-modal').classList.add('scale-95', 'opacity-0', 'pointer-events-none');

    } catch (error) {
        console.error("Error al borrar las notificaciones:", error);
        showToast('Ocurrió un error al borrar las notificaciones.', 'error');
    }
});
        
      const calculatorForm = document.getElementById('calculator-form');
        const calculateBtn = document.getElementById('calculate-btn');
        const newQuoteBtn = document.getElementById('new-quote-btn');

        calculatorForm.addEventListener('submit', e => {
            e.preventDefault();
            
            calculateBtn.disabled = true;
            calculateBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>Calculando...';
            lucide.createIcons();
            
            setTimeout(() => {
                const form = e.target;
                const selections = {
                    health: form.querySelector('[value="health"]').checked,
                    pension: form.querySelector('[value="pension"]').checked,
                    arl: form.querySelector('[value="arl"]').checked,
                    ccf: form.querySelector('[value="ccf"]').checked
                };
                const results = calculateContributions(Number(form['income'].value), form['contract-type'].value, form['arl-level'].value, selections);
                lastQuoteResult = results;
                renderCalculatorResults(results);
                calculateBtn.style.display = 'none';
                newQuoteBtn.style.display = 'flex';
                document.querySelectorAll('#calculator-fieldset-1, #calculator-fieldset-2').forEach(fs => fs.disabled = true);
            }, 300);
        });

        newQuoteBtn.addEventListener('click', () => {
            resetCalculatorState();
        });

        document.getElementById('select-all-components').addEventListener('change', e => {
            document.querySelectorAll('.component-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });
    });
    

    async function generarReciboAfiliacionPDF(affiliateData, planData, advisorData, companyProfileData) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const primaryColorRGB = getComputedStyle(document.documentElement).getPropertyValue('--color-primary-600').trim().split(' ').map(Number);
    const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';

    const logoDataUrl = companyProfileData.logo || companyProfile.logo || null;
    let textStartX = 14;
    let headerPrimaryY = 26;
    let headerBottomY = 32;

    if (logoDataUrl) {
        const placement = await addLogoToPDF(doc, logoDataUrl, { x: 14, y: 12, maxWidthMm: 52, maxHeightMm: 26 });
        if (placement) {
            textStartX = placement.x + placement.width + 8;
            headerPrimaryY = Math.max(22, placement.y + 6);
            headerBottomY = Math.max(headerBottomY, placement.y + placement.height);
        }
    }

    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColorRGB[0], primaryColorRGB[1], primaryColorRGB[2]);
    doc.text(companyProfileData.name || "Seb Salud", textStartX, headerPrimaryY);

    const rightBlockBaseY = headerPrimaryY;
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(100);
    doc.text(`NIT: ${companyProfileData.nit || 'N/D'}`, 196, rightBlockBaseY, { align: 'right' });
    doc.text(companyProfileData.address || '', 196, rightBlockBaseY + 5, { align: 'right' });
    doc.text(`Tel: ${companyProfileData.phone || 'N/D'}`, 196, rightBlockBaseY + 10, { align: 'right' });

    const titleY = Math.max(headerBottomY + 14, rightBlockBaseY + 20);

    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(40);
    doc.text("Comprobante de Afiliación", 14, titleY);

    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text(`Recibo N°: ${affiliateData.id.slice(-7).toUpperCase()}`, 196, titleY, { align: 'right' });

    doc.setLineWidth(0.5);
    doc.setDrawColor(primaryColorRGB[0], primaryColorRGB[1], primaryColorRGB[2]);
    doc.line(14, titleY + 4, 196, titleY + 4);

    const affiliateTableStartY = titleY + 9;

    doc.autoTable({
        startY: affiliateTableStartY,
        theme: 'grid',
        head: [['Datos del Afiliado', 'Información Registrada']],
        body: [
            ['Nombre Completo', affiliateData.name],
            ['Documento de Identidad', affiliateData.documentId],
            ['Correo Electrónico', affiliateData.email || 'No registrado'],
            ['Teléfono de Contacto', affiliateData.phone || 'No registrado'],
            ['Dirección de Residencia', affiliateData.address || 'No registrada']
        ],
        headStyles: { fillColor: primaryColorRGB, fontStyle: 'bold', textColor: [255, 255, 255] },
        styles: { fontSize: 10, cellPadding: 2.5 },
        columnStyles: { 0: { fontStyle: 'bold' } }
    });

    let finalY = doc.lastAutoTable.finalY + 8;

    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(40);
    doc.text("Resumen de Servicio y Costos", 14, finalY);

    const hasManualCosts = affiliateData.manualCosts && Object.values(affiliateData.manualCosts).some(cost => cost > 0);
    let serviceBody = [];
    let serviceTotal = 0;

    if (hasManualCosts) {
        const costLabels = { health: 'Aporte Salud (EPS)', pension: 'Aporte Pensión', arl: 'Aporte ARL', ccf: 'Aporte Caja de Compensación' };
        for (const [key, value] of Object.entries(affiliateData.manualCosts)) {
            if (value > 0) {
                serviceBody.push([costLabels[key], formatCurrency(value)]);
                serviceTotal += value;
            }
        }
    } else {
        serviceBody.push([`Plan de Salud: ${planData.name || 'N/A'}`, formatCurrency(planData.price || 0)]);
        serviceTotal = planData.price || 0;
    }

    doc.autoTable({
        startY: finalY + 3,
        theme: 'striped',
        head: [['Concepto de Pago Mensual', 'Valor']],
        body: serviceBody,
        foot: [['TOTAL MENSUAL A PAGAR', formatCurrency(serviceTotal)]],
        headStyles: { fillColor: [67, 56, 202], fontStyle: 'bold', textColor: [255, 255, 255] },
        footStyles: { fillColor: [67, 56, 202], fontStyle: 'bold', textColor: [255, 255, 255], fontSize: 11 },
        styles: { fontSize: 10, cellPadding: 2.5 },
        columnStyles: { 1: { halign: 'right' } }
    });

    finalY = doc.lastAutoTable.finalY;

    const adminDetails = [
        ['Asesor Asignado:', advisorData.name || 'No asignado'],
        ['Fecha de Inicio de Cobertura:', formatDate(affiliateData.startDate)],
        ['Próximo Pago / Vencimiento:', affiliateData.endDate ? formatDate(affiliateData.endDate) : 'Indefinido'],
        ['Estado Actual:', affiliateData.status]
    ];

    doc.autoTable({
        startY: finalY + 8,
        theme: 'grid',
        head: [['Detalles Administrativos', '']],
        body: adminDetails,
        headStyles: { fillColor: [241, 245, 249], textColor: [51, 65, 85], fontStyle: 'bold', halign: 'center' },
        styles: { fontSize: 9, cellPadding: 2 },
        columnStyles: { 0: { fontStyle: 'bold' } }
    });

    finalY = doc.internal.pageSize.height - 30;
    doc.setLineWidth(0.2);
    doc.setDrawColor(180);
    doc.line(14, finalY, 196, finalY);
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text("Gracias por confiar en nuestros servicios. Este documento es un comprobante de su afiliación y no representa una factura.", doc.internal.pageSize.width / 2, finalY + 8, { align: 'center' });
    doc.text(`Generado el ${new Date().toLocaleString('es-CO')} por ${companyProfileData.name}.`, doc.internal.pageSize.width / 2, finalY + 12, { align: 'center' });

    doc.save(`Comprobante_Afiliacion_${affiliateData.name.replace(/\s/g, '_')}.pdf`);
}

    const modalManager = {
        open(modalId, data = null) {
            const modal = document.getElementById(modalId); if (!modal) return;
            const form = modal.querySelector('form');
            if(form) {
                form.reset();
                updateEpsOtherFieldVisibility?.();
                updateCcfOtherFieldVisibility?.();
            }
            const titles = { 'affiliate-modal': 'Afiliado', 'advisor-modal': 'Asesor', 'settings-modal': 'Configuración', 'plan-modal': 'Plan de Salud', 'transaction-modal': 'Transacción', 'license-modal': 'Activar Licencia' };
            const titleText = titles[modalId];
            if (titleText) {
                modal.querySelector('h2').textContent = data?.id ? `Editar ${titleText}` : (data?.title || `Nuevo ${titleText}`);
            }
            if (modalId === 'license-modal') { document.getElementById('license-error-message').textContent = ''; }
            else if (modalId === 'affiliate-modal') {
                populateAdvisorSelect(); renderHealthPlanCards();
                const advisorSelect = form['advisor-select-list'];
                if (currentUserRole === 'asesor' && userRoleData.linkedAdvisorId) {
                    advisorSelect.value = userRoleData.linkedAdvisorId;
                    advisorSelect.disabled = true;
                } else {
                    advisorSelect.disabled = false;
                    advisorSelect.value = data?.advisorId || '';
                }
                
                form['affiliate-doc-id'].value = data?.id || '';
                form['affiliate-name'].value = data?.name || '';
                form['affiliate-id'].value = data?.documentId || '';
                form['affiliate-email'].value = data?.email || '';
                form['affiliate-phone'].value = data?.phone || '';
                form['affiliate-address'].value = data?.address || '';
                const epsSelect = form['eps-plan'];
                const epsOtherInput = form['eps-plan-other'];
                if (epsSelect && epsOtherInput) {
                    const epsOptions = Array.from(epsSelect.options || []).map(opt => opt.value);
                    const epsValue = data?.epsPlan || '';
                    if (epsValue && epsOptions.includes(epsValue)) {
                        epsSelect.value = epsValue;
                        epsOtherInput.value = '';
                    } else if (epsValue) {
                        epsSelect.value = 'Otra';
                        epsOtherInput.value = epsValue;
                    } else {
                        epsSelect.value = '';
                        epsOtherInput.value = '';
                    }
                    updateEpsOtherFieldVisibility?.();
                    if (epsSelect.value === 'Otra' && epsOtherInput.value) {
                        epsOtherInput.required = true;
                    }
                }
                if(data?.healthPlan) { const planInput = form.querySelector(`input[name="health-plan"][value="${data.healthPlan}"]`); if (planInput) planInput.checked = true; }
                form['pension-plan'].value = data?.pensionPlan || '';
                form['arl-plan'].value = data?.arlPlan || '';
                const ccfSelect = form['ccf-plan'];
                const ccfOtherInput = form['ccf-plan-other'];
                if (ccfSelect && ccfOtherInput) {
                    const ccfOptions = Array.from(ccfSelect.options || []).map(opt => opt.value);
                    let ccfValue = data?.ccfPlan || '';
                    if (ccfValue === 'Otra / Ninguna') {
                        ccfValue = 'Ninguna';
                    }
                    if (ccfValue && ccfOptions.includes(ccfValue)) {
                        ccfSelect.value = ccfValue;
                        ccfOtherInput.value = '';
                    } else if (ccfValue) {
                        ccfSelect.value = 'Otra';
                        ccfOtherInput.value = ccfValue;
                    } else {
                        ccfSelect.value = '';
                        ccfOtherInput.value = '';
                    }
                    updateCcfOtherFieldVisibility?.();
                    if (ccfSelect.value === 'Otra' && ccfOtherInput.value) {
                        ccfOtherInput.required = true;
                    }
                }
                form['affiliate-start-date'].value = data?.startDate || new Date().toISOString().split('T')[0];
                form['affiliate-end-date'].value = data?.endDate || '';
                form['affiliate-status'].value = data?.status || 'Pendiente';
                form['affiliate-notes'].value = data?.notes || '';
const manualContainer = form.querySelector('#manual-override-container'); form['manual-override-checkbox'].checked = !!(data?.manualCosts || data?.manualCommission); manualContainer.classList.toggle('hidden', !form['manual-override-checkbox'].checked); form['manual-cost-health'].value = data?.manualCosts?.health || ''; form['manual-cost-pension'].value = data?.manualCosts?.pension || ''; form['manual-cost-arl'].value = data?.manualCosts?.arl || ''; form['manual-cost-ccf'].value = data?.manualCosts?.ccf || ''; form['manual-commission'].value = data?.manualCommission || '';
            } else if (modalId === 'advisor-modal') { form['advisor-doc-id'].value = data?.id || ''; form['advisor-name'].value = data?.name || ''; form['advisor-commission'].value = data?.commissionRate || ''; } 
            else if (modalId === 'plan-modal') { form['plan-doc-id'].value = data?.id || ''; form['plan-name'].value = data?.name || ''; form['plan-price'].value = data?.price || ''; form['plan-features'].value = data?.features || ''; } 
            else if (modalId === 'settings-modal') { 
                const s = settings || {};
                const ds = defaultSettings;
                form['setting-smmlv'].value = s.SMMLV ?? ds.SMMLV; 
                form['setting-admin-fee'].value = s.ADMIN_FEE_PER_AFFILIATE ?? ds.ADMIN_FEE_PER_AFFILIATE;
                form['setting-health'].value = s.CONTRIBUTION_RATES?.health ?? ds.CONTRIBUTION_RATES.health;
                form['setting-pension'].value = s.CONTRIBUTION_RATES?.pension ?? ds.CONTRIBUTION_RATES.pension;
                form['setting-ccf-ind'].value = s.CONTRIBUTION_RATES?.independiente_ccf ?? ds.CONTRIBUTION_RATES.independiente_ccf;
                form['setting-ccf-emp'].value = s.CONTRIBUTION_RATES?.employer_ccf ?? ds.CONTRIBUTION_RATES.employer_ccf;
                for (let i = 1; i <= 5; i++) { 
                    form[`setting-arl-${i}`].value = s.ARL_RATES?.[i] ?? ds.ARL_RATES[i]; 
                } 
            } 
            else if (modalId === 'transaction-modal') { document.getElementById('transaction-type').value = data.type; document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0]; }
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            lucide.createIcons();
        },
        close(modalId) { const modal = document.getElementById(modalId); if (!modal) return; modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => modal.classList.add('pointer-events-none'), 250); }
    };
    
    function showToast(message, type = 'success') { const toast = document.getElementById('toast'); if (!toast) return; toast.textContent = message; toast.className = `fixed top-5 right-5 z-[100] text-white py-2 px-4 rounded-lg shadow-xl transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; toast.classList.remove('opacity-0', 'translate-y-2'); setTimeout(() => toast.classList.add('opacity-0', 'translate-y-2'), 3000); }
    function formatCurrency(value, minimumFractionDigits = 0) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits }).format(value || 0); }

function formatDateShort(value) {
        const parsed = parseAppDate(value);
        if (!parsed) return '';
        return parsed.toLocaleDateString('es-CO');
    }

    function formatPercentage(value, fractionDigits = 1) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return '0%';
        return `${numeric.toFixed(fractionDigits)}%`;
    }
    function exportToCSV(headers, data, filename) { const csvRows = [headers.join(',')]; for (const row of data) { const values = headers.map(header => `"${('' + row[header]).replace(/"/g, '\\"')}"`); csvRows.push(values.join(',')); } const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); window.URL.revokeObjectURL(url); }
    function handleExportAffiliates() { const headers = ['Nombre', 'Documento', 'Email', 'Telefono', 'Direccion', 'Asesor', 'Estado', 'Fecha de Inicio', 'Plan de Salud', 'EPS', 'Fondo Pension', 'ARL', 'Caja Comp.']; const dataToExport = affiliates.map(aff => { const advisor = advisors.find(v => v.id === aff.advisorId); const plan = healthPlans.find(p=> p.id === aff.healthPlan); return { 'Nombre': aff.name, 'Documento': aff.documentId, 'Email': aff.email, 'Telefono': aff.phone, 'Direccion': aff.address, 'Asesor': advisor ? advisor.name : 'N/A', 'Estado': aff.status, 'Fecha de Inicio': aff.startDate, 'Plan de Salud': plan ? plan.name : 'N/A', 'EPS': aff.epsPlan || 'N/A', 'Fondo Pension': aff.pensionPlan, 'ARL': aff.arlPlan, 'Caja Comp.': aff.ccfPlan }; }); exportToCSV(headers, dataToExport, 'afiliados_seb_salud.csv'); showToast('Exportando afiliados a CSV.'); }
    function handleExportAdvisors() { const headers = ['Nombre', 'Comision (%)', 'Total Afiliados', 'Comision Total Generada']; const dataToExport = advisors.map(advisor => { const advisorAffiliates = affiliates.filter(a => a.advisorId === advisor.id); const totalCommission = advisorAffiliates.reduce((sum, aff) => sum + getAdvisorCommissionForAffiliate(aff), 0); return { 'Nombre': advisor.name, 'Comision (%)': advisor.commissionRate, 'Total Afiliados': advisorAffiliates.length, 'Comision Total Generada': totalCommission }; }); exportToCSV(headers, dataToExport, 'asesores_seb_salud.csv'); showToast('Exportando asesores a CSV.'); }
    function getFirebaseAuthErrorMessage(error) { switch (error.code) { case 'auth/invalid-email': return 'El correo es inválido.'; case 'auth/user-not-found': return 'Usuario no encontrado.'; case 'auth/wrong-password': return 'Contraseña incorrecta.'; case 'auth/email-already-in-use': return 'El correo ya está en uso.'; case 'auth/weak-password': return 'La contraseña es muy débil (mínimo 6 caracteres).'; default: 'Ocurrió un error inesperado. Intenta de nuevo.'; } }
</script>
<script>
  // SCRIPT DEL SERVICE WORKER CON RUTA CORREGIDA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js') // RUTA CORREGIDA
        .then(registration => {
          console.log('Service Worker registrado con Éxito:', registration.scope);
        })
        .catch(error => {
          console.log('Error al registrar el Service Worker:', error);
        });
    });
  }
</script>
</body>
</html>

